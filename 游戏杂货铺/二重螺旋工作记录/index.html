

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/cute.jpg">
  <link rel="icon" href="/img/cute.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="R">
  <meta name="keywords" content="">
  
    <meta name="description" content="在二重螺旋学到了很多，杂乱无章的记录一下都干了什么">
<meta property="og:type" content="article">
<meta property="og:title" content="二重螺旋工作记录">
<meta property="og:url" content="https://rorschachandbat.github.io/%E6%B8%B8%E6%88%8F%E6%9D%82%E8%B4%A7%E9%93%BA/%E4%BA%8C%E9%87%8D%E8%9E%BA%E6%97%8B%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="R">
<meta property="og:description" content="在二重螺旋学到了很多，杂乱无章的记录一下都干了什么">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250222140734093.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250308150623903.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250314143210622.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250314143159646.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250314143145703.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250407161507215.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250407161955049.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250408204849600.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250408204956644.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250307145412350.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250317103119345.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250331162722001.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250414215853197.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250520144907705.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250521144140603.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250521144144132.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250521210021655.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250521210052596.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250521210057095.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250523111435520.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250605143412009.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250606141557474.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/asynccode">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/asynccode">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250807145225040.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250901171948021.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250904163401533.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250930170113903.png">
<meta property="og:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250930170121038.png">
<meta property="article:published_time" content="2025-11-02T16:00:00.000Z">
<meta property="article:modified_time" content="2025-11-03T15:22:26.005Z">
<meta property="article:author" content="R">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250222140734093.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>二重螺旋工作记录 - R</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"rorschachandbat.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
 <meta name="referrer" content="no-referrer" />
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="R" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>R君的秘密基地</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-douban-fill"></i>
                <span>书影音</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/books/">
                    
                    <span>读过</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/movies/">
                    
                    <span>看过</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/games/">
                    
                    <span>玩过</span>
                  </a>
                
              </div>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/gdc/">
                <i class="iconfont icon-xbox-fill"></i>
                <span>gdc</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-xbox-fill"></i>
                <span>桌游生成器</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/boardgame/guess/">
                    
                    <span>猜来猜趣</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/boardgame/bluff/">
                    
                    <span>瞎掰王</span>
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/elder%20ring.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="二重螺旋工作记录"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-11-03 00:00" pubdate>
          2025年11月3日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          107k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          891 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">二重螺旋工作记录</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2025年11月3日 晚上
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="大秘境杀怪时间进度条"><a href="#大秘境杀怪时间进度条" class="headerlink" title="大秘境杀怪时间进度条"></a>大秘境杀怪时间进度条</h1><h2 id="svn提交"><a href="#svn提交" class="headerlink" title="svn提交"></a>svn提交</h2><p>【【大秘境】倒计时+杀怪进度UI—客户端】<br><a target="_blank" rel="noopener" href="https://www.tapd.cn/31626021/prong/stories/view/1131626021001235215">https://www.tapd.cn/31626021/prong/stories/view/1131626021001235215</a></p>
<h2 id="测试命令"><a href="#测试命令" class="headerlink" title="测试命令"></a>测试命令</h2><p>输入 gm completecondition 4220 解锁大秘境</p>
<p>gm EnterAbyss 2011011 10</p>
<p>直接进入大秘境，因为现在页面大秘境有点bug(好像又没了)</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>之前有两个条，现在要把两个变成一个</p>
<p><strong>杀怪进度条</strong></p>
<p>Abyss_BattleProgress</p>
<p>AbysssComponent.lua，这个在这里面打开和关闭</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">AbyssComponent:SetAbyssBattlePanelVisibility</span><span class="hljs-params">(IsShow)</span></span><br>	<span class="hljs-keyword">local</span> AbyssBattleUI = UIManager(<span class="hljs-built_in">self</span>):GetUIObj(<span class="hljs-string">&quot;Abyss_BattleProgress&quot;</span>)<br>	<span class="hljs-keyword">if</span> AbyssBattleUI <span class="hljs-keyword">then</span><br>		AbyssBattleUI:SetAbyssBattleVisibility(IsShow)<br>	<span class="hljs-keyword">else</span><br>		DebugPrint(<span class="hljs-string">&quot;AbyssComponent:SetAbyssBattlePanelVisibility找不到AbyssBattleUI&quot;</span>, IsShow)<br>		Traceback()<br>	<span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<p><strong>倒计时</strong></p>
<p>Abyss_CountDown</p>
<p>GameStateInterface.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-----------------------大秘境相关-----------------------------</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Component:AbyssBattle_Lua</span><span class="hljs-params">()</span></span><br>    DebugPrint(<span class="hljs-string">&quot;AbyssBattle_Lua&quot;</span>)<br>    <span class="hljs-keyword">local</span> AbyssCountDownUI = UIManager(<span class="hljs-built_in">self</span>):GetUIObj(<span class="hljs-string">&quot;Abyss_CountDown_Progress&quot;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> AbyssCountDownUI <span class="hljs-keyword">then</span><br>        AbyssCountDownUI = UIManager(<span class="hljs-built_in">self</span>):LoadUINew(<span class="hljs-string">&quot;Abyss_CountDown_Progress&quot;</span>)<br>    <span class="hljs-keyword">end</span><br>    AbyssCountDownUI:ShowAbyssCountDown(<span class="hljs-string">&quot;AbyssBattle&quot;</span>)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Component:RemoveAbyssBattle_Lua</span><span class="hljs-params">()</span></span><br>    DebugPrint(<span class="hljs-string">&quot;RemoveAbyssBattle_Lua&quot;</span>)<br>    <span class="hljs-keyword">local</span> AbyssCountDownUI = UIManager(<span class="hljs-built_in">self</span>):GetUIObj(<span class="hljs-string">&quot;Abyss_CountDown_Progress&quot;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> AbyssCountDownUI <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">end</span><br>    AbyssCountDownUI:HideAbyssCountDown(<span class="hljs-string">&quot;AbyssBattle&quot;</span>)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Component:AbyssNextRoom_Lua</span><span class="hljs-params">()</span></span><br>    DebugPrint(<span class="hljs-string">&quot;AbyssNextRoom_Lua&quot;</span>)<br>    <span class="hljs-keyword">local</span> AbyssCountDownUI = UIManager(<span class="hljs-built_in">self</span>):GetUIObj(<span class="hljs-string">&quot;Abyss_CountDown_Progress&quot;</span>)<br>    <span class="hljs-keyword">if</span> AbyssCountDownUI <span class="hljs-keyword">then</span><br>        AbyssCountDownUI = UIManager(<span class="hljs-built_in">self</span>):LoadUINew(<span class="hljs-string">&quot;Abyss_CountDown_Progress&quot;</span>)<br>    <span class="hljs-keyword">end</span><br>    AbyssCountDownUI:ShowAbyssCountDown(<span class="hljs-string">&quot;AbyssNextRoom&quot;</span>)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Component:RemoveAbyssNextRoom_Lua</span><span class="hljs-params">()</span></span><br>    DebugPrint(<span class="hljs-string">&quot;RemoveAbyssNextRoom_Lua&quot;</span>)<br>    <span class="hljs-keyword">local</span> AbyssCountDownUI = UIManager(<span class="hljs-built_in">self</span>):GetUIObj(<span class="hljs-string">&quot;Abyss_CountDown_Progress&quot;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> AbyssCountDownUI <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">end</span><br>    AbyssCountDownUI:HideAbyssCountDown(<span class="hljs-string">&quot;AbyssNextRoom&quot;</span>)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这些入口要改一下</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>活动界面有问题，我注释了一下排序就能打开了。</p>
<p>现在进入大秘境直接崩溃，不知道为啥</p>
<p>19:28</p>
<p>223163</p>
<p>222844</p>
<h3 id="Destruct"><a href="#Destruct" class="headerlink" title="Destruct()"></a>Destruct()</h3><p>这个玩意还要调一下父类的Destruct()，类似这样</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">self</span>.Super.Destruct(<span class="hljs-built_in">self</span>)<br></code></pre></td></tr></table></figure>



<h3 id="LoadUI的问题"><a href="#LoadUI的问题" class="headerlink" title="LoadUI的问题"></a>LoadUI的问题</h3><p> LoadUI,parameter : 0, error msg : class UIState needed but got WBP_Abyss_Progress_C</p>
<p>要在蓝图的Graph的Class Setting里面，把class options的父类型变成UIState</p>
<h1 id="大秘境ESC界面"><a href="#大秘境ESC界面" class="headerlink" title="大秘境ESC界面"></a>大秘境ESC界面</h1><h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><h3 id="弹窗"><a href="#弹窗" class="headerlink" title="弹窗"></a>弹窗</h3><p><strong>调用接口</strong></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">BP_UIManagerComponent_C:</span>ShowCommonPopupUI(PopupId, Params, ParentWidget)<br></code></pre></td></tr></table></figure>

<p>PopupId：通用弹窗表 的 ID</p>
<p>Params： 程序需要给进去的额外参数，可以覆盖表中的内容、填充数据、绑定回调等</p>
<p>ParentWidget： 关闭弹窗后，会重新Focus到ParentWidget上</p>
<p><strong>可以配置的参数</strong></p>
<p>可以看WPB_Common_Dialog_PC_C.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">---@class Common_Dialog_Params_FundInfo</span><br><span class="hljs-comment">---@field FundId number @货币ID</span><br><span class="hljs-comment">---@field FundNeed number @需要的数量</span><br><br><span class="hljs-comment">---@class Common_Dialog_Params_ItemInfo </span><br><span class="hljs-comment">---@field ItemId number @物品ID</span><br><span class="hljs-comment">---@field ItemType string @物品类型[&quot;Weapon&quot; | &quot;Mod&quot; | &quot;Resource&quot;]</span><br><span class="hljs-comment">---@field ItemNum number @(可选)物品数量</span><br><span class="hljs-comment">---@field ItemNeed number @(可选)需要的物品数量</span><br><span class="hljs-comment">---@field ItemUuid number @(可选)物品的UuId</span><br><br><span class="hljs-comment">---@class Common_Dialog_Text03_ListViewContent </span><br><span class="hljs-comment">---@field Title string @标题</span><br><span class="hljs-comment">---@field Text string @文本内容</span><br><br><span class="hljs-comment">---@class Common_Dialog_Params_PageFlipInfo </span><br><span class="hljs-comment">---@field PageNumber number @页签总页数</span><br><span class="hljs-comment">---@field CurrentPage number @当前页签</span><br><br><span class="hljs-comment">---@class Common_Dialog_Params </span><br><span class="hljs-comment">---@field IsHideBg bool @(可选)显隐Bg_Switch,true隐藏，false显示</span><br><span class="hljs-comment">---@field Title string @(可选)弹窗标题，覆盖表中内容</span><br><span class="hljs-comment">---@field ShortText string @(可选)短文本内容，覆盖表中内容</span><br><span class="hljs-comment">---@field LongText string @(可选)长文本内容，覆盖表中内容</span><br><span class="hljs-comment">---@field HintText string @(可选)选择框文本内容，覆盖表中内容</span><br><span class="hljs-comment">---@field Text03_ListView Common_Dialog_Text03_ListViewContent[] @(可选) 带分割线的文本列表内容</span><br><span class="hljs-comment">---@field Tips string[] @(可选)Tip内容数组，覆盖表中内容</span><br><span class="hljs-comment">---@field HideItemTips bool @(可选) 初始化时是否隐藏Tip</span><br><span class="hljs-comment">---@field ItemList Common_Dialog_Params_ItemInfo[] @(可选)通用物品栏信息</span><br><span class="hljs-comment">---@field Funds Common_Dialog_Params_FundInfo[] @(可选)货币信息列表</span><br><span class="hljs-comment">---@field DynamicNodes table @(可选)动态挂接Widget列表，里面传组件实例</span><br><span class="hljs-comment">---@field ForbidLeftBtn bool @(可选) 设置左侧按钮禁用态</span><br><span class="hljs-comment">---@field ForbidRightBtn bool @(可选) 设置右侧按钮禁用态</span><br><span class="hljs-comment">---@field PageFlipInfo Common_Dialog_Params_PageFlipInfo @(可选) 如果为页签模式，页签的页数</span><br><span class="hljs-comment">---@field ForbiddenLeftCallbackObj table @(可选)左侧按钮禁用态点击回调的接收对象</span><br><span class="hljs-comment">---@field ForbiddenLeftCallbackFunction function @(可选)左侧按钮禁用态点击的回调</span><br><span class="hljs-comment">---@field ForbiddenRightCallbackObj table @(可选)右侧按钮禁用态点击回调的接收对象</span><br><span class="hljs-comment">---@field ForbiddenRightCallbackFunction function @(可选)右侧按钮禁用态点击的回调</span><br><span class="hljs-comment">---@field LeftCallbackObj table @(可选)左侧按钮回调的接收对象</span><br><span class="hljs-comment">---@field LeftCallbackFunction function @(可选)左侧按钮的回调</span><br><span class="hljs-comment">---@field RightCallbackObj table @(可选)右侧按钮回调的接收对象</span><br><span class="hljs-comment">---@field RightCallbackFunction function @(可选)右侧按钮的回调</span><br><span class="hljs-comment">---@field CloseBtnCallbackObj table @(可选)右上角关闭按钮回调的接收对象</span><br><span class="hljs-comment">---@field CloseBtnCallbackFunction function @(可选)右上角关闭按钮回调</span><br><span class="hljs-comment">---@field DontCloseWhenLeftBtnClicked bool @(可选)左侧按钮点击时不关闭弹窗</span><br><span class="hljs-comment">---@field DontCloseWhenRightBtnClicked bool @(可选)右侧按钮点击时不关闭弹窗</span><br><span class="hljs-comment">---@field OnKeyDownCallbackObj table @(可选)弹窗内按键回调的接收对象</span><br><span class="hljs-comment">---@field OnKeyDownCallbackFunction function @(可选)弹窗内按键时的回调</span><br><span class="hljs-comment">---@field DontPlayOutAnimation bool @(可选)关闭时不播放Out动画</span><br><span class="hljs-comment">---@field DontFocusParentWidget bool @(可选)关闭时不聚焦ParentWidget</span><br><span class="hljs-comment">---@field ShowParentTabCoin bool @(可选)显示父级Tab右上角的货币信息</span><br></code></pre></td></tr></table></figure>

<h3 id="弹窗的Tab怎么写"><a href="#弹窗的Tab怎么写" class="headerlink" title="弹窗的Tab怎么写"></a>弹窗的Tab怎么写</h3><p>self:BindDialogEvent(DialogEvent.OnTitleTabSelected, self.OnTabSelected)</p>
<p>这样绑一下然后写逻辑</p>
<h2 id="如何显示大秘境信息？"><a href="#如何显示大秘境信息？" class="headerlink" title="如何显示大秘境信息？"></a>如何显示大秘境信息？</h2><p>好像都放在Abyss.lua里面</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">Avatar.Abysses[AbyssId]<br></code></pre></td></tr></table></figure>

<p>如何拿AbyssId？</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BP_AbyssComponent_C:InitAbyssComponent</span><span class="hljs-params">()</span></span><br>    <span class="hljs-built_in">self</span>.GameMode = <span class="hljs-built_in">self</span>:GetOwner()<br><br>    <span class="hljs-keyword">if</span> GWorld.GameInstance.TempAbyssInfo <span class="hljs-keyword">then</span><br>        <span class="hljs-comment">-- 支持用GM直接进入对应AbyssDungeonId和Difficulty的关卡</span><br>        <span class="hljs-built_in">self</span>.AbyssDungeonId = GWorld.GameInstance.TempAbyssInfo.AbyssDungeonId<br>        <span class="hljs-built_in">self</span>.AbyssDifficulty = GWorld.GameInstance.TempAbyssInfo.AbyssDifficulty<br>        GWorld.GameInstance.TempAbyssInfo = <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">self</span>.AbyssLogicServerInfo = <span class="hljs-built_in">self</span>.GameMode.PreInitInfo<br>        <span class="hljs-built_in">assert</span>(<span class="hljs-built_in">self</span>.AbyssLogicServerInfo, <span class="hljs-string">&quot;BP_AbyssComponent_C 从逻辑服拿到的信息为空！&quot;</span>)<br>        DebugPrint(<span class="hljs-string">&quot;BP_AbyssComponent_C:InitAbyssComponent 从逻辑服拿到的信息 AbyssId&quot;</span>, <span class="hljs-built_in">self</span>.AbyssLogicServerInfo.AbyssId, <span class="hljs-string">&quot;AbyssLevelId&quot;</span>, <span class="hljs-built_in">self</span>.AbyssLogicServerInfo.AbyssLevelId, <span class="hljs-string">&quot;AbyssDungeonId&quot;</span>, <span class="hljs-built_in">self</span>.AbyssLogicServerInfo.AbyssDungeonId)<br>        <span class="hljs-built_in">self</span>.AbyssDungeonId = <span class="hljs-built_in">self</span>.AbyssLogicServerInfo.AbyssDungeonId<br>        <span class="hljs-built_in">self</span>.AbyssDifficulty = <span class="hljs-built_in">self</span>:GetAbyssDifficulty()<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.GameMode:SetGameModeLevel(<span class="hljs-built_in">self</span>.AbyssDifficulty)<br><br>    <span class="hljs-built_in">self</span>.AbyssDungeonInfo = DataMgr.AbyssDungeon[<span class="hljs-built_in">self</span>.AbyssDungeonId]<br>    <span class="hljs-built_in">assert</span>(<span class="hljs-built_in">self</span>.AbyssDungeonInfo, <span class="hljs-string">&quot;BP_AbyssComponent_C AbyssDungeon表读表失败！ AbyssDungeonId &quot;</span>..<span class="hljs-built_in">self</span>.AbyssDungeonId)<br><br>    <span class="hljs-built_in">self</span>.AbyssRoomIndex = <span class="hljs-number">0</span><br>    <span class="hljs-built_in">self</span>.CurRoomId = <span class="hljs-number">0</span><br>    DebugPrint(<span class="hljs-string">&quot;BP_AbyssComponent_C:InitAbyssComponent AbyssDungeonId&quot;</span>, <span class="hljs-built_in">self</span>.AbyssDungeonId, <span class="hljs-string">&quot;AbyssDifficulty&quot;</span>, <span class="hljs-built_in">self</span>.AbyssDifficulty)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<p>这里也有,这里是直接把所有的加载进来了</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">WBP_Abyss_Main_C:OnClickedAbyssModeSelectionCell</span><span class="hljs-params">(AbyssModeSelectionCell)</span></span><br>    <span class="hljs-keyword">if</span> AbyssModeSelectionCell.IsLocked <span class="hljs-keyword">then</span><br>        UIManager(<span class="hljs-built_in">self</span>):ShowUITip(UIConst.Tip_CommonToast, GText(DataMgr.AbyssSeason[AbyssModeSelectionCell.AbyssId].DifficultyLockToast))<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.SelectCell <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.SelectCell:UnSelected()<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.SelectCell = AbyssModeSelectionCell<br>    <span class="hljs-built_in">self</span>.SelectCell:Selected()<br>    <span class="hljs-built_in">self</span>.SelectIndex = AbyssModeSelectionCell.Index<br>    <span class="hljs-built_in">self</span>.SelectAbyssId = AbyssModeSelectionCell.AbyssId<br>    <span class="hljs-built_in">self</span>:RefreshAbyssLevelInfo(<span class="hljs-built_in">self</span>.SelectAbyssId)<br>    <span class="hljs-built_in">self</span>:RefreshRewardBtnInfo(<span class="hljs-built_in">self</span>.SelectAbyssId)<br>    <span class="hljs-built_in">self</span>:RefreshTimerInfo(<span class="hljs-built_in">self</span>.SelectAbyssId)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这种子类Component里面的可以直接用TriggerDungeonComponentFun来拿到</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> HostageEid = <span class="hljs-built_in">self</span>.GameMode:TriggerDungeonComponentFun(<span class="hljs-string">&quot;GetHostageEid&quot;</span>)<br></code></pre></td></tr></table></figure>











<h1 id="通用按钮Close"><a href="#通用按钮Close" class="headerlink" title="通用按钮Close"></a>通用按钮Close</h1><h2 id="游戏运行时查看ui"><a href="#游戏运行时查看ui" class="headerlink" title="游戏运行时查看ui"></a>游戏运行时查看ui</h2><p>Window-&gt;Development Tool-&gt;WidgetReflector，然后鼠标带年纪</p>
<p>或者直接波浪号~，然后输出WidgetReflector也可以</p>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>这个就是关闭的时候，关闭太快了，没有显示出click动效，重新改一下脚本的逻辑就可以了，bind一个事件在动画播放完再执行就可以了</p>
<h1 id="Reward按钮增加手柄逻辑"><a href="#Reward按钮增加手柄逻辑" class="headerlink" title="Reward按钮增加手柄逻辑"></a>Reward按钮增加手柄逻辑</h1><p>Common_Button_Reward_PC.lua</p>
<p>给Reward增加切换手柄的时候切换图标的功能，按钮的绑定是页面自己做的，类似这样</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--手柄监听</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">WBP_Abyss_Settle_P_C:Handle_OnGamePadDown</span><span class="hljs-params">(InKeyName)</span></span><br>    <span class="hljs-keyword">if</span> (InKeyName == <span class="hljs-string">&quot;Gamepad_FaceButton_Bottom&quot;</span>) <span class="hljs-keyword">then</span> <span class="hljs-comment">-- 下一关</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.Btn_NextStage:IsVisible() <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">self</span>:OnNextLevel()<br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">elseif</span> (InKeyName == <span class="hljs-string">&quot;Gamepad_FaceButton_Left&quot;</span>) <span class="hljs-keyword">then</span> <span class="hljs-comment">--重新挑战</span><br>        <span class="hljs-built_in">self</span>:OnReplay()<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">elseif</span> (InKeyName == <span class="hljs-string">&quot;Gamepad_FaceButton_Right&quot;</span>) <span class="hljs-keyword">then</span> <span class="hljs-comment">--退出到关卡信息界面</span><br>        <span class="hljs-built_in">self</span>:ReturnLevelInfoUI()<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>主要的逻辑有以下两个</p>
<p>绑定切换时机</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 绑定输入设备切换的委托</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Common_Button_Reward_PC:BindInputMethodChangedDelegate</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">local</span> PlayerController = UE4.UGameplayStatics.GetPlayerController(<span class="hljs-built_in">self</span>, <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">local</span> GameInputModeSubsystem = UGameInputModeSubsystem.GetGameInputModeSubsystem(PlayerController)<br>    <span class="hljs-keyword">if</span> (IsValid(GameInputModeSubsystem)) <span class="hljs-keyword">then</span><br>        GameInputModeSubsystem.OnInputMethodChanged:Add(<span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.OnInputMethodChanged)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>设置Icon</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-------------------------------------------------------------------- 手柄图标部分 -------------------------------------------------------------------------</span><br><span class="hljs-comment">-- 设置手柄Icon样式</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Common_Button_Reward_PC:SetGamePadImg</span><span class="hljs-params">(ImgShortPath, ImgLongPath)</span></span><br>    <span class="hljs-keyword">local</span> ImgPath, Img = <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">if</span> ImgShortPath <span class="hljs-keyword">and</span> ImgShortPath~=<span class="hljs-string">&quot;None&quot;</span> <span class="hljs-keyword">then</span><br>        ImgPath = UIUtils.UtilsGetKeyIconPathInGamepad(ImgShortPath, <span class="hljs-built_in">self</span>.CurGamepadName)<br>        Img = LoadObject(ImgPath)<br>    <span class="hljs-keyword">elseif</span> ImgLongPath <span class="hljs-keyword">then</span><br>        Img = LoadObject(ImgLongPath)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> IsValid(Img)) <span class="hljs-keyword">then</span><br>        DebugPrint(<span class="hljs-string">&quot;缺少图片资源: ImgPath = &quot;</span>, ImgPath, ImgShortPath, ImgLongPath)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.Img_GamePad:SetBrushResourceObject(Img)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<h1 id="MOD界面手柄"><a href="#MOD界面手柄" class="headerlink" title="MOD界面手柄"></a>MOD界面手柄</h1><h2 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h2><p>svn</p>
<p><a target="_blank" rel="noopener" href="https://www.tapd.cn/31626021/prong/stories/view/1131626021001228007">https://www.tapd.cn/31626021/prong/stories/view/1131626021001228007</a></p>
<h2 id="手柄对应"><a href="#手柄对应" class="headerlink" title="手柄对应"></a>手柄对应</h2><p>用SetDefaultGamePadImg对应的名字</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250222140734093.png" srcset="/img/loading.gif" lazyload alt="image-20250222140734093"></p>
<h3 id="导航"><a href="#导航" class="headerlink" title="导航"></a>导航</h3><p>用这个接口:SetNavigationRuleExplicit，来设置不同widget之间的</p>
<p>ESC是默认</p>
<p>手柄的操作是模拟鼠标操作</p>
<p>禁止导航的就把可见性设置成HitTestInvisible，之后再设置回来就行了</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">self</span>.Sift:SetVisibility(UE4.ESlateVisibility.HitTestInvisible)<br></code></pre></td></tr></table></figure>

<h3 id="手柄切换即选中"><a href="#手柄切换即选中" class="headerlink" title="手柄切换即选中"></a>手柄切换即选中</h3><p>如果你想做一个切换并选中的功能，直接打开游戏，然后看他是哪个item，然后看OnListItemObjectSet</p>
<p>ListView可以用GetItemAt来获取Item，但是拿到的只是Object，如果要看ui保存在哪里，要看具体的Item子代码里面的OnListItemObjectSet，一般是UI，也可能会有其他名字，比如SelfWidget</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">Content.UI = <span class="hljs-built_in">self</span><br></code></pre></td></tr></table></figure>



<p>然后再用BP_OnItemSelectionChanged</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">M:BP_OnItemSelectionChanged</span><span class="hljs-params">(IsSelected)</span></span><br>    <span class="hljs-built_in">self</span>.IsSelected = IsSelected<br>    <span class="hljs-keyword">if</span> IsSelected <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.ButtonArea:SetChecked(<span class="hljs-literal">true</span>)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>而且NavigateToIndex没法触发OnselectItem这个事件，必须要用SetSelectedIndex才行0.0</p>
<p>但是这个可以解决聚焦，不过再获取他的第一个了，直接NavigateToIndex就可以了</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">self</span>.List_Item:NavigateToIndex(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>



<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">OnFocusReceived</span><br></code></pre></td></tr></table></figure>

<h3 id="Key的创建"><a href="#Key的创建" class="headerlink" title="Key的创建"></a><strong>Key的创建</strong></h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">self</span>.Key_Talk_GamePad:CreateCommonKey(&#123;<br>    KeyInfoList=&#123;<br>        &#123;<br>            Type = <span class="hljs-string">&quot;Img&quot;</span>,<br>            ImgShortPath = <span class="hljs-string">&quot;A&quot;</span><br>        &#125;<br>    &#125;<br>&#125;)<br></code></pre></td></tr></table></figure>



<h3 id="tab栏的可以添加移开焦点绑定"><a href="#tab栏的可以添加移开焦点绑定" class="headerlink" title="tab栏的可以添加移开焦点绑定"></a>tab栏的可以添加移开焦点绑定</h3><p>但要注意不要循环触发，所以可以用状态锁来处理一样</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Component:OnResourceBarRemovedFromFocusPath</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.IsFocusOnResourceBar <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">self</span>.IsProcessingFocusChange <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.IsProcessingFocusChange = <span class="hljs-literal">true</span><br>        <span class="hljs-built_in">self</span>.Mod_1:SetFocus()<br>        <span class="hljs-built_in">self</span>.IsFocusOnResourceBar = <span class="hljs-literal">false</span><br>        <span class="hljs-built_in">self</span>.IsProcessingFocusChange = <span class="hljs-literal">false</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>绑定的写法如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua">ResourceBar:BindEvents(<span class="hljs-built_in">self</span>,&#123;<br>    OnRemovedFromFocusPath = <span class="hljs-built_in">self</span>.OnResourceBarRemovedFromFocusPath<br>&#125;)<br></code></pre></td></tr></table></figure>

<h3 id="一个单独控件加聚焦和丢失聚焦逻辑"><a href="#一个单独控件加聚焦和丢失聚焦逻辑" class="headerlink" title="一个单独控件加聚焦和丢失聚焦逻辑"></a>一个单独控件加聚焦和丢失聚焦逻辑</h3><h1 id="【手柄】升级熔炼"><a href="#【手柄】升级熔炼" class="headerlink" title="【手柄】升级熔炼"></a>【手柄】升级熔炼</h1><h2 id="链接-1"><a href="#链接-1" class="headerlink" title="链接"></a>链接</h2><p><a target="_blank" rel="noopener" href="https://www.tapd.cn/31626021/prong/stories/view/1131626021001227992">https://www.tapd.cn/31626021/prong/stories/view/1131626021001227992</a></p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><h3 id="手柄相关const"><a href="#手柄相关const" class="headerlink" title="手柄相关const"></a>手柄相关const</h3><p>Const.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 手柄按键相关接口</span><br>Const.GamepadSpecialLeft = <span class="hljs-string">&quot;Gamepad_Special_Left&quot;</span>         <span class="hljs-comment">-- 左菜单键</span><br>Const.GamepadSpecialRight = <span class="hljs-string">&quot;Gamepad_Special_Right&quot;</span>       <span class="hljs-comment">-- 右菜单键</span><br>Const.GamepadDPadLeft = <span class="hljs-string">&quot;Gamepad_DPad_Left&quot;</span>               <span class="hljs-comment">-- 左方向键</span><br>Const.GamepadDPadRight = <span class="hljs-string">&quot;Gamepad_DPad_Right&quot;</span>             <span class="hljs-comment">-- 右方向键</span><br>Const.GamepadDPadUp = <span class="hljs-string">&quot;Gamepad_DPad_Up&quot;</span>                   <span class="hljs-comment">-- 上方向键</span><br>Const.GamepadDPadDown = <span class="hljs-string">&quot;Gamepad_DPad_Down&quot;</span>               <span class="hljs-comment">-- 下方向键</span><br>Const.GamepadFaceButtonLeft = <span class="hljs-string">&quot;Gamepad_FaceButton_Left&quot;</span>   <span class="hljs-comment">-- Xbox X键</span><br>Const.GamepadFaceButtonRight = <span class="hljs-string">&quot;Gamepad_FaceButton_Right&quot;</span> <span class="hljs-comment">-- Xbox B键</span><br>Const.GamepadFaceButtonUp = <span class="hljs-string">&quot;Gamepad_FaceButton_Top&quot;</span>      <span class="hljs-comment">-- Xbox Y键</span><br>Const.GamepadFaceButtonDown = <span class="hljs-string">&quot;Gamepad_FaceButton_Bottom&quot;</span>   <span class="hljs-comment">-- Xbox A键</span><br>Const.GamepadLeftShoulder = <span class="hljs-string">&quot;Gamepad_LeftShoulder&quot;</span>        <span class="hljs-comment">-- 左肩键</span><br>Const.GamepadLeftTrigger = <span class="hljs-string">&quot;Gamepad_LeftTrigger&quot;</span>          <span class="hljs-comment">-- 左扳机</span><br>Const.GamepadRightShoulder = <span class="hljs-string">&quot;Gamepad_RightShoulder&quot;</span>      <span class="hljs-comment">-- 右肩键</span><br>Const.GamepadRightTrigger = <span class="hljs-string">&quot;Gamepad_RightTrigger&quot;</span>        <span class="hljs-comment">-- 右扳机</span><br>Const.GamepadRightThumbstick = <span class="hljs-string">&quot;Gamepad_RightThumbstick&quot;</span>  <span class="hljs-comment">-- 右摇杆按钮</span><br>Const.GamepadLeftThumbstick = <span class="hljs-string">&quot;Gamepad_LeftThumbstick&quot;</span>  <span class="hljs-comment">-- 左摇杆按钮</span><br></code></pre></td></tr></table></figure>

<p><strong>结构</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs lua">Enhance = &#123;<br>    [CommonConst.ArmoryType.Weapon] = <span class="hljs-string">&quot;BluePrints.UI.WBP.Armory.CardLevel.CardLevel_C_WeaponComp&quot;</span>,<br>&#125;,<br><span class="hljs-comment">-- 升级</span><br>LevelUp = &#123;<br>    [CommonConst.ArmoryType.Weapon] = <span class="hljs-string">&quot;BluePrints.UI.WBP.Armory.Armory_CharOrWeaponLvup_Component&quot;</span>,<br>    [CommonConst.ArmoryType.Char] = <span class="hljs-string">&quot;BluePrints.UI.WBP.Armory.Armory_CharOrWeaponLvup_Component&quot;</span>,<br>    [CommonConst.ArmoryType.Mod] = <span class="hljs-string">&quot;BluePrints.UI.WBP.Armory.Mod.Armory_ModLevelUp_Component&quot;</span>,<br>    [CommonConst.ArmoryType.Pet] = <span class="hljs-string">&quot;BluePrints.UI.WBP.Armory.Armory_PetLvup_Component&quot;</span>,<br>&#125;,<br></code></pre></td></tr></table></figure>

<p>第一个是熔炼，后面有两个升级</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">[CommonConst.ArmoryType.Mod] = <span class="hljs-string">&quot;BluePrints.UI.WBP.Armory.Mod.Armory_ModEnhance_Component&quot;</span>,<br></code></pre></td></tr></table></figure>

<p>这个是增幅</p>
<p>按键的转发用</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.OnKeyDownComp <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">self</span>:OnKeyDownComp(MyGeometry, InKeyName)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<p>True</p>
<p>switcher切换</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">self</span>.WidgetSwitcher_Key:SetActiveWidgetIndex(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>



<h1 id="结算界面手柄bug"><a href="#结算界面手柄bug" class="headerlink" title="结算界面手柄bug"></a>结算界面手柄bug</h1><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>gm EnterDungeon 90602</p>
<p>按L进入一个副本</p>
<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><p>WidgetBlueprint’&#x2F;Game&#x2F;UI&#x2F;WBP&#x2F;Settlement&#x2F;PC&#x2F;WBP_Settlement_P.WBP_Settlement_P’</p>
<h1 id="连线小游戏"><a href="#连线小游戏" class="headerlink" title="连线小游戏"></a>连线小游戏</h1><p>MiGongLogic</p>
<h1 id="神庙结算页面接手柄"><a href="#神庙结算页面接手柄" class="headerlink" title="神庙结算页面接手柄"></a>神庙结算页面接手柄</h1><p>命令</p>
<p>gm enterdungeon 80901</p>
<p>gm enterdungeon 80703</p>
<p>gm enterdungeon 80704</p>
<p>这傻逼结算界面和副本结算界面是同一个脚本，太变态了</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> DungeonInfo.DungeonType <span class="hljs-keyword">and</span> DungeonInfo.DungeonType == <span class="hljs-string">&quot;Temple&quot;</span> <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<h2 id="如何拿一个物品的数量"><a href="#如何拿一个物品的数量" class="headerlink" title="如何拿一个物品的数量"></a>如何拿一个物品的数量</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua">Resource = Avatar.Resources[<span class="hljs-built_in">self</span>.RId] <span class="hljs-keyword">or</span> &#123;Count = <span class="hljs-number">0</span>&#125;<br><span class="hljs-built_in">self</span>.Text_Num:SetText(Resource.Count)<br></code></pre></td></tr></table></figure>





<h1 id="止流商店界面"><a href="#止流商店界面" class="headerlink" title="止流商店界面"></a>止流商店界面</h1><p>命令：gm openui ZhiliuEventTask</p>
<p>GM_Command.lua，可以先用这个编译一下试试</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250308150623903.png" srcset="/img/loading.gif" lazyload alt="image-20250308150623903"></p>
<p>商店主页面其实也是支持不同Shop复用的，学习一下就可以了</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">---跳转到指定商店页面</span><br><span class="hljs-comment">---@param MainTabIdx number @商城主页面index</span><br><span class="hljs-comment">---@param SubTabIdx number @商城子页面index</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PageJumpUtils:JumpToShopPage</span><span class="hljs-params">(MainTabIdx, SubTabIdx, ShopItemId, ShopType)</span></span><br>    <span class="hljs-keyword">local</span> GameInstance = GWorld.GameInstance<br>    <span class="hljs-keyword">local</span> UIManager = GameInstance:GetGameUIManager()<br><br>    <span class="hljs-keyword">local</span> ShopMainPage = UIManager:GetUIObj(<span class="hljs-string">&quot;ShopMain&quot;</span>)<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> ShopMainPage) <span class="hljs-keyword">then</span><br>        ShopMainPage = UIManager:LoadUINew(<span class="hljs-string">&#x27;ShopMain&#x27;</span>, MainTabIdx, SubTabIdx, ShopItemId, ShopType)<br>        UIManager:AddToJumpPageDeque(ShopMainPage)<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-comment">-- 已经存在的界面</span><br>        UIManager:PlaceJumpUIToTop(ShopMainPage, <span class="hljs-string">&quot;ShopMain&quot;</span>)<br>        ShopMainPage:InitShop(MainTabIdx, SubTabIdx, ShopItemId, ShopType)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>OpenUI,”ShopMain”,801,8010,ShopItemId,”FishingShop”</p>
<h2 id="如何动态加载bg"><a href="#如何动态加载bg" class="headerlink" title="如何动态加载bg"></a>如何动态加载bg</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">M:InitShopBG</span><span class="hljs-params">(ShopType)</span></span><br>    <span class="hljs-comment">-- 商店类型对应的背景路径</span><br>    <span class="hljs-keyword">local</span> bgPathMap = &#123;<br>        [<span class="hljs-string">&quot;ZhiLiuEntrust&quot;</span>] = <span class="hljs-string">&quot;/Game/UI/WBP/Activity/Widget/Shop/ShopBG/WBP_Activity_Shop_BG_ZhiliuEvent.WBP_Activity_Shop_BG_ZhiliuEvent&quot;</span><br>        <span class="hljs-comment">-- 可以在这里添加更多的商店类型和对应的背景路径</span><br>    &#125;<br>    <span class="hljs-comment">-- 获取背景路径，如果没有对应的则使用默认背景</span><br>    <span class="hljs-keyword">local</span> bgPath = bgPathMap[ShopType] <span class="hljs-keyword">or</span> bgPathMap[<span class="hljs-string">&quot;ZhiLiuEntrust&quot;</span>]<br>    <span class="hljs-keyword">local</span> WidgetClass = LoadClass(bgPath)<br>    <span class="hljs-built_in">self</span>.Group_BG:ClearChildren()<br>    <span class="hljs-keyword">if</span> WidgetClass <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">local</span> Widget = UE4.UWidgetBlueprintLibrary.Create(<span class="hljs-built_in">self</span>, WidgetClass)<br>        <span class="hljs-built_in">self</span>.Group_BG:AddChild(Widget)<br>        <span class="hljs-keyword">local</span> OverlaySlot = UE4.UWidgetLayoutLibrary.SlotAsOverlaySlot(Widget)<br>        OverlaySlot:SetPadding(FMargin(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>))<br>        OverlaySlot:SetHorizontalAlignment(EHorizontalAlignment.HAlign_Fill)<br>        OverlaySlot:SetVerticalAlignment(EVerticalAlignment.VAlign_Fill)<br>        Widget:PlayAnimation(Widget.In)<br>    <span class="hljs-keyword">else</span><br>        DebugPrint(<span class="hljs-string">&quot;Error: 无法加载商店背景: &quot;</span> .. bgPath)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>重点是设置这个</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua">OverlaySlot:SetHorizontalAlignment(EHorizontalAlignment.HAlign_Fill)<br>OverlaySlot:SetVerticalAlignment(EVerticalAlignment.VAlign_Fill)<br></code></pre></td></tr></table></figure>



<h1 id="大秘境ESC界面-1"><a href="#大秘境ESC界面-1" class="headerlink" title="大秘境ESC界面"></a>大秘境ESC界面</h1><p>输入 gm completecondition 4220 解锁大秘境</p>
<p>gm EnterAbyss 2011011 10</p>
<p>直接进入大秘境，因为现在页面大秘境有点bug(好像又没了)</p>
<p>拿Icon</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> SlotType = SlotName2Type[EName]<br><span class="hljs-keyword">local</span> DataType = SlotType2DataType[SlotType]<br><span class="hljs-keyword">local</span> Unit = Avatar[DataType..<span class="hljs-string">&quot;s&quot;</span>][Uuid]<br><span class="hljs-keyword">local</span> UnitData = Unit:Data()<br><span class="hljs-keyword">local</span> Content = &#123;<br>    Icon = UnitData.Icon,<br>    GachaIcon = UnitData.GachaIcon,<br>    Uuid = Uuid,<br>&#125;<br>DungeonPanel:UpdateSlot(EName, Content)<br></code></pre></td></tr></table></figure>

<h1 id="进度条优化"><a href="#进度条优化" class="headerlink" title="进度条优化"></a>进度条优化</h1><p>现在是没有区分，现在的加载有三个部分，场景，特效，还有一些杂七杂八，在编辑器里面会卡场景，然后就一直是0，所以现在要改一下，比如0-50是场景，50-90是特效，杂七杂八是后面的</p>
<p>场景找沈旻晖，特效找吴志军</p>
<p>场景加载完会走这个尝试关loading，说白了所有需要等待的地方都会走tryendloading</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250314143210622.png" srcset="/img/loading.gif" lazyload alt="image-20250314143210622"></p>
<p>场景</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250314143159646.png" srcset="/img/loading.gif" lazyload alt="image-20250314143159646"></p>
<p>杂七杂八</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250314143145703.png" srcset="/img/loading.gif" lazyload alt="image-20250314143145703"></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><br></code></pre></td></tr></table></figure>

<p>这个Load分为很多个，LevelLoad会自己管理这个进度条，但是WorldLevel不会，只会直接0-90，他们都继承这个EMLevelLoader</p>
<p>  GameState.bAssetsPreloading &#x3D; true</p>
<p>区域加载是BP_WorldLoader_C</p>
<h1 id="好友界面接手柄"><a href="#好友界面接手柄" class="headerlink" title="好友界面接手柄"></a>好友界面接手柄</h1><h1 id="公告接手柄"><a href="#公告接手柄" class="headerlink" title="公告接手柄"></a>公告接手柄</h1><h2 id="滚动条"><a href="#滚动条" class="headerlink" title="滚动条"></a>滚动条</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Component:OnAnalogValueChanged</span><span class="hljs-params">(MyGeometry,InAnalogInputEvent)</span></span><br>    <span class="hljs-keyword">local</span> InKey = UE4.UKismetInputLibrary.GetKey(InAnalogInputEvent)<br>    <span class="hljs-keyword">local</span> InKeyName = UE4.UFormulaFunctionLibrary.Key_GetFName(InKey)<br>    <span class="hljs-keyword">if</span> (InKeyName == <span class="hljs-string">&quot;Gamepad_RightY&quot;</span>) <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> IsValid(<span class="hljs-built_in">self</span>.ItemDetailsWidget) <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">return</span><br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">local</span> a = UKismetInputLibrary.GetAnalogValue(InAnalogInputEvent) * <span class="hljs-number">30</span><br>        <span class="hljs-keyword">local</span> CurScrollOffset = <span class="hljs-built_in">self</span>.ItemDetailsWidget.EMScrollBox_1:GetScrollOffset()<br>        <span class="hljs-keyword">local</span> ScrollOffset = <span class="hljs-built_in">math</span>.clamp(CurScrollOffset - a,<span class="hljs-number">0</span>, <span class="hljs-built_in">self</span>.ItemDetailsWidget.EMScrollBox_1:GetScrollOffsetOfEnd())<br>        <span class="hljs-built_in">self</span>.ItemDetailsWidget.EMScrollBox_1:SetScrollOffset(ScrollOffset)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> UWidgetBlueprintLibrary.Unhandled()<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>得用ExecuteJavascript</p>
<p>是否可滚动</p>
<p>self.ScrollBox_List:GetScrollOffsetOfEnd()</p>
<p>ListView也用这个</p>
<p>SetScrollOffset</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">M:OnAnalogValueChanged</span><span class="hljs-params">(MyGeometry,InAnalogInputEvent)</span></span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">self</span>.MaxListScrollOffset <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.MaxListScrollOffset = UIUtils.GetMaxScrollOffsetOfListView(<span class="hljs-built_in">self</span>.List_ScoreItem)<br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">local</span> InKey = UE4.UKismetInputLibrary.GetKey(InAnalogInputEvent)<br>    <span class="hljs-keyword">local</span> InKeyName = UE4.UFormulaFunctionLibrary.Key_GetFName(InKey)<br>    <span class="hljs-keyword">local</span> AddOffset = UKismetInputLibrary.GetAnalogValue(InAnalogInputEvent) * <span class="hljs-number">0.5</span><br>    <br>    <span class="hljs-comment">-- 死区</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(AddOffset) &lt; <span class="hljs-number">0.01</span> <span class="hljs-keyword">then</span> <br>        <span class="hljs-keyword">return</span> UE4.UWidgetBlueprintLibrary.UnHandled()<br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">if</span> InKeyName == <span class="hljs-string">&quot;Gamepad_RightY&quot;</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">local</span> CurScrollOffset = <span class="hljs-built_in">self</span>.List_ScoreItem:GetScrollOffset()<br>        <span class="hljs-keyword">local</span> ScrollOffset = <span class="hljs-built_in">math</span>.clamp(CurScrollOffset - AddOffset, <span class="hljs-number">0</span>, <span class="hljs-built_in">self</span>.MaxListScrollOffset)<br>        <span class="hljs-built_in">self</span>.List_ScoreItem:SetScrollOffset(ScrollOffset)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> UE4.UWidgetBlueprintLibrary.UnHandled()<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>





<h1 id="地图gui迭代"><a href="#地图gui迭代" class="headerlink" title="地图gui迭代"></a>地图gui迭代</h1><p>要做一个随着鼠标一直动的东西，之前有一个WBP_Map_Select</p>
<p>区域地图看LevelMap_Wild_Dialog_PC_C.lua</p>
<h1 id="QA关卡静态点导出工具"><a href="#QA关卡静态点导出工具" class="headerlink" title="QA关卡静态点导出工具"></a>QA关卡静态点导出工具</h1><p>1EditorTool</p>
<p>写蓝图代码，加上在WCEditFunctionLibrary.h里面写函数，可以在蓝图里面直接用，然后蓝图的逻辑大概就是遍历所有Levels下面的文件，然后筛出里面带有Design的level</p>
<h1 id="历练等级活动界面"><a href="#历练等级活动界面" class="headerlink" title="历练等级活动界面"></a>历练等级活动界面</h1><p>gm openui TrainingLevel</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> ActivityConfigData = DataMgr.EventMain[ActivityId]<br><br>ActivityPage = UIManager(<span class="hljs-built_in">self</span>):CreateWidgetAsync(ActivityPageName, CoroutineObj, ActivityConfigData.PCBluePrint)<br></code></pre></td></tr></table></figure>

<p>这个ActivitConfigData里面有蓝图数据</p>
<p>所以活动界面其实都是策划配置，这个Event.xlsx里面啥都能配，我只需要写这个页面的逻辑就可以了</p>
<h1 id="自定义tab"><a href="#自定义tab" class="headerlink" title="自定义tab"></a>自定义tab</h1><p>在这个tab定义的时候加一个ChildWidgetBPPath，然后Tabs这里面加一个icon，然后在自己的item里面新写一个脚本</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs lua">    TabConfigData = &#123;<br>        PlatformName = PlatformName,<br>        Tabs = &#123;<br>            &#123;<br>                Text = GText(DataMgr[<span class="hljs-string">&quot;NoticeTab&quot;</span>][<span class="hljs-number">1</span>][<span class="hljs-string">&quot;Text&quot;</span>]),<br>                TabId = <span class="hljs-number">1</span>,<br>                Icon = DataMgr[<span class="hljs-string">&quot;NoticeTab&quot;</span>][<span class="hljs-number">1</span>][<span class="hljs-string">&quot;IconPath&quot;</span>]<br>            &#125;,<br>            &#123;<br>                Text = GText(DataMgr[<span class="hljs-string">&quot;NoticeTab&quot;</span>][<span class="hljs-number">2</span>][<span class="hljs-string">&quot;Text&quot;</span>]),<br>                TabId = <span class="hljs-number">2</span>,<br>                Icon = DataMgr[<span class="hljs-string">&quot;NoticeTab&quot;</span>][<span class="hljs-number">2</span>][<span class="hljs-string">&quot;IconPath&quot;</span>]<br>            &#125;,<br>            &#123;<br>                Text = GText(DataMgr[<span class="hljs-string">&quot;NoticeTab&quot;</span>][<span class="hljs-number">3</span>][<span class="hljs-string">&quot;Text&quot;</span>]),<br>                TabId = <span class="hljs-number">3</span>,<br>                Icon = DataMgr[<span class="hljs-string">&quot;NoticeTab&quot;</span>][<span class="hljs-number">3</span>][<span class="hljs-string">&quot;IconPath&quot;</span>]<br>            &#125;<br>        &#125;,<br>        ChildWidgetBPPath = <span class="hljs-string">&quot;WidgetBlueprint&#x27;/Game/UI/WBP/Announcement/Widget/WBP_Announcement_TabItem.WBP_Announcement_TabItem&#x27;&quot;</span><br>    &#125;<br>&#125;<br>UIManager(GWorld.GameInstance):ShowCommonPopupUI(<span class="hljs-number">100134</span>, Params, ParentWidget, Coroutine)<br></code></pre></td></tr></table></figure>

<p>新写的如下</p>
<p>WBP_Annoucement_TabItem.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--</span><br><span class="hljs-comment">-- DESCRIPTION</span><br><span class="hljs-comment">--</span><br><span class="hljs-comment">-- @COMPANY **</span><br><span class="hljs-comment">-- @AUTHOR **</span><br><span class="hljs-comment">-- @DATE $&#123;date&#125; $&#123;time&#125;</span><br><span class="hljs-comment">--</span><br><span class="hljs-built_in">require</span> <span class="hljs-string">&quot;UnLua&quot;</span><br><br><span class="hljs-comment">---@type WBP_Announcement_TabItem_C</span><br><span class="hljs-keyword">local</span> M = Class(&#123;<span class="hljs-string">&quot;BluePrints.UI.WBP.Common.Tab.Widget.WBP_Com_TabSubItem01_P_C&quot;</span>&#125;)<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">M:Update</span><span class="hljs-params">(Idx, Info, PlatformDeviceName)</span></span><br>    M.Super.Update(<span class="hljs-built_in">self</span>, Idx, Info, PlatformDeviceName)<br>    <span class="hljs-built_in">self</span>.Icon_Tab:SetBrushFromTexture(LoadObject(Info.Icon))<br><span class="hljs-keyword">end</span><br><br><br><span class="hljs-keyword">return</span> M<br></code></pre></td></tr></table></figure>

<h1 id="监听buff写ui"><a href="#监听buff写ui" class="headerlink" title="监听buff写ui"></a>监听buff写ui</h1><p>可以参考Battle_FeinaSkill.lua，主要是RegisterOnBuffsChangedDelegate、ReceiveOnBuffsChanged这两个函数</p>
<p>要手动解绑绑定，不然没法响应</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">self</span>:UnRegisterOnBuffsChangedDelegate()<br><span class="hljs-built_in">self</span>:K2_SetBuffsOwner(Owner)<br><span class="hljs-built_in">self</span>:RegisterOnBuffsChangedDelegate()<br></code></pre></td></tr></table></figure>

<p>widget也要改</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250407161507215.png" srcset="/img/loading.gif" lazyload></p>
<p>removebuff</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GM_Command:RemoveBuff</span><span class="hljs-params">(BuffId, Eid)</span></span><br>    <span class="hljs-comment">-- 移除玩家身上的某个buff</span><br>    <span class="hljs-comment">-- example: gm RemoveBuff 101</span><br>    BuffId = <span class="hljs-built_in">tonumber</span>(BuffId)<br>    <span class="hljs-built_in">assert</span>(BuffId, <span class="hljs-string">&#x27;BuffId要填数字&#x27;</span>)<br>    <span class="hljs-built_in">assert</span>(DataMgr.Buff[BuffId], <span class="hljs-string">&#x27;找不到[&#x27;</span> .. <span class="hljs-built_in">tostring</span>(BuffId) .. <span class="hljs-string">&#x27;]对应的Buff&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Eid <span class="hljs-keyword">then</span><br>        Eid = <span class="hljs-built_in">self</span>.Player.Eid<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>:ServerBattleCommand(<span class="hljs-string">&#x27;RemoveBuff&#x27;</span>, Eid, BuffId)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GM_Command:AddBuff</span><span class="hljs-params">(BuffId,LastTime, Value, Eid)</span></span><br>    <span class="hljs-comment">-- 给某个对象添加buff</span><br>    <span class="hljs-comment">-- example: gm AddBuff 101 10</span><br><br>    BuffId = <span class="hljs-built_in">tonumber</span>(BuffId)<br>    Eid = <span class="hljs-built_in">tonumber</span>(Eid)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Eid <span class="hljs-keyword">then</span><br>        Eid = <span class="hljs-built_in">self</span>.Player.Eid<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">assert</span>(BuffId, <span class="hljs-string">&#x27;BuffId要填数字&#x27;</span>)<br>    <span class="hljs-built_in">assert</span>(DataMgr.Buff[BuffId], <span class="hljs-string">&#x27;找不到[&#x27;</span> .. <span class="hljs-built_in">tostring</span>(BuffId) .. <span class="hljs-string">&#x27;]对应的Buff&#x27;</span>)<br>    LastTime = <span class="hljs-built_in">tonumber</span>(LastTime)<br>    <span class="hljs-built_in">assert</span>(LastTime <span class="hljs-keyword">and</span> (LastTime ~= <span class="hljs-number">0</span>), <span class="hljs-string">&#x27;LastTime要填数字且不能为0&#x27;</span>)<br>    <span class="hljs-keyword">if</span> Value <span class="hljs-keyword">then</span><br>        Value = <span class="hljs-built_in">tonumber</span>(Value)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>:ServerBattleCommand(<span class="hljs-string">&#x27;AddBuff&#x27;</span>, Eid, BuffId, <span class="hljs-built_in">tonumber</span>(LastTime), Value)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>





<h1 id="推理界面2-0"><a href="#推理界面2-0" class="headerlink" title="推理界面2.0"></a>推理界面2.0</h1><p>之前红点只记录了AnswerId,但现在有很多个问题同时有，所以得改，好像不对，answer其实是唯一的，好像不用改啊</p>
<p><strong>红点</strong></p>
<p>可能已经处理好了，但是还要处理每一个问题自身的红点</p>
<p>红点是否要记录上线下线？在reddot表里加一个本地缓存就好了</p>
<p><strong>多结局单结局，多选单选</strong></p>
<p>我现在理解的是结局指的是可能需要的线索ProbablyNeededAnswers，多选单选指的是需要提交的线索**(似乎还没配表)**</p>
<p><strong>跳到剧情</strong></p>
<p>有接口？</p>
<p><strong>选中和选择</strong></p>
<p>联想界面的奇怪的东西</p>
<p><strong>失败后的提示</strong></p>
<p>联想要有，怎么判断，有很多中情况</p>
<p>第一：不需要联想（没配，或者是已经齐全了）<strong>（通用提示）</strong></p>
<p>第二：需要联想，但是收集的线索不够，或者线索不全（文案包装）</p>
<p><strong>list</strong></p>
<p>任务标题怎么拿？（可能要加字段）</p>
<p><strong>这个显示时机是什么意思？</strong></p>
<p>现在的意思是说，一直都会有个人在讲话，但是会根据你选择的线索的各种情况，来显示不同的话，比如如果有关联可能会显示什么什么，如果不能联想可能会显示什么什么，…</p>
<p><strong>记录对方案的结果</strong></p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250407161955049.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>线索来源</strong></p>
<p>只有主问题的线索才有可能有来源，这个线索的来源是来自哪个子问题的推理结果</p>
<h1 id="光环mod"><a href="#光环mod" class="headerlink" title="光环mod"></a>光环mod</h1><p>判断条件</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> HaloMod = DataMgr.Mod[<span class="hljs-built_in">self</span>.ParentWidget.ItemId]<br><span class="hljs-keyword">if</span> HaloMod.ApplySlot <span class="hljs-keyword">and</span> #HaloMod.ApplySlot == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> HaloMod.ApplySlot[<span class="hljs-number">1</span>] == <span class="hljs-number">9</span> <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">self</span>.ParentWidget.Img_Aura:SetVisibility(ESlateVisibility.SelfHitTestInvisible)<br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">self</span>.ParentWidget.Img_Aura:SetVisibility(ESlateVisibility.Collapsed)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>需要改的地方</p>
<p>背包</p>
<p>WBP_Bag_Item_C</p>
<p>获得奖励</p>
<h1 id="染色"><a href="#染色" class="headerlink" title="染色"></a>染色</h1><p>最后是在bp_CharacterFashion这里面做的</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250408204849600.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250408204956644.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">UMeshComponent::SetVectorParameterValueOnMaterials</span><span class="hljs-params">(<span class="hljs-type">const</span> FName ParameterName, <span class="hljs-type">const</span> FVector ParameterValue)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (!bEnableMaterialParameterCaching)<br>    &#123;<br>        <span class="hljs-type">const</span> TArray&lt;UMaterialInterface*&gt; MaterialInterfaces = <span class="hljs-built_in">GetMaterials</span>();<br>        <span class="hljs-keyword">for</span> (int32 MaterialIndex = <span class="hljs-number">0</span>; MaterialIndex &lt; MaterialInterfaces.<span class="hljs-built_in">Num</span>(); ++MaterialIndex)<br>        &#123;<br>            UMaterialInterface* MaterialInterface = MaterialInterfaces[MaterialIndex];<br>            <span class="hljs-keyword">if</span> (MaterialInterface)<br>            &#123;<br>                UMaterialInstanceDynamic* DynamicMaterial = <span class="hljs-built_in">Cast</span>&lt;UMaterialInstanceDynamic&gt;(MaterialInterface);<br>                <span class="hljs-keyword">if</span> (!DynamicMaterial)<br>                &#123;<br>                    DynamicMaterial = <span class="hljs-built_in">CreateAndSetMaterialInstanceDynamic</span>(MaterialIndex);<br>                &#125;<br>                DynamicMaterial-&gt;<span class="hljs-built_in">SetVectorParameterValue</span>(ParameterName, ParameterValue);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (bCachedMaterialParameterIndicesAreDirty)<br>        &#123;<br>            <span class="hljs-built_in">CacheMaterialParameterNameIndices</span>();<br>        &#125;<br><br>        <span class="hljs-comment">// Look up material index array according to ParameterName</span><br>        <span class="hljs-keyword">if</span> (FMaterialParameterCache* ParameterCache = MaterialParameterCache.<span class="hljs-built_in">Find</span>(ParameterName))<br>        &#123;<br>            <span class="hljs-type">const</span> TArray&lt;int32&gt;&amp; MaterialIndices = ParameterCache-&gt;VectorParameterMaterialIndices;<br>            <span class="hljs-comment">// Loop over all the material indices and update set the parameter value on the corresponding materials</span><br>            <span class="hljs-keyword">for</span> (int32 MaterialIndex: MaterialIndices)<br>            &#123;<br>                UMaterialInterface* MaterialInterface = <span class="hljs-built_in">GetMaterial</span>(MaterialIndex);<br>                <span class="hljs-keyword">if</span> (MaterialInterface)<br>                &#123;<br>                    UMaterialInstanceDynamic* DynamicMaterial = <span class="hljs-built_in">Cast</span>&lt;UMaterialInstanceDynamic&gt;(MaterialInterface);<br>                    <span class="hljs-keyword">if</span> (!DynamicMaterial)<br>                    &#123;<br>                        DynamicMaterial = <span class="hljs-built_in">CreateAndSetMaterialInstanceDynamic</span>(MaterialIndex);<br>                    &#125;<br>                    DynamicMaterial-&gt;<span class="hljs-built_in">SetVectorParameterValue</span>(ParameterName, ParameterValue);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h1><ul>
<li><p>全部放固态，不然根本工作不了，机械太垃圾了</p>
</li>
<li><p>尽量只更新Content，别更新Source，后者里面有cpp，每次更都要重新编译，慢的一批</p>
</li>
<li><p>强调一下，副本UI，客户端相关的东西，以及服务器相关的，不要从gameinstance上拿副本id,统一都去gamestate上用方法拿</p>
</li>
<li><p>想要拿到必须要勾上Is Variable</p>
</li>
</ul>
<p>Xbox手柄图</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250307145412350.png" srcset="/img/loading.gif" lazyload alt="image-20250307145412350"></p>
<p>延迟一帧</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250317103119345.png" srcset="/img/loading.gif" lazyload alt="image-20250317103119345"></p>
<p>深拷贝</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">BottomKeyInfo = CommonUtils.CopyTable(<span class="hljs-built_in">self</span>.BottomKeyInfo),<br></code></pre></td></tr></table></figure>

<p>不用这个会导致外面改的被改了</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">self.BottomKeyInfo = &#123;</span><br><span class="language-xml">    &#123;GamePadInfoList =  </span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">Type</span>=<span class="hljs-string">&quot;Img&quot;</span>, <span class="hljs-attr">ImgShortPath</span>=<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-attr">Owner</span>=self&#125;&#125;</span><span class="language-xml">, Desc = GText(&quot;UI_Controller_Check&quot;)&#125;,</span><br><span class="language-xml">    &#123;GamePadInfoList =  </span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">Type</span>=<span class="hljs-string">&quot;Img&quot;</span>, <span class="hljs-attr">ImgShortPath</span>=<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-attr">Owner</span>=self&#125;&#125;</span><span class="language-xml">, Desc = GText(&quot;UI_RougeLike_BlessingConfirm&quot;)&#125;,</span><br><span class="language-xml">    &#123;</span><br><span class="language-xml">        KeyInfoList = </span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">Type</span>=<span class="hljs-string">&quot;Text&quot;</span>, <span class="hljs-attr">Text</span>=<span class="hljs-string">&quot;Esc&quot;</span>, <span class="hljs-attr">ClickCallback</span>=BackCb, <span class="hljs-attr">Owner</span>=self&#125;&#125;</span><span class="language-xml">,</span><br><span class="language-xml">        GamePadInfoList = </span><span class="hljs-template-variable">&#123;&#123;<span class="hljs-name">Type</span>=<span class="hljs-string">&quot;Img&quot;</span>, <span class="hljs-attr">ImgShortPath</span>=<span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-attr">ClickCallback</span>=BackCb, <span class="hljs-attr">Owner</span>=self&#125;&#125;</span><span class="language-xml">,</span><br><span class="language-xml">        Desc=GText(&quot;UI_BACK&quot;)</span><br><span class="language-xml">    &#125;,</span><br><span class="language-xml">&#125;</span><br></code></pre></td></tr></table></figure>

<p>这样竟然会循环引用，因为有个Owner&#x3D;self</p>
<p>如果阳神改的没问题的话，BP_GetDesiredFocusTarget这个会在界面收到聚焦和界面切换手柄时，主动做一次聚焦，聚焦的控件为BP_GetDesiredFocusTarget的返回值</p>
<p>设置光标可见性</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">self</span>.GameInputModeSubsystem:SetNavigateWidgetVisibility(<span class="hljs-literal">false</span>)<br></code></pre></td></tr></table></figure>

<p>刷新</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">M:OnUpdateUIStyleByInputTypeChange</span><span class="hljs-params">(CurInputDevice, CurGamepadName)</span></span><br>    <span class="hljs-keyword">if</span> CommonUtils.GetDeviceTypeByPlatformName(<span class="hljs-built_in">self</span>) == <span class="hljs-string">&quot;Mobile&quot;</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">if</span> CurInputDevice == ECommonInputType.MouseAndKeyboard <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>:ShowMouseAndKeyboardView()<br>    <span class="hljs-keyword">elseif</span> CurInputDevice == ECommonInputType.Gamepad <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>:ShowGamepadView()<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>导出</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++">C:/WorkEngine/Engine/Binaries/Win64/UE4Editor-Cmd.exe E:\WorkGame\EM.uproject -run=RegionData -path=Content/Maps/Levels/Chapter01/Chapter01_Abyss_Boss01.umap<br></code></pre></td></tr></table></figure>

<p>HandLevelRegionLevel</p>
<p>播放音效</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua">AudioManager(<span class="hljs-built_in">self</span>):SetEventSoundParam(<span class="hljs-built_in">self</span>, <span class="hljs-string">&quot;EnergySupplyOpen&quot;</span>, &#123;ToEnd = <span class="hljs-number">1</span>&#125;)<br><br>AudioManager(<span class="hljs-built_in">self</span>):PlayUISound(<span class="hljs-built_in">self</span>, <span class="hljs-string">&quot;event:/ui/common/click_btn_small&quot;</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>)<br></code></pre></td></tr></table></figure>

<p>可以在wcedit function library里面搞一下</p>
<p>接动态材质</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> (Info.IconPath) <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">local</span> Icon = LoadObject(Info.IconPath)<br>    <span class="hljs-keyword">local</span> Material = <span class="hljs-built_in">self</span>.Img_TabIcon:GetDynamicMaterial()<br>    Material:SetTextureParameterValue(<span class="hljs-string">&quot;Mask&quot;</span>, Icon)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<p>scrollbox无法拖动</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250331162722001.png" srcset="/img/loading.gif" lazyload alt="image-20250331162722001"></p>
<p>查找是否staticmeshactor是否有不对的lightmaptype</p>
<p>使用方法是把全部的level都加载进来</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">UWCEditFunctionLibrary::ExportStaticMeshActorInfoFromWorld</span><span class="hljs-params">(UWorld* World)</span></span><br><span class="hljs-function"></span>&#123;<br>	UWorld* CurrentWorld = World;<br>	<span class="hljs-keyword">if</span> (!CurrentWorld)<br>	&#123;<br>		<span class="hljs-built_in">UE_LOG</span>(LogTemp, Log, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;JLY_ 111111111 Current World Is NUll &quot;</span>));<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br>	TArray&lt;AActor*&gt; StaticMeshActors;<br>	<span class="hljs-comment">//UGameplayStatics::GetAllActorsOfClass(World, AStaticMeshActor::StaticClass(), StaticMeshActors);</span><br>	UGameplayStatics::<span class="hljs-built_in">GetAllActorsOfClass</span>(GEditor-&gt;<span class="hljs-built_in">GetEditorWorldContext</span>().<span class="hljs-built_in">World</span>(), AStaticMeshActor::<span class="hljs-built_in">StaticClass</span>(), StaticMeshActors);<br>	<br>	<span class="hljs-comment">// 在for循环之前准备日志内容的开头部分</span><br>	FString LogFileName = <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;MeshData.log&quot;</span>);<br>	FString SavePath = FPaths::<span class="hljs-built_in">ProjectContentDir</span>() + <span class="hljs-string">&quot;Script/Datas/QA_DesignLevel_data/ErrorLog&quot;</span>;<br>	FString LogFilePath = FPaths::<span class="hljs-built_in">Combine</span>(SavePath, LogFileName);<br><br>	<span class="hljs-comment">// 创建新的日志内容</span><br>	FString WorldName = World-&gt;<span class="hljs-built_in">GetName</span>();<br>	FString NewLogContent = FString::<span class="hljs-built_in">Printf</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;关卡 %s 中存在以下LightmapType不为2的StaticMeshActor:\n\n&quot;</span>), *WorldName);<br><br>	<span class="hljs-type">bool</span> bFoundInvalidMeshes = <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> StaticMeshActor : StaticMeshActors)<br>	&#123;<br>		AStaticMeshActor* MeshActor = <span class="hljs-built_in">Cast</span>&lt;AStaticMeshActor&gt;(StaticMeshActor);<br>		UStaticMeshComponent* component = MeshActor-&gt;<span class="hljs-built_in">GetStaticMeshComponent</span>();<br>		<br>		<span class="hljs-keyword">if</span> (component-&gt;LightmapType == ELightmapType::ForceSurface) &#123;<br>			<span class="hljs-comment">// 只记录Actor的名称</span><br>			NewLogContent += FString::<span class="hljs-built_in">Printf</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot; 关卡%s - %s\n&quot;</span>), *MeshActor-&gt;<span class="hljs-built_in">GetWorld</span>()-&gt;<span class="hljs-built_in">GetName</span>() ,*MeshActor-&gt;<span class="hljs-built_in">GetName</span>());<br>			bFoundInvalidMeshes = <span class="hljs-literal">true</span>;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// 只有在找到不符合条件的Mesh时才写入日志</span><br>	<span class="hljs-keyword">if</span> (bFoundInvalidMeshes)<br>	&#123;<br>		<span class="hljs-comment">// 确保目录存在</span><br>		IFileManager::<span class="hljs-built_in">Get</span>().<span class="hljs-built_in">MakeDirectory</span>(*SavePath, <span class="hljs-literal">true</span>);<br><br>		<span class="hljs-comment">// 读取现有日志内容（如果存在）</span><br>		FString ExistingLogContent;<br>		FFileHelper::<span class="hljs-built_in">LoadFileToString</span>(ExistingLogContent, *LogFilePath);<br><br>		<span class="hljs-comment">// 将新内容追加到现有内容后面</span><br>		FString CombinedLogContent = ExistingLogContent + NewLogContent;<br><br>		<span class="hljs-comment">// 保存合并后的日志文件</span><br>		FFileHelper::<span class="hljs-built_in">SaveStringToFile</span>(CombinedLogContent, *LogFilePath);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>设置光标透明度dun</p>
<p>0 是透明</p>
<p>1 是不透明</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">self</span>.GameInputModeSubsystem:SetNavigateWidgetOpacity(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>



<p>button禁用态</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">SetForbidden<br></code></pre></td></tr></table></figure>





<p>运行时修改材质参数</p>
<p>SetScalarParameterValue是一个单变量</p>
<p>SetVectorParameterValue可以设置</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">M:SetDyeable</span><span class="hljs-params">(bDyeable)</span></span><br>    <span class="hljs-keyword">local</span> IconDynaMaterial = <span class="hljs-built_in">self</span>.Img_Item:GetDynamicMaterial()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> IconDynaMaterial <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">end</span><br>    <br>    <span class="hljs-keyword">if</span> bDyeable <span class="hljs-keyword">then</span><br>        IconDynaMaterial:SetScalarParameterValue(<span class="hljs-string">&quot;NonDye&quot;</span>, <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">self</span>:SetCornerColorAlpha(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">else</span><br>        IconDynaMaterial:SetScalarParameterValue(<span class="hljs-string">&quot;NonDye&quot;</span>, <span class="hljs-number">1</span>)<br>        <span class="hljs-built_in">self</span>:SetCornerColorAlpha(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- 新增函数：设置角落颜色的透明度</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">M:SetCornerColorAlpha</span><span class="hljs-params">(alphaValue)</span></span><br>    <span class="hljs-keyword">local</span> IconDynaMaterial = <span class="hljs-built_in">self</span>.Img_Item:GetDynamicMaterial()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> IconDynaMaterial <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">end</span><br>    <br>    <span class="hljs-keyword">local</span> defaultColor = UE4.FLinearColor(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, alphaValue)<br>    IconDynaMaterial:SetVectorParameterValue(<span class="hljs-string">&quot;CornerColor&quot;</span>, defaultColor)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250414215853197.png" srcset="/img/loading.gif" lazyload alt="材质示例"></p>
<p>获取这个值，K2_GetScalarParameterValue</p>
<p>长按短按</p>
<p>这个东西竟然是直接挂在BP_PlayerCharacter_C.lua上面的，在打开StartOpenMap这里多加了一个定时器来判断</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BP_PlayerCharacter_C:StartOpenMap</span><span class="hljs-params">()</span></span><br>    <span class="hljs-built_in">self</span>.IsStartOpenMap = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">if</span> UIUtils.UtilsGetCurrentInputType() ~= ECommonInputType.Gamepad <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>:OpenMap()<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">local</span> Avatar = GWorld:GetAvatar()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Avatar <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> Avatar:CheckUIUnlocked(<span class="hljs-string">&quot;Chat&quot;</span>) <span class="hljs-keyword">then</span> <br>        <span class="hljs-built_in">self</span>:OpenMap()<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">local</span> BattleMainUI = UIManager(<span class="hljs-built_in">self</span>):GetUIObj(<span class="hljs-string">&quot;BattleMain&quot;</span>)<br>    <span class="hljs-keyword">if</span> BattleMainUI <span class="hljs-keyword">and</span> BattleMainUI.Key_ChatEntry <span class="hljs-keyword">then</span> <br>        BattleMainUI.Key_ChatEntry:OnButtonPressed()<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.LongPressThreshold = <span class="hljs-built_in">self</span>.LongPressThreshold <span class="hljs-keyword">or</span> <span class="hljs-number">0.8</span><br>    <span class="hljs-built_in">self</span>.ChatUpdateTimer = URuntimeCommonFunctionLibrary.K2_SetTimerDelegate(&#123;<span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.ChatUpdate&#125;, <span class="hljs-built_in">self</span>.LongPressThreshold, <span class="hljs-literal">true</span>, <span class="hljs-number">0</span>)<br><span class="hljs-keyword">end</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BP_PlayerCharacter_C:StopOpenMap</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.IsStartOpenMap <span class="hljs-keyword">then</span> <br>        <span class="hljs-built_in">self</span>.IsStartOpenMap = <span class="hljs-literal">false</span><br>        <span class="hljs-built_in">self</span>:OpenMap()<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">self</span>.ChatUpdateTimer) <span class="hljs-keyword">then</span><br>        URuntimeCommonFunctionLibrary.K2_ClearAndInvalidateTimerHandle(<span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.ChatUpdateTimer)<br>        <span class="hljs-built_in">self</span>.ChatUpdateTimer = <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">local</span> BattleMainUI = UIManager(<span class="hljs-built_in">self</span>):GetUIObj(<span class="hljs-string">&quot;BattleMain&quot;</span>)<br>    <span class="hljs-keyword">if</span> BattleMainUI <span class="hljs-keyword">and</span> BattleMainUI.Key_ChatEntry <span class="hljs-keyword">then</span> <br>        BattleMainUI.Key_ChatEntry:OnButtonReleased()<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BP_PlayerCharacter_C:ChatUpdate</span><span class="hljs-params">()</span></span><br>    ChatController:OpenView(<span class="hljs-built_in">self</span>,<span class="hljs-literal">true</span>)<br>    <span class="hljs-built_in">self</span>.IsStartOpenMap = <span class="hljs-literal">false</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>然后在PlayerCharacter.cpp上加点绑定就好了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">BindAction</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;OpenMap&quot;</span>), IE_Pressed, &amp;APlayerCharacter::StartOpenMap);<br><span class="hljs-built_in">BindAction</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;OpenMap&quot;</span>), IE_Released, &amp;APlayerCharacter::StopOpenMap);<br></code></pre></td></tr></table></figure>





<p>获得mod命令</p>
<p>sgm aom xxxx 获取指定Id的Mod</p>
<p>测试命令</p>
<p>gm SuccQuestChain 110109</p>
<p>gm SuccQuestChain 200227</p>
<h1 id="固定光消失问题"><a href="#固定光消失问题" class="headerlink" title="固定光消失问题"></a>固定光消失问题</h1><p>出现了一个很奇怪的问题，某些固定光会奇怪的只在editor里面显示，但是打包和运行起来就不对了，原因是勾了这个</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250520144907705.png" srcset="/img/loading.gif" lazyload alt="image-20250520144907705"></p>
<h1 id="如何离开副本自动打开一个界面？"><a href="#如何离开副本自动打开一个界面？" class="headerlink" title="如何离开副本自动打开一个界面？"></a>如何离开副本自动打开一个界面？</h1><p>再进去的时候保存一下本地信息，然后AfterLoading这里会再写一个逻辑，根据保存的信息打开</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250521144140603.png" srcset="/img/loading.gif" lazyload alt="image-20250521144140603"></p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250521144144132.png" srcset="/img/loading.gif" lazyload alt="image-20250521144144132"></p>
<h1 id="要看手机场景的命令"><a href="#要看手机场景的命令" class="headerlink" title="要看手机场景的命令"></a>要看手机场景的命令</h1><p>stats.UseMapPhoneInPC true</p>
<h1 id="LevelProxy改完之后要看什么"><a href="#LevelProxy改完之后要看什么" class="headerlink" title="LevelProxy改完之后要看什么"></a>LevelProxy改完之后要看什么</h1><p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250521210021655.png" srcset="/img/loading.gif" lazyload alt="image-20250521210021655"></p>
<p>看ArtData下面，每个这个Lod，点进去看看有没有什么奇怪的地方</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250521210052596.png" srcset="/img/loading.gif" lazyload alt="image-20250521210052596"></p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250521210057095.png" srcset="/img/loading.gif" lazyload alt="image-20250521210057095"></p>
<h1 id="东国探索活动"><a href="#东国探索活动" class="headerlink" title="东国探索活动"></a>东国探索活动</h1><p>用CommonQuestEvent里面的结构，这里之前是新手引导用的，</p>
<h2 id="前往"><a href="#前往" class="headerlink" title="前往"></a>前往</h2><p>这个之前已经有接口了</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">M:GoToSystem</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">local</span> TaskConfigData = DataMgr.StarterQuestDetail[<span class="hljs-built_in">self</span>.QuestId]<br>    PageJumpUtils:JumpToTargetPageByJumpId(TaskConfigData.JumpUIId)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h2 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h2><h1 id="ListView的一些注意事项"><a href="#ListView的一些注意事项" class="headerlink" title="ListView的一些注意事项"></a>ListView的一些注意事项</h1><p>ListView的Content可能会比显示的要多，所以通过GetDisplayEntryWidgets():Num()的index来用GetIndexAt()可能是有问题的，因为可能取到的是</p>
<p>想正确地取可以直接pairs来取</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> UIUtils.UtilsGetCurrentInputType() == ECommonInputType.Gamepad <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">for</span> i, Entry <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.Common_PolarityList_PC.List:GetDisplayedEntryWidgets()) <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">local</span> Item = <span class="hljs-built_in">self</span>.Common_PolarityList_PC.List:GetItemAt(i)<br>        <span class="hljs-keyword">if</span> Entry <span class="hljs-keyword">then</span><br>            Entry:SetNavigationRuleCustom(EUINavigation.Up, &#123;<span class="hljs-built_in">self</span>,<span class="hljs-built_in">self</span>.OnUIPolarityListNavigationMod&#125;)<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.needNavigation == <span class="hljs-literal">true</span> <span class="hljs-keyword">then</span><br>                Entry:SetNavigationRuleExplicit(EUINavigation.Down, <span class="hljs-built_in">self</span>.List_Select_Mod)<br>            <span class="hljs-keyword">else</span><br>                Entry:SetNavigationRuleBase(EUINavigation.Down, EUINavigationRule.Stop)<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">if</span> i == <span class="hljs-built_in">self</span>.Common_PolarityList_PC.List:GetDisplayedEntryWidgets():Num() <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">if</span> Entry <span class="hljs-keyword">then</span><br>                Entry:SetNavigationRuleBase(EUINavigation.Right, EUINavigationRule.Stop)<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>





<h1 id="看资产模型lod问题"><a href="#看资产模型lod问题" class="headerlink" title="看资产模型lod问题"></a>看资产模型lod问题</h1><p>全选所有静态模型，跑脚本，然后看lod1和lod2差距大不大</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250523111435520.png" srcset="/img/loading.gif" lazyload alt="image-20250523111435520"></p>
<p>然后这个脚本可能创建新的贴图，这个也要上传</p>
<h1 id="领奖活动"><a href="#领奖活动" class="headerlink" title="领奖活动"></a>领奖活动</h1><h2 id="条件如何判断"><a href="#条件如何判断" class="headerlink" title="条件如何判断"></a>条件如何判断</h2><p>应该是用这个</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ConditionUtils.CheckCondition</span><span class="hljs-params">(Avatar, ConditionIds, bShowFailed)</span></span><br></code></pre></td></tr></table></figure>

<h2 id="活动如何加红点？"><a href="#活动如何加红点？" class="headerlink" title="活动如何加红点？"></a>活动如何加红点？</h2><p>在ActivityUtils.lua里面</p>
<h1 id="神奇的函数调用方式"><a href="#神奇的函数调用方式" class="headerlink" title="神奇的函数调用方式"></a>神奇的函数调用方式</h1><p>最简单的是用点号和冒号调用，这个也很容理解</p>
<h2 id="动态函数调用"><a href="#动态函数调用" class="headerlink" title="动态函数调用"></a>动态函数调用</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ConditionUtils.CheckConditionInternal</span><span class="hljs-params">(Avatar, ConditionId, ConditionCheckId)</span></span><br>    <span class="hljs-keyword">local</span> ConditionInfo = DataMgr.Condition[ConditionId]<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ConditionInfo <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">local</span> Logic = <span class="hljs-built_in">string</span>.<span class="hljs-built_in">lower</span>(ConditionInfo.ConditionLogic)<br>    <span class="hljs-keyword">if</span> Logic == <span class="hljs-string">&quot;and&quot;</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">for</span> Condition, List <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(ConditionInfo.ConditionMap) <span class="hljs-keyword">do</span><br>            <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>, #List <span class="hljs-keyword">do</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ConditionUtils[<span class="hljs-string">&quot;Judge&quot;</span>..Condition](Avatar, List[i], ConditionCheckId) <span class="hljs-keyword">then</span><br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>                <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">elseif</span> Logic == <span class="hljs-string">&quot;or&quot;</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">for</span> Condition, List <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(ConditionInfo.ConditionMap) <span class="hljs-keyword">do</span><br>            <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>, #List <span class="hljs-keyword">do</span><br>                <span class="hljs-keyword">if</span> ConditionUtils[<span class="hljs-string">&quot;Judge&quot;</span>..Condition](Avatar, List[i], ConditionCheckId) <span class="hljs-keyword">then</span><br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>                <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">error</span>(<span class="hljs-string">&quot;UnExpected ConditionLogic: &quot;</span>..Logic)<br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这个地方ConditionUtils[“Judge”..Condition]就是调用下面的函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ConditionUtils:JudgePlayerLevelMin</span><span class="hljs-params">(Params)</span></span><br>    <span class="hljs-keyword">if</span> GWorld:IsSkynetServer() <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> IsDedicatedServer(GWorld.GameInstance) <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.Level &gt;= Params<br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h1 id="社区关注活动"><a href="#社区关注活动" class="headerlink" title="社区关注活动"></a>社区关注活动</h1><p>ServerInfo.Area</p>
<p>avatar.hostnum</p>
<p>是你的hostnum</p>
<p>然后去devserverlist下</p>
<p>找对应的area</p>
<p>可以知道你是哪个大区</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250605143412009.png" srcset="/img/loading.gif" lazyload alt="image-20250605143412009"></p>
<p>如何区分b服和官服</p>
<p>从avatar.channelid去判断</p>
<p>去commonconst.channels去查你的channel渠道</p>
<h1 id="东陆探索活动"><a href="#东陆探索活动" class="headerlink" title="东陆探索活动"></a>东陆探索活动</h1><p>需要新增一个跳转的页面</p>
<p>在InterfaceJump里面新增一个类型</p>
<p>然后在PageJumpUtils.lua的JumpToTargetPageByJumpId新增类型</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250606141557474.png" srcset="/img/loading.gif" lazyload alt="image-20250606141557474"></p>
<p>表的位置CommonQuestEvent</p>
<h1 id="通用活动结算界面"><a href="#通用活动结算界面" class="headerlink" title="通用活动结算界面"></a>通用活动结算界面</h1><p>退出和继续的接口</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">------------------------ 接收结算面板调用 -------------------------</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Component:ContinueDungeonSettlement</span><span class="hljs-params">(BattleInfo, Callback, TicketId, SquadId)</span></span><br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>:IsInDungeon() <span class="hljs-keyword">then</span><br>		<span class="hljs-built_in">self</span>:EnterDungeon(BattleInfo, <span class="hljs-literal">nil</span>, Callback, <span class="hljs-literal">nil</span>, TicketId, SquadId)<br>	<span class="hljs-keyword">elseif</span> <span class="hljs-built_in">self</span>:IsInHardBoss() <span class="hljs-keyword">then</span><br>		<span class="hljs-built_in">self</span>:EnterHardBoss(BattleInfo.HardBossId, BattleInfo.DifficultyId, Callback)<br>	<span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Component:ExitDungeonSettlement</span><span class="hljs-params">()</span></span><br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>:IsInDungeon() <span class="hljs-keyword">then</span><br>		<span class="hljs-built_in">self</span>:ExitDungeon()<br>	<span class="hljs-keyword">elseif</span> <span class="hljs-built_in">self</span>:IsInHardBoss() <span class="hljs-keyword">then</span><br>		<span class="hljs-built_in">self</span>:ExitHardBoss()<br>	<span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h1 id="推理获得线索接口"><a href="#推理获得线索接口" class="headerlink" title="推理获得线索接口"></a>推理获得线索接口</h1><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--解锁推理线索RPC</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Component:DetectiveQuestionUnlockAnswer</span><span class="hljs-params">(Answer)</span></span><br>    DebugPrint(<span class="hljs-string">&quot;DetectiveQuestionUnlockAnswer&quot;</span>, Answer)<br>    <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Cb</span><span class="hljs-params">(ErrCode)</span></span><br>        DebugPrint(<span class="hljs-string">&quot;DetectiveQuestionUnlockAnswer Cb&quot;</span>,ErrorCode:Name(ErrCode))<br>        <span class="hljs-keyword">if</span> ErrCode == <span class="hljs-number">0</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">local</span> DetectiveMinigameUI = UIManager(<span class="hljs-built_in">self</span>):GetUIObj(<span class="hljs-string">&quot;DetectiveMinigame&quot;</span>)<br>            <span class="hljs-keyword">local</span> ItemInformationUI = UIManager(<span class="hljs-built_in">self</span>):GetUIObj(<span class="hljs-string">&quot;ItemInformation&quot;</span>)<br>            <span class="hljs-comment">-- 推理界面没开的时候跳tips，推理界面内获得的线索在推理界面内处理</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> DetectiveMinigameUI <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> ItemInformationUI <span class="hljs-keyword">then</span><br>                UIManager(<span class="hljs-built_in">self</span>):LoadUINew(<span class="hljs-string">&quot;DetectiveMinigameTips&quot;</span>, Answer)<br>            <span class="hljs-keyword">end</span><br>            <span class="hljs-comment">-- 任务节点用Callback</span><br>            <span class="hljs-built_in">self</span>:DoAnswerTaskNodeCallback(Answer)<br><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ReddotManager.GetTreeNode(<span class="hljs-string">&quot;DetectiveAnswer&quot;</span>) <span class="hljs-keyword">then</span><br>                ReddotManager.AddNode(<span class="hljs-string">&quot;DetectiveAnswer&quot;</span>)<br>            <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">local</span> CacheKey = Answer<br>            <span class="hljs-keyword">local</span> CacheDetail = ReddotManager.GetLeafNodeCacheDetail(<span class="hljs-string">&quot;DetectiveAnswer&quot;</span>)<br>            <span class="hljs-keyword">if</span> CacheDetail <span class="hljs-keyword">then</span><br>                <span class="hljs-keyword">if</span> CacheDetail[CacheKey] == <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span><br>                    CacheDetail[CacheKey] = <span class="hljs-literal">true</span><br>                    ReddotManager.IncreaceLeafNodeCount(<span class="hljs-string">&quot;DetectiveAnswer&quot;</span>)<br>                <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>:CallServer(<span class="hljs-string">&quot;RpcDetectiveQuestionUnlockAnswer&quot;</span>,Cb,Answer)<br><br>    <span class="hljs-comment">-- 在这儿弹新线索</span><br>    EventManager:FireEvent(EventID.OnHomeBaseeBtnShowNewClue, <span class="hljs-string">&quot;TaskPanel&quot;</span>)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<h1 id="条件断点如何断FString"><a href="#条件断点如何断FString" class="headerlink" title="条件断点如何断FString"></a>条件断点如何断FString</h1><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">wcscmp((TCHAR*)Str1.Data.AllocatorInstance.Data,L<span class="hljs-string">&quot;Str2&quot;</span>)==<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p>Str1是被比较的字符串变量，”Str2”是字符串常量，替换成你想要比较的值</p>
<h1 id="ListView通过代码更改子Item的类型"><a href="#ListView通过代码更改子Item的类型" class="headerlink" title="ListView通过代码更改子Item的类型"></a>ListView通过代码更改子Item的类型</h1><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> ItemClass = LoadClass(<span class="hljs-string">&quot;WidgetBlueprint&#x27;/Game/UI/WBP/Activity/Widget/Settlement/WBP_Activity_Settlement_ScoreItem_2.WBP_Activity_Settlement_ScoreItem_2&#x27;&quot;</span>)<br><span class="hljs-keyword">if</span> ItemClass <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">self</span>.List_ScoreItem.EntryWidgetClass = ItemClass<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<h1 id="NPC交互图标是怎么改的"><a href="#NPC交互图标是怎么改的" class="headerlink" title="NPC交互图标是怎么改的"></a>NPC交互图标是怎么改的</h1><p>首先，stl有一个行为可以刷新静态点，ChangeStaticCreatorNode，然后静态刷新点，可以配置刷新出来的Actor是什么，这个就是NPC上面的， 具体就可以看NPC.xlsx里面了，然后NPC上面有一个交互组件：BP_NpcTalkInteractiveComponent_C，初始化代码如下</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BP_NpcTalkInteractiveComponent_C:Init</span><span class="hljs-params">()</span></span><br>    <span class="hljs-built_in">self</span>.bIsInit = <span class="hljs-literal">true</span><br>    <span class="hljs-built_in">self</span>:SetInteractiveName(<span class="hljs-built_in">self</span>.Owner.NpcData.UnitName)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.Owner.NpcData.CommonUIConfirmID <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>:InitCommonUIConfirmID(<span class="hljs-built_in">self</span>.Owner.NpcData.CommonUIConfirmID)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.InteractiveTag = <span class="hljs-string">&quot;Interactive&quot;</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这里是改变这个Component的CommonUIConfirmID</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BP_InteractiveBaseComponent_C:InitCommonUIConfirmID</span><span class="hljs-params">(CommonUIConfirmID)</span></span><br>	<span class="hljs-built_in">self</span>.CommonUIConfirmID = CommonUIConfirmID<br>	<span class="hljs-keyword">local</span> Data = DataMgr.CommonUIConfirm[CommonUIConfirmID]<br>	<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Data <span class="hljs-keyword">then</span><br>		<span class="hljs-keyword">return</span><br>	<span class="hljs-keyword">end</span><br>	<span class="hljs-built_in">self</span>.InteractiveDistance = Data.InteractiveRadius <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.InteractiveDistance<br>	<span class="hljs-built_in">self</span>.InteractiveAngle = Data.InteractiveAngle <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.InteractiveAngle<br>	<span class="hljs-built_in">self</span>.InteractiveFaceAngle = Data.PlayerFaceAngle <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.InteractiveFaceAngle<br>	<span class="hljs-built_in">self</span>.ListPriority = Data.InteractivePriority <span class="hljs-keyword">or</span> <span class="hljs-number">0</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>因为拿Icon是根据这个拿的</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--- 根据配置的ID获取Icon，有特殊需求的在子类中重写</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BP_InteractiveBaseComponent_C:GetInteractiveIcon</span><span class="hljs-params">(PlayerActor)</span></span><br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>:IsLocked() <span class="hljs-keyword">then</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Texture2D&#x27;/Game/UI/Texture/Dynamic/Atlas/Interactive/T_Interactive_Lock.T_Interactive_Lock&#x27;&quot;</span><br>	<span class="hljs-keyword">end</span><br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>:IsForbidden(PlayerActor) <span class="hljs-keyword">then</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Texture2D&#x27;/Game/UI/Texture/Dynamic/Atlas/Interactive/T_Interactive_Forbidden.T_Interactive_Forbidden&#x27;&quot;</span><br>	<span class="hljs-keyword">end</span><br>	<span class="hljs-keyword">local</span> Data = DataMgr.CommonUIConfirm[<span class="hljs-built_in">self</span>.CommonUIConfirmID]<br>	<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Data <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> Data.Icon <span class="hljs-keyword">then</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>	<span class="hljs-keyword">end</span><br>	<span class="hljs-keyword">return</span> Data.Icon<br>    <span class="hljs-comment">-- local ImageResource = LoadObject(Data.Icon)</span><br>    <span class="hljs-comment">-- return ImageResource</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>所以只要在NPC表新增一列就可以了，不过这个只有NPC对话组件能用，其他的等以后有需求再说</p>
<p>后续：大佬们觉得这个改动有点大，就不动了， 所以策划直接改生成的NPC类型就可以了，太好了</p>
<h1 id="新增一种通用Tab类型"><a href="#新增一种通用Tab类型" class="headerlink" title="新增一种通用Tab类型"></a>新增一种通用Tab类型</h1><p>复制WBP_Com_Tab_P_C.lua和WBP_Com_Tab_M_C.lua</p>
<p>很多换一下名字就好了</p>
<p>然后聊天直接全部注释了，为了以防万一他们之后要加聊天，Group_Chat相关</p>
<p>然后没有切换的快捷键了，这个只能点击，没有qe和手柄的快捷键，手柄也全凭虚拟光标，这个的影响是先把Key_Left和Key_Right相关的删了，然后还要删keydown吧</p>
<p>阵容配置肯定是没了，Entrance_Build</p>
<h1 id="手柄聚焦SetFocus和SetUserFocus"><a href="#手柄聚焦SetFocus和SetUserFocus" class="headerlink" title="手柄聚焦SetFocus和SetUserFocus"></a>手柄聚焦SetFocus和SetUserFocus</h1><ol>
<li><h1 id="聚焦的相关接口"><a href="#聚焦的相关接口" class="headerlink" title="聚焦的相关接口"></a>聚焦的相关接口</h1></li>
</ol>
<p>聚焦到某个控件:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-variable language_">self</span>.<span class="hljs-title class_">Btn</span><span class="hljs-symbol">:SetFocus</span>()<br></code></pre></td></tr></table></figure>

<p>或者在处理输入事件时返回<code>SetUserFocus</code>回复（建议使用此方法设置聚焦）。</p>
<p>由于<code>SetUserFocus</code>第一个参数是引用，传进去的值可能被修改，因此尽量传用新构造的事件回复</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Plain">正确的用法：<br>function M:OnKeyDown(MyGeometry, InKeyEvent)<br>    return UWidgetBlueprintLibrary.SetUserFocus(UWidgetBlueprintLibrary.Handled(),self.Btn)<br>end<br><br>错误的用法，这种写法会导致后面使用self.Handled时出现意料之外的情况：<br>function M:OnKeyDown(MyGeometry, InKeyEvent)<br>    return UWidgetBlueprintLibrary.SetUserFocus(self.Handled,self.Btn)<br>end<br></code></pre></td></tr></table></figure>

<p><strong>Q:</strong><code>SetFocus</code>和 <code>SetUserFocus</code>有什么区别？</p>
<p>**A:**功能上没有区别，区别在于程序设计思路。<code>SetFocus</code>可以在任意位置调用，过于自由，如果使用者滥用<code>SetFocus</code>很容易造成抢聚焦的情况。一个经典的场景：A界面在B界面的下层，由于某些事件导致A界面数据刷新，而A的刷新逻辑里使用了<code>SetFocus</code>。而<code>SetUserFocus</code>基本不会出现这种情况，因为它只能在输入事件里作为返回值调用，可以保证每次聚焦变化必定跟随在一次输入之后，又由于没有聚焦的控件一般不会接受到输入事件，从而可以在程序设计阶段就避免抢聚焦的问题。</p>
<h1 id="武器密券活动模板"><a href="#武器密券活动模板" class="headerlink" title="武器密券活动模板"></a>武器密券活动模板</h1><p>用了之前的条件领奖</p>
<p>打开预览界面</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lua">UIManager(<span class="hljs-built_in">self</span>):LoadUINew(<span class="hljs-string">&quot;ArmoryDetail&quot;</span>,&#123;PreviewCharIds = &#123;CharId&#125;,<br>                                            bHideCharAppearance = <span class="hljs-literal">true</span>,<br>                                            bHideWeaponAppearance = <span class="hljs-literal">true</span>,<br>                                            EPreviewSceneType = CommonConst.EPreviewSceneType.PersonInfo,<br>                                            OnCloseDelegate = <span class="hljs-literal">nil</span>&#125;)<br></code></pre></td></tr></table></figure>



<h1 id="listview填充空态"><a href="#listview填充空态" class="headerlink" title="listview填充空态"></a>listview填充空态</h1><p> <strong>2025&#x2F;01&#x2F;22更新  EMListView和EMTileView集成了空态填充接口，可以傻瓜式接入，以下是新接口的使用步骤：</strong></p>
<ol>
<li><strong>你需要在界面Construct函数里先绑定委托，给列表获取空态的Content，（注意需要在Destruct里Unbind该委托）</strong></li>
</ol>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/asynccode" srcset="/img/loading.gif" lazyload alt="img"></p>
<ol>
<li><strong>在你的列表填充完数据的代码之后来一句 RequestFillEmptyContent，就能无脑实现空态填充了</strong></li>
</ol>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/asynccode" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>如果是通用道具框，jiu这样写Content</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">Content.Id = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>





<h1 id="mod系统手柄优化"><a href="#mod系统手柄优化" class="headerlink" title="mod系统手柄优化"></a>mod系统手柄优化</h1><p>现在主要的改变就是进去会自动选中这个mod，但这个选中只是右边有提示，真正开始选还是要按A，然后进入选中态之后这里显然是要变的</p>
<p>这里要改的是上下两个mod的选中逻辑</p>
<p>Armory_Mod_C.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 手柄有额外逻辑</span><br>ArmoryMod:HandleGamepadModSelection(Content)<br></code></pre></td></tr></table></figure>

<p>Armory_Mod_Slot_C.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 手柄有额外逻辑</span><br><span class="hljs-keyword">if</span> (UIUtils.UtilsGetCurrentInputType() == ECommonInputType.Gamepad) <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">if</span> ModModel:IsInPolarityEditMode() <span class="hljs-keyword">or</span> ModModel:IsModUIPreview() <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span> Handled<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">local</span> GamePadSelectedStuff = ModModel:GetGamePadSelectedStuff()<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> GamePadSelectedStuff <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> GamePadSelectedStuff.ModUuid) <span class="hljs-keyword">then</span><br>        ModModel:SetGamePadSelectedStuff(<span class="hljs-built_in">self</span>.SlotUIData.ModEid, <span class="hljs-built_in">self</span>.SlotUIData.SlotId)<br>        <span class="hljs-keyword">local</span> Item = <span class="hljs-built_in">self</span>.Parent.List_Select_Mod:GetItemAt(<span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">self</span>.Parent.List_Select_Mod:BP_SetSelectedItem(Item)<br>        Item.UI:SetFocus()<br>    <span class="hljs-keyword">elseif</span> (GamePadSelectedStuff.ModUuid) <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">if</span> (GamePadSelectedStuff.SlotId) <span class="hljs-keyword">then</span><br>            ModController:SendExchangeMod(ModModel:GetTarget(), GamePadSelectedStuff.SlotId, <span class="hljs-built_in">self</span>.SlotUIData.SlotId)<br>        <span class="hljs-keyword">else</span><br>            ModController:SendChangeMod(ModModel:GetTarget(), <span class="hljs-built_in">self</span>.SlotUIData.SlotId, GamePadSelectedStuff.ModUuid)<br>        <span class="hljs-keyword">end</span><br>        ModModel:SetGamePadSelectedStuff(<span class="hljs-literal">nil</span>,<span class="hljs-literal">nil</span>)<br>        <span class="hljs-built_in">self</span>.Parent:RecoverFromGamepad()<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<p>然后这里需要根据是否选中了mod，在mouseenter的时候有不同的逻辑，这个之前也有类似的，因为我选中的时候会设置一下SetGamePadSelectedStuff</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 先判断一下是不是选中mod的状态</span><br><span class="hljs-keyword">if</span>(ModModel:GetGamePadSelectedStuff()) <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">if</span> (InKeyName == <span class="hljs-string">&quot;Gamepad_FaceButton_Top&quot;</span>) <span class="hljs-keyword">then</span> <span class="hljs-comment">-- Y键</span><br>        ModController:OpenModIntensify()<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">elseif</span> (InKeyName == <span class="hljs-string">&quot;Gamepad_FaceButton_Left&quot;</span>) <span class="hljs-keyword">then</span> <span class="hljs-comment">-- X键</span><br>        <span class="hljs-keyword">local</span> EquipedSlotId = ModModel:GetSelectStuff().SlotId<br>        <span class="hljs-keyword">if</span> EquipedSlotId <span class="hljs-keyword">then</span><br>            ModController:SendTakeOffMod(ModModel:GetTarget(), EquipedSlotId)<br>        <span class="hljs-keyword">else</span><br>            ModController:QuickEquipMod(ModModel:GetSelectStuff().ModUuid)<br>        <span class="hljs-keyword">end</span><br>        ModModel:SetGamePadSelectedStuff(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">elseif</span> (InKeyName == <span class="hljs-string">&quot;Gamepad_FaceButton_Right&quot;</span> ) <span class="hljs-keyword">then</span> <span class="hljs-comment">-- B键</span><br>        <span class="hljs-built_in">self</span>:RecoverFromGamepad()<br>        ModModel:SetGamePadSelectedStuff(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>)<br>        ModController:SetSelectedStuff(<span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h1 id="ListView初始化逻辑"><a href="#ListView初始化逻辑" class="headerlink" title="ListView初始化逻辑"></a>ListView初始化逻辑</h1><p>道具框导航逻辑最好还是写在各自界面里，列表项写在OnEntryInitialized会灵活点</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">self</span>.List_Select_Mod.BP_OnEntryInitialized:Add(<span class="hljs-built_in">self</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self, Content, Entry)</span></span><br>    <span class="hljs-keyword">if</span> Content.bAutoFocusForMod <span class="hljs-keyword">then</span><br>        Entry:SetFocus()<br>        Content.bAutoFocusForMod = <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">end</span><br>    Entry:SetNavigationRuleCustom(EUINavigation.Up, &#123;<span class="hljs-built_in">self</span>,<span class="hljs-built_in">self</span>.OnListModNavigationMod&#125;)<br><span class="hljs-keyword">end</span>)<br></code></pre></td></tr></table></figure>

<p>这个函数listview每个content都会执行</p>
<h1 id="剧院活动"><a href="#剧院活动" class="headerlink" title="剧院活动"></a>剧院活动</h1><p>这个列表展开怎么做，可以参考宠物升级</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs lua">```<br><br>每轮活动半个小时开一轮，直接本地算<br><br><br><br># 报错处理<br><br>## lua的变量不要用全局，要用<span class="hljs-keyword">local</span><br><br>## 构造函数中不要使用虚函数<br><br>Calling the <span class="hljs-string">&#x27;SetCollisionEnabled&#x27;</span> virtual <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">in</span> <span class="hljs-title">the</span> <span class="hljs-title">constructor</span> <span class="hljs-title">may</span> <span class="hljs-title">lead</span> <span class="hljs-title">to</span> <span class="hljs-title">unexpected</span> <span class="hljs-title">result</span> <span class="hljs-title">at</span> <span class="hljs-title">runtime</span>.</span><br><span class="hljs-function"></span><br><span class="hljs-function"></span><br><span class="hljs-function"></span><br><span class="hljs-function"></span><br><span class="hljs-function"></span><br><span class="hljs-function">这个是因为在<span class="hljs-title">UE</span>中，构造函数执行时对象可能还没有完全初始化，调用虚函数可能不安全，之前是这样写的</span><br><span class="hljs-function"></span><br><span class="hljs-function">```<span class="hljs-title">cpp</span></span><br><span class="hljs-function"><span class="hljs-title">URegionOnlineInterInviteTeamComp</span>::<span class="hljs-title">URegionOnlineInterInviteTeamComp</span><span class="hljs-params">()</span></span><br>&#123;<br>	PrimaryComponentTick.bCanEverTick = <span class="hljs-literal">false</span>;<br>	SphereRadius = <span class="hljs-number">50.</span>f;<br>    	UPrimitiveComponent::SetCollisionProfileName(TEXT(<span class="hljs-string">&quot;Interactive&quot;</span>));<br>	SetCollisionEnabled(ECollisionEnabled::NoCollision);<br>&#125;<br></code></pre></td></tr></table></figure>



<p>现在把他放在BeginPlay里面</p>
<p>头文件也要对应的修改</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EM_API</span> URegionOnlineInterInviteTeamComp : <span class="hljs-keyword">public</span> UInteractiveBaseComponent, <span class="hljs-keyword">public</span> IUnLuaInterface<br>&#123;<br>	<span class="hljs-built_in">GENERATED_BODY</span>()<br><br>	<span class="hljs-built_in">URegionOnlineInterInviteTeamComp</span>();<br>	<span class="hljs-function"><span class="hljs-keyword">virtual</span> FString <span class="hljs-title">GetModuleName_Implementation</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-built_in">FString</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;BluePrints.Story.Interactive.InteractiveComponent.BP_RegionOnlineInterInviteTeamComponent_C&quot;</span>)); &#125;;<br><span class="hljs-keyword">protected</span>:<br>	<span class="hljs-comment">// Called when the game starts or when spawned</span><br>	<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">BeginPlay</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure>



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp">URegionOnlineInterInviteTeamComp::<span class="hljs-built_in">URegionOnlineInterInviteTeamComp</span>()<br>&#123;<br>	PrimaryComponentTick.bCanEverTick = <span class="hljs-literal">false</span>;<br>	SphereRadius = <span class="hljs-number">50.f</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">URegionOnlineInterInviteTeamComp::BeginPlay</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	UPrimitiveComponent::<span class="hljs-built_in">SetCollisionProfileName</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Interactive&quot;</span>));<br>	<span class="hljs-built_in">SetCollisionEnabled</span>(ECollisionEnabled::NoCollision);<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="手柄端虚拟光标导致聚焦bug"><a href="#手柄端虚拟光标导致聚焦bug" class="headerlink" title="手柄端虚拟光标导致聚焦bug"></a>手柄端虚拟光标导致聚焦bug</h1><p>现在手柄端会有一个默认的虚拟光标聚焦到中间，导致会有hover，可以看看是否可以通过改变位置来解决这个问题</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FSlateApplication::UsePlatformCursorForCursorUser</span><span class="hljs-params">(<span class="hljs-type">bool</span> bUsePlatformCursor)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (TSharedPtr&lt;FSlateUser&gt; SlateUser = <span class="hljs-built_in">GetUser</span>(CursorUserIndex))<br>    &#123;<br>        <span class="hljs-type">bool</span> bIsUsingPlatformCursor = SlateUser-&gt;<span class="hljs-built_in">GetCursor</span>() == PlatformApplication-&gt;Cursor;<br><br>        <span class="hljs-keyword">if</span> (bIsUsingPlatformCursor != bUsePlatformCursor)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (PlatformApplication &amp;&amp; PlatformApplication-&gt;Cursor)<br>            &#123;<br>                SlateUser-&gt;<span class="hljs-built_in">OverrideCursor</span>(bUsePlatformCursor ? PlatformApplication-&gt;Cursor : <span class="hljs-built_in">MakeShared</span>&lt;FFauxSlateCursor&gt;());<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FSlateApplication::SetPlatformCursorVisibility</span><span class="hljs-params">(<span class="hljs-type">bool</span> bNewVisibility)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (PlatformApplication &amp;&amp; PlatformApplication-&gt;Cursor)<br>    &#123;<br>        PlatformApplication-&gt;Cursor-&gt;<span class="hljs-built_in">SetType</span>(bNewVisibility ? EMouseCursor::Default : EMouseCursor::None);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="获得属性计算"><a href="#获得属性计算" class="headerlink" title="获得属性计算"></a>获得属性计算</h1><p>在character.lua里面</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Char:DumpDefaultBattleAttr</span><span class="hljs-params">(Avatar, ExtraInfo)</span></span><br>	ExtraInfo = ExtraInfo <span class="hljs-keyword">or</span> &#123;&#125;<br>	ExtraInfo.ModSuit = <span class="hljs-built_in">self</span>.ModSuitIndex<br>	AvatarUtils:InitModInfo(Avatar, ExtraInfo,<span class="hljs-built_in">self</span>)<br>	<span class="hljs-keyword">local</span> BattleAttrs = <span class="hljs-built_in">self</span>:DumpBattleAttr(Avatar, ExtraInfo)<br>	<span class="hljs-keyword">return</span> BattleAttrs<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>繁重的计算在DumpBattleAttr，可以传各种参数</p>
<h1 id="富文本响应不同手柄来显示不同的手柄图标"><a href="#富文本响应不同手柄来显示不同的手柄图标" class="headerlink" title="富文本响应不同手柄来显示不同的手柄图标"></a>富文本响应不同手柄来显示不同的手柄图标</h1><p>先看一下富文本的SetText逻辑</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SRichTextBlock::SetText</span><span class="hljs-params">(<span class="hljs-type">const</span> TAttribute&lt;FText&gt;&amp; InTextAttr)</span></span><br><span class="hljs-function"></span>&#123;<br>    BoundText = InTextAttr;<br>    <span class="hljs-built_in">Invalidate</span>(EInvalidateWidget::LayoutAndVolatility);<br>    <span class="hljs-built_in">InvalidatePrepass</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先会更新BoudText，然后下面InValidate里面会打上脏标记，下一帧会更新</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">FastPathProxyHandle.<span class="hljs-built_in">MarkWidgetDirty</span>(InvalidateReason);<br></code></pre></td></tr></table></figure>

<p>在这个里面会进行文本的更新</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">FVector2D <span class="hljs-title">SRichTextBlock::ComputeDesiredSize</span><span class="hljs-params">(<span class="hljs-type">float</span> LayoutScaleMultiplier)</span> <span class="hljs-type">const</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// ComputeDesiredSize will also update the text layout cache if required</span><br>    <span class="hljs-type">const</span> FVector2D TextSize = TextLayoutCache-&gt;<span class="hljs-built_in">ComputeDesiredSize</span>(<br>                                   FSlateTextBlockLayout::<span class="hljs-built_in">FWidgetArgs</span>(BoundText, HighlightText, WrapTextAt, AutoWrapText, WrappingPolicy, TransformPolicy, Margin, LineHeightPercentage, Justification),<br>                                   LayoutScaleMultiplier * TextBlockScale, TextStyle) *<br>                               TextBlockScale;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">FVector2D</span>(FMath::<span class="hljs-built_in">Max</span>(TextSize.X, MinDesiredWidth.<span class="hljs-built_in">Get</span>()), TextSize.Y);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里面会遍历富文本上面的Decorator，如果Support返回的是true，那么就会拿对应的图片</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">TSharedPtr&lt;ITextDecorator&gt; <span class="hljs-title">FRichTextLayoutMarshaller::TryGetDecorator</span><span class="hljs-params">(<span class="hljs-type">const</span> FString&amp; Line, <span class="hljs-type">const</span> FTextRunParseResults&amp; TextRun)</span> <span class="hljs-type">const</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> DecoratorIter = InlineDecorators.<span class="hljs-built_in">CreateConstIterator</span>(); DecoratorIter; ++DecoratorIter)<br>    &#123;<br>        <span class="hljs-keyword">if</span> ((*DecoratorIter)-&gt;<span class="hljs-built_in">Supports</span>(TextRun, Line))<br>        &#123;<br>            <span class="hljs-keyword">return</span> *DecoratorIter;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> DecoratorIter = Decorators.<span class="hljs-built_in">CreateConstIterator</span>(); DecoratorIter; ++DecoratorIter)<br>    &#123;<br>        <span class="hljs-keyword">if</span> ((*DecoratorIter)-&gt;<span class="hljs-built_in">Supports</span>(TextRun, Line))<br>        &#123;<br>            <span class="hljs-keyword">return</span> *DecoratorIter;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>所以只需要改这个Support函数就可以了，给这个装饰器加一个属性，之前这个装饰器的Support逻辑就是只看能不能拿到对应id的图片，现在要加一个判断</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">Supports</span><span class="hljs-params">(<span class="hljs-type">const</span> FTextRunParseResults&amp; RunParseResult, <span class="hljs-type">const</span> FString&amp; Text)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (RunParseResult.Name == <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;img&quot;</span>) &amp;&amp; RunParseResult.MetaData.<span class="hljs-built_in">Contains</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;id&quot;</span>)))<br>    &#123;<br>        <span class="hljs-type">const</span> FTextRange&amp; IdRange = RunParseResult.MetaData[<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;id&quot;</span>)];<br>        <span class="hljs-type">const</span> FString TagId       = Text.<span class="hljs-built_in">Mid</span>(IdRange.BeginIndex, IdRange.EndIndex - IdRange.BeginIndex);<br><br>        <span class="hljs-comment">// 检查是否指定了platform属性</span><br>        <span class="hljs-keyword">if</span> (RunParseResult.MetaData.<span class="hljs-built_in">Contains</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;platform&quot;</span>)))<br>        &#123;<br>            <span class="hljs-type">const</span> FTextRange&amp; PlatformRange = RunParseResult.MetaData[<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;platform&quot;</span>)];<br>            <span class="hljs-type">const</span> FString PlatformName = Text.<span class="hljs-built_in">Mid</span>(PlatformRange.BeginIndex, PlatformRange.EndIndex - PlatformRange.BeginIndex);<br>            <br>            <span class="hljs-comment">// 如果此装饰器指定了Platforms，则检查是否匹配</span><br>            <span class="hljs-keyword">if</span> (Decorator &amp;&amp; Decorator-&gt;Platforms.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                <span class="hljs-comment">// 支持多个平台值（数组形式）</span><br>                <span class="hljs-type">bool</span> bPlatformMatched = <span class="hljs-literal">false</span>;<br>                <br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> FString&amp; SupportedPlatform : Decorator-&gt;Platforms)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (PlatformName.<span class="hljs-built_in">Equals</span>(SupportedPlatform.<span class="hljs-built_in">TrimStartAndEnd</span>(), ESearchCase::IgnoreCase))<br>                    &#123;<br>                        bPlatformMatched = <span class="hljs-literal">true</span>;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>                <br>                <span class="hljs-comment">// 如果指定的平台与装饰器的平台不匹配，则不支持</span><br>                <span class="hljs-keyword">if</span> (!bPlatformMatched)<br>                &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// 如果装饰器没有指定Platforms，则支持所有平台</span><br>        &#125;<br>        <span class="hljs-comment">// 如果没有指定platform属性，则按原来的逻辑处理</span><br><br>        <span class="hljs-type">const</span> <span class="hljs-type">bool</span> bWarnIfMissing = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span> Decorator-&gt;<span class="hljs-built_in">FindImageBrush</span>(*TagId, bWarnIfMissing) != <span class="hljs-literal">nullptr</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/*</span><br><span class="hljs-comment">使用示例：</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">1. 在蓝图中配置装饰器：</span><br><span class="hljs-comment">   - 创建两个 URichTextBlockImageDecorator 子类的蓝图实例</span><br><span class="hljs-comment">   - 第一个实例：设置 Platform = &quot;ps5&quot;，ImageSet = PS5手柄图标数据表</span><br><span class="hljs-comment">   - 第二个实例：设置 Platform = &quot;xbox&quot;，ImageSet = XBOX手柄图标数据表</span><br><span class="hljs-comment">   - 将两个装饰器都添加到 RichTextBlock 的 DecoratorClasses 数组中</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">2. 在富文本中使用带platform属性的img标签：</span><br><span class="hljs-comment">   &lt;img id=&quot;Gamepad_FaceButton_Top&quot; platform=&quot;ps5&quot;&gt;  // 只在PS5装饰器时显示</span><br><span class="hljs-comment">   &lt;img id=&quot;Gamepad_FaceButton_Top&quot; platform=&quot;xbox&quot;&gt; // 只在XBOX装饰器时显示</span><br><span class="hljs-comment">   &lt;img id=&quot;Gamepad_FaceButton_Top&quot;&gt;                 // 不指定platform时，所有装饰器都尝试处理</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">3. 检测逻辑：</span><br><span class="hljs-comment">   - 如果指定了platform属性，会检查装饰器的Platform设置是否匹配</span><br><span class="hljs-comment">   - 如果匹配，则使用该装饰器渲染图片</span><br><span class="hljs-comment">   - 如果不匹配，则跳过该装饰器，尝试下一个装饰器</span><br><span class="hljs-comment">   - 如果装饰器的Platform为空，则支持所有平台</span><br><span class="hljs-comment">   - 如果没有指定platform属性，则按原来的逻辑处理</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">4. 优势：</span><br><span class="hljs-comment">   - 可以在蓝图中直接配置每个装饰器支持的平台</span><br><span class="hljs-comment">   - 不需要在代码中动态设置平台</span><br><span class="hljs-comment">   - 更清晰的配置管理</span><br><span class="hljs-comment">   - 支持多个装饰器同时存在，每个处理不同的平台</span><br><span class="hljs-comment">   - 不依赖外部系统，更稳定可靠</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>

<h1 id="新加一个padding的listview导航方式"><a href="#新加一个padding的listview导航方式" class="headerlink" title="新加一个padding的listview导航方式"></a>新加一个padding的listview导航方式</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">UFUNCTION</span>(BlueprintCallable)<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">NavigateToItemWithPadding</span><span class="hljs-params">(UObject* Item, <span class="hljs-type">float</span> Padding)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span> (Item &amp;&amp; MyListView.<span class="hljs-built_in">IsValid</span>())<br>	&#123;<br>		<span class="hljs-comment">// 获取Item在列表中的索引</span><br>		<span class="hljs-type">const</span> int32 IndexOfItem = ListItems.<span class="hljs-built_in">Find</span>(Item);<br>		<span class="hljs-keyword">if</span> (IndexOfItem != INDEX_NONE)<br>		&#123;<br>			<span class="hljs-comment">// 获取当前可见的Widget数量</span><br>			<span class="hljs-type">const</span> TArray&lt;UUserWidget*&gt;&amp; DisplayedWidgets = <span class="hljs-built_in">GetDisplayedEntryWidgets</span>();<br>			<span class="hljs-type">float</span> NumLiveWidgets = <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">float</span>&gt;(DisplayedWidgets.<span class="hljs-built_in">Num</span>());<br>			<span class="hljs-keyword">if</span> (NumLiveWidgets == <span class="hljs-number">0.0f</span>)<br>			&#123;<br>				<span class="hljs-comment">// 如果没有可见的Widget，使用估计值</span><br>				NumLiveWidgets = <span class="hljs-number">5.0f</span>; <span class="hljs-comment">// 默认估计值</span><br>			&#125;<br><br>			<span class="hljs-comment">// 计算新的滚动偏移量，考虑Padding</span><br>			<span class="hljs-type">double</span> NewScrollOffset = IndexOfItem;<br><br>			<span class="hljs-comment">// 将Item居中显示，并减去Padding的影响</span><br>			NewScrollOffset -= (NumLiveWidgets / <span class="hljs-number">2</span>);<br><br>			<span class="hljs-comment">// 应用Padding（将Padding转换为项目偏移量）</span><br>			<span class="hljs-keyword">if</span> (Padding &gt; <span class="hljs-number">0.0f</span>)<br>			&#123;<br>				<span class="hljs-comment">// 获取Item的高度，将Padding转换为项目偏移量</span><br>				<span class="hljs-type">float</span> ItemHeight = <span class="hljs-number">0.0f</span>;<br>				<span class="hljs-keyword">if</span> (DisplayedWidgets.<span class="hljs-built_in">Num</span>() &gt; <span class="hljs-number">0</span>)<br>				&#123;<br>					<span class="hljs-comment">// 使用第一个显示的条目来获取高度</span><br>					UUserWidget* FirstWidget = DisplayedWidgets[<span class="hljs-number">0</span>];<br>					<span class="hljs-keyword">if</span> (FirstWidget &amp;&amp; FirstWidget-&gt;<span class="hljs-built_in">GetCachedWidget</span>().<span class="hljs-built_in">IsValid</span>())<br>					&#123;<br>						<span class="hljs-type">const</span> FGeometry&amp; WidgetGeometry = FirstWidget-&gt;<span class="hljs-built_in">GetCachedWidget</span>()-&gt;<span class="hljs-built_in">GetCachedGeometry</span>();<br>						ItemHeight = WidgetGeometry.<span class="hljs-built_in">GetLocalSize</span>().Y;<br>					&#125;<br>				&#125;<br><br>				<span class="hljs-comment">// 如果无法获取高度，使用默认值</span><br>				<span class="hljs-keyword">if</span> (ItemHeight &lt;= <span class="hljs-number">0.0f</span>)<br>				&#123;<br>					ItemHeight = <span class="hljs-number">50.0f</span>; <span class="hljs-comment">// 默认高度</span><br>				&#125;<br><br>				<span class="hljs-type">const</span> <span class="hljs-type">double</span> PaddingOffset = Padding / ItemHeight;<br>				NewScrollOffset -= PaddingOffset;<br>			&#125;<br><br>			<span class="hljs-comment">// 限制偏移量在有效范围内</span><br>			<span class="hljs-type">const</span> <span class="hljs-type">double</span> MaxScrollOffset = FMath::<span class="hljs-built_in">Max</span>(<span class="hljs-number">0.0</span>, <span class="hljs-built_in">static_cast</span>&lt;<span class="hljs-type">double</span>&gt;(ListItems.<span class="hljs-built_in">Num</span>()) - NumLiveWidgets);<br>			NewScrollOffset = FMath::<span class="hljs-built_in">Clamp</span>&lt;<span class="hljs-type">double</span>&gt;(NewScrollOffset, <span class="hljs-number">0.0</span>, MaxScrollOffset);<br><br>			<span class="hljs-comment">// 设置滚动偏移量</span><br>			MyListView-&gt;<span class="hljs-built_in">SetScrollOffset</span>(NewScrollOffset);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="UnrealInsights看不到对应的Tracks"><a href="#UnrealInsights看不到对应的Tracks" class="headerlink" title="UnrealInsights看不到对应的Tracks"></a>UnrealInsights看不到对应的Tracks</h1><p>需要把这个打开</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250807145225040.png" srcset="/img/loading.gif" lazyload alt="image-20250807145225040"></p>
<h1 id="additem在item初始化的时候初始化每个Item的导航"><a href="#additem在item初始化的时候初始化每个Item的导航" class="headerlink" title="additem在item初始化的时候初始化每个Item的导航"></a>additem在item初始化的时候初始化每个Item的导航</h1><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">self</span>.ForgeContent.BP_OnEntryInitialized:Add(<span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.OnForgeContentEntryInit)<br></code></pre></td></tr></table></figure>

<h1 id="需要一个全局简单的判断当前平台的方法"><a href="#需要一个全局简单的判断当前平台的方法" class="headerlink" title="需要一个全局简单的判断当前平台的方法"></a>需要一个全局简单的判断当前平台的方法</h1><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">(UIUtils.UtilsGetCurrentInputType() == ECommonInputType.Gamepad<br></code></pre></td></tr></table></figure>

<h1 id="通用按钮音效逻辑"><a href="#通用按钮音效逻辑" class="headerlink" title="通用按钮音效逻辑"></a>通用按钮音效逻辑</h1><p>通用按钮，如果蓝图里面不填AudioEventPath就会走其他的逻辑，所以需要自己绑定一下，类似这样</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">self</span>.Btn_Entry:TryOverrideSoundFunc(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span><br>    AudioManager(<span class="hljs-built_in">self</span>):PlayUISound(<span class="hljs-built_in">self</span>, <span class="hljs-string">&quot;event:/ui/common/click_btn_small&quot;</span>,<span class="hljs-literal">nil</span>,<span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">end</span>)<br></code></pre></td></tr></table></figure>

<p>逻辑在这</p>
<p>会走SoundFunc</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">M:OnBtnPressed</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.IsForbidden == <span class="hljs-literal">true</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.CurrentClickIsForbid = <span class="hljs-literal">true</span><br>        <span class="hljs-built_in">self</span>.ForbidSoundFunc(<span class="hljs-built_in">self</span>)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.PressTime = <span class="hljs-built_in">os</span>.<span class="hljs-built_in">clock</span>()<br>    <span class="hljs-comment">--通用按钮的音效已经有比较固定的接入方式了，和蓝图内置音效稍微做点兼容</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.AudioEventPath == <span class="hljs-string">&quot;&quot;</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.SoundFunc(<span class="hljs-built_in">self</span>)<br>    <span class="hljs-keyword">elseif</span> <span class="hljs-built_in">self</span>.AudioPlayCase == EUIAudioPlayCase.OnMouseDown <span class="hljs-keyword">then</span><br>        AudioManager(<span class="hljs-built_in">self</span>):PlayUISound(<span class="hljs-built_in">self</span>,<span class="hljs-built_in">self</span>.AudioEventPath,<span class="hljs-literal">nil</span>,<span class="hljs-literal">nil</span>)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.CurrentClickIsForbid = <span class="hljs-literal">false</span><br>    <span class="hljs-built_in">self</span>.IsPressing = <span class="hljs-literal">true</span><br>    <span class="hljs-built_in">self</span>:PlayButtonPressAnim()<br><br>    <span class="hljs-keyword">for</span> obj,funcs <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.PressLogics) <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(funcs) <span class="hljs-keyword">do</span><br>            v.Event(obj, <span class="hljs-built_in">table</span>.<span class="hljs-built_in">unpack</span>(v.Params))<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<p>这样看来，直接在蓝图里面接也是对的，我真佛了啊</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250901171948021.png" srcset="/img/loading.gif" lazyload alt="image-20250901171948021"></p>
<h1 id="交互控件的逻辑链条"><a href="#交互控件的逻辑链条" class="headerlink" title="交互控件的逻辑链条"></a>交互控件的逻辑链条</h1><p>首先新建了一个Component，叫RegionInterLogic，这里面管理了线上交互组件的逻辑，然后添加到PlayerCharacter这个类里面，这个类里面有一个进入交互区域的入口，EnableRegionSync</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">APlayerCharacter::EnableRegionSync</span><span class="hljs-params">(<span class="hljs-type">bool</span> InEnable)</span></span><br><span class="hljs-function"></span>&#123;<br>	EnterRegion = InEnable;<br>	<span class="hljs-keyword">if</span> (EnterRegion)<br>	&#123;<br>		<span class="hljs-built_in">SyncLocationImmediately</span>();<br>	&#125;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(MoveSyncHandler.<span class="hljs-built_in">IsValid</span>())<br>	&#123;<br>		UKismetSystemLibrary::<span class="hljs-built_in">K2_ClearAndInvalidateTimerHandle</span>(<span class="hljs-keyword">this</span>, MoveSyncHandler);<br>		MoveSyncHandler.<span class="hljs-built_in">Invalidate</span>();<br>	&#125;<br>	<span class="hljs-keyword">if</span> (EnterRegion)<br>	&#123;<br>		<span class="hljs-keyword">auto</span> RegionObj =  <span class="hljs-built_in">AddObject</span>&lt;URegionPlayerInterLogic&gt;();<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsValid</span>(RegionObj))<br>		&#123;<br>			RegionObj-&gt;<span class="hljs-built_in">SetupRegionInterInfo</span>();<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">else</span><br>	&#123;<br>		<span class="hljs-keyword">auto</span> RegionObj = <span class="hljs-built_in">GetObject</span>&lt;URegionPlayerInterLogic&gt;();<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsValid</span>(RegionObj))<br>		&#123;<br>			RegionObj-&gt;EidToPos.<span class="hljs-built_in">Empty</span>();<br>			RegionObj-&gt;<span class="hljs-built_in">FindPersonCanbeInteract</span>();<br><br>		&#125;<br>		<span class="hljs-built_in">RemoveObject</span>(URegionPlayerInterLogic::<span class="hljs-built_in">StaticClass</span>());<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>添加了新的逻辑，如果进入就AddObject，如果离开就RemoveObject</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">if</span> (EnterRegion)<br>&#123;<br>	<span class="hljs-keyword">auto</span> RegionObj =  <span class="hljs-built_in">AddObject</span>&lt;URegionPlayerInterLogic&gt;();<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsValid</span>(RegionObj))<br>	&#123;<br>		RegionObj-&gt;<span class="hljs-built_in">SetupRegionInterInfo</span>();<br>	&#125;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>	<span class="hljs-keyword">auto</span> RegionObj = <span class="hljs-built_in">GetObject</span>&lt;URegionPlayerInterLogic&gt;();<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsValid</span>(RegionObj))<br>	&#123;<br>		RegionObj-&gt;EidToPos.<span class="hljs-built_in">Empty</span>();<br>		RegionObj-&gt;<span class="hljs-built_in">FindPersonCanbeInteract</span>();<br><br>	&#125;<br>	<span class="hljs-built_in">RemoveObject</span>(URegionPlayerInterLogic::<span class="hljs-built_in">StaticClass</span>());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>PlayerCharacter里面会有一个寻找可交互玩家的函数，在这里面初始化这个组件的一些东西</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">APlayerCharacter::FindPlayerToInteract</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span> (!EnterRegion)<br>	&#123;<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	<span class="hljs-keyword">auto</span> RegionInterLogic = <span class="hljs-built_in">GetObject</span>&lt;URegionPlayerInterLogic&gt;();<br><br>	<span class="hljs-keyword">if</span> (!RegionInterLogic)<br>	&#123;<br>		RegionInterLogic = <span class="hljs-built_in">AddObject</span>&lt;URegionPlayerInterLogic&gt;();<br>	&#125;<br>	RegionInterLogic-&gt;<span class="hljs-built_in">FindPersonCanbeInteract</span>();<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>这个Logic组件的关键在这里</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">ComponentCanbeTrigger = ProspectivePlayer-&gt;RegionInterComp;<br>ComponentCanbeTrigger-&gt;<span class="hljs-built_in">InitCommonUIConfirmID</span>(CommonUIConfirmID);<br>ComponentCanbeTrigger-&gt;<span class="hljs-built_in">DisplayInteractiveBtn</span>(OwnerCharacter)<br></code></pre></td></tr></table></figure>

<p>这个RegionInterComp是在PlayerCharacter.h上面的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">UPROPERTY</span>()<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">URegionOnlineInterComp</span>* RegionInterComp = <span class="hljs-literal">nullptr</span>;<br></code></pre></td></tr></table></figure>

<p>是在AddInteractiveComponent上面初始化</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">APlayerCharacter::AddInteractiveComponent</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span> (!FromOtherWorld)<br>	&#123;<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	RegionInterComp = <span class="hljs-built_in">NewObject</span>&lt;URegionOnlineInterComp&gt;(<span class="hljs-keyword">this</span>, URegionOnlineInterComp::<span class="hljs-built_in">StaticClass</span>());<br>	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsValid</span>(RegionInterComp))<br>	&#123;<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	RegionInterComp-&gt;<span class="hljs-built_in">RegisterComponent</span>();<br><br>	RegionInterInviteTeamComp = <span class="hljs-built_in">NewObject</span>&lt;URegionOnlineInterInviteTeamComp&gt;(<span class="hljs-keyword">this</span>, URegionOnlineInterInviteTeamComp::<span class="hljs-built_in">StaticClass</span>());<br>	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsValid</span>(RegionInterInviteTeamComp))<br>	&#123;<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	RegionInterInviteTeamComp-&gt;<span class="hljs-built_in">RegisterComponent</span>();<br><br>	RegionInterAddFriendComp = <span class="hljs-built_in">NewObject</span>&lt;URegionOnlineInterAddFriendComp&gt;(<span class="hljs-keyword">this</span>, URegionOnlineInterAddFriendComp::<span class="hljs-built_in">StaticClass</span>());<br>	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsValid</span>(RegionInterAddFriendComp))<br>	&#123;<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	RegionInterAddFriendComp-&gt;<span class="hljs-built_in">RegisterComponent</span>();<br><br>	RegionInterPersonInfoComp = <span class="hljs-built_in">NewObject</span>&lt;URegionOnlineInterPersonInfoComp&gt;(<span class="hljs-keyword">this</span>, URegionOnlineInterPersonInfoComp::<span class="hljs-built_in">StaticClass</span>());<br>	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">IsValid</span>(RegionInterPersonInfoComp))<br>	&#123;<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	RegionInterPersonInfoComp-&gt;<span class="hljs-built_in">RegisterComponent</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个接口是为了提供给lua里面写逻辑的</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BP_EMGameInstance_C:SpawnOtherRole</span><span class="hljs-params">(ObjId, RoleInfo, MoveInfo)</span></span><br>	<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">LoadClassFinished</span><span class="hljs-params">(self, UnitBlueprint)</span></span> <br>		<span class="hljs-keyword">local</span> Avatar = GWorld:GetAvatar()<br>		<span class="hljs-keyword">if</span> Avatar <span class="hljs-keyword">then</span><br>			<span class="hljs-keyword">if</span>(Avatar.OtherRoleInfo[ObjId].BornState == Const.ShouldDetory ) <span class="hljs-keyword">then</span> <br>				Avatar.OtherRoleInfo[ObjId] = <span class="hljs-literal">nil</span><br>				<span class="hljs-keyword">return</span> <br>			<span class="hljs-keyword">end</span><br>		<span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">local</span> Location = FVector(MoveInfo.Location.X, MoveInfo.Location.Y, MoveInfo.Location.Z)<br>        <span class="hljs-keyword">local</span> Rotation = FRotator(MoveInfo.Rotation.Pitch, MoveInfo.Rotation.Yaw, MoveInfo.Rotation.Roll):ToQuat()<br>        <span class="hljs-keyword">local</span> SpawnTransform = FTransform(Rotation, Location)<br>        <span class="hljs-keyword">local</span> CurrentCharacter = <span class="hljs-built_in">self</span>:GetWorld():SpawnActor(UnitBlueprint, SpawnTransform, UE4.ESpawnActorCollisionHandlingMethod.AlwaysSpawn)<br>		CurrentCharacter.FromOtherWorld = <span class="hljs-literal">true</span><br>		<span class="hljs-keyword">local</span> Info =&#123;&#125;<br>		<span class="hljs-keyword">local</span> GameMode = UE4.UGameplayStatics.GetGameMode(<span class="hljs-built_in">self</span>)<br>		Info.RoleId = RoleInfo.CharId<br>		Info.SkinId = RoleInfo.SkinId<br>		Info.FromOtherWorld = <span class="hljs-literal">true</span><br>		Info.AppearanceSuit = RoleInfo.AppearanceSuit<br><br>		<span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">CharacterRead</span><span class="hljs-params">(Character)</span></span><br>			<span class="hljs-built_in">print</span>(<span class="hljs-built_in">_G</span>.LogTag, <span class="hljs-string">&quot;CharacterRead&quot;</span>, Character:K2_GetActorLocation(), Character:K2_GetActorRotation())<br>			<span class="hljs-keyword">local</span> Avatar = GWorld:GetAvatar()<br>			<span class="hljs-keyword">if</span> Avatar <span class="hljs-keyword">then</span><br>				<span class="hljs-keyword">if</span>(Avatar.OtherRoleInfo[ObjId].BornState == Const.ShouldDetory <span class="hljs-keyword">and</span> Character) <span class="hljs-keyword">then</span> <br>					Character:K2_DestroyActor()<br>					Avatar.OtherRoleInfo[ObjId] = <span class="hljs-literal">nil</span><br>					<span class="hljs-keyword">return</span> <br>				<span class="hljs-keyword">end</span><br>				Avatar.OtherRoleInfo[ObjId].BornState = Const.Bonred<br>				Avatar.OtherRoleInfo[ObjId].CharEid = Character.Eid<br>				<span class="hljs-comment">-- PrintTable(&#123;SpawnOtherRole = &#123;AvatarId = ObjId, OtherRoleInfo = Avatar.OtherRoleInfo[ObjId]&#125;&#125;, 4)</span><br>			<span class="hljs-keyword">end</span><br>			Character:AddInteractiveComponent()<br>			<span class="hljs-keyword">if</span>(Character.RegionInterComp) <span class="hljs-keyword">then</span><br>				Character.RegionInterComp:InitRegionInfo(Character.Eid, ObjId)<br>			<span class="hljs-keyword">end</span><br>			<span class="hljs-keyword">if</span>(Character.RegionInterAddFriendComp) <span class="hljs-keyword">then</span><br>				Character.RegionInterAddFriendComp:InitRegionInfo(Character.Eid, ObjId)<br>			<span class="hljs-keyword">end</span><br>			<span class="hljs-keyword">if</span>(Character.RegionInterInviteTeamComp) <span class="hljs-keyword">then</span><br>				Character.RegionInterInviteTeamComp:InitRegionInfo(Character.Eid, ObjId)<br>			<span class="hljs-keyword">end</span><br>			<span class="hljs-keyword">if</span>(Character.RegionInterPersonInfoComp) <span class="hljs-keyword">then</span><br>				Character.RegionInterPersonInfoComp:InitRegionInfo(Character.Eid, ObjId)<br>			<span class="hljs-keyword">end</span><br>		<span class="hljs-keyword">end</span><br>		Info.LoadFinishCallback = CharacterRead<br>		CurrentCharacter:InitCharacterInfoForRegionPlayer(Info)<br>		EventManager:FireEvent(EventID.AddRegionIndicatorInfo, CurrentCharacter.Eid, RoleInfo.Uid, CurrentCharacter:K2_GetActorLocation(), ObjId)<br>	<span class="hljs-keyword">end</span>     <br>    <span class="hljs-keyword">local</span> Path = <span class="hljs-string">&#x27;/Game/BluePrints/Char/BP_PlayerCharacter.BP_PlayerCharacter_C&#x27;</span><br>    UE4.UResourceLibrary.LoadClassAsync(<span class="hljs-built_in">self</span>, Path, &#123;<span class="hljs-built_in">self</span>, LoadClassFinished&#125;)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>所以如果想把新增的三个组件也初始化CommonUIConfirmID，可以在RegionPlayerInterLogic里面写逻辑，之前CommonUIConfirmId是写在Lua的常量表里面</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">CommonUIConfirmID = UEMLuaConst::Vars.RegionPlayerInterId;<br></code></pre></td></tr></table></figure>

<p>EMLuaConst.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-built_in">UPROPERTY</span>()<br>int32 RegionPlayerInterId;<br></code></pre></td></tr></table></figure>

<p>EMLuaConst.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">EMLuaConst.RegionPlayerInterId = <span class="hljs-number">100032</span><br></code></pre></td></tr></table></figure>

<p>这样就可以用上我lua里面写的逻辑了</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--- 根据配置的ID获取Icon，有特殊需求的在子类中重写</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BP_RegionOnlineInterInviteTeamComponent_C:GetInteractiveIcon</span><span class="hljs-params">(PlayerActor)</span></span><br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>:IsLocked() <span class="hljs-keyword">then</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Texture2D&#x27;/Game/UI/Texture/Dynamic/Atlas/Interactive/T_Interactive_Lock.T_Interactive_Lock&#x27;&quot;</span><br>	<span class="hljs-keyword">end</span><br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>:IsForbidden(PlayerActor) <span class="hljs-keyword">then</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Texture2D&#x27;/Game/UI/Texture/Dynamic/Atlas/Interactive/T_Interactive_Forbidden.T_Interactive_Forbidden&#x27;&quot;</span><br>	<span class="hljs-keyword">end</span><br>	<span class="hljs-keyword">local</span> Data = DataMgr.CommonUIConfirm[<span class="hljs-built_in">self</span>.CommonUIConfirmID]<br>	<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Data <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> Data.Icon <span class="hljs-keyword">then</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>	<span class="hljs-keyword">end</span><br>	<span class="hljs-keyword">return</span> Data.Icon<br>    <span class="hljs-comment">-- local ImageResource = LoadObject(Data.Icon)</span><br>    <span class="hljs-comment">-- return ImageResource</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BP_RegionOnlineInterInviteTeamComponent_C:GetInteractiveName</span><span class="hljs-params">()</span></span><br>	<span class="hljs-keyword">return</span> GText(<span class="hljs-string">&quot;UI_Friend_Invite&quot;</span>)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BP_RegionOnlineInterInviteTeamComponent_C:InitCommonUIConfirmID</span><span class="hljs-params">(CommonUIConfirmID)</span></span><br>	<span class="hljs-built_in">self</span>.CommonUIConfirmID = CommonUIConfirmID<br>	<span class="hljs-keyword">local</span> Data = DataMgr.CommonUIConfirm[CommonUIConfirmID]<br>	<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Data <span class="hljs-keyword">then</span><br>		<span class="hljs-keyword">return</span><br>	<span class="hljs-keyword">end</span><br>	<span class="hljs-built_in">self</span>.InteractiveDistance = Data.InteractiveRadius <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.InteractiveDistance<br>	<span class="hljs-built_in">self</span>.InteractiveAngle = Data.InteractiveAngle <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.InteractiveAngle<br>	<span class="hljs-built_in">self</span>.InteractiveFaceAngle = Data.PlayerFaceAngle <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.InteractiveFaceAngle<br>	<span class="hljs-built_in">self</span>.ListPriority = Data.InteractivePriority <span class="hljs-keyword">or</span> <span class="hljs-number">0</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>





<h1 id="理解一下Component的一些接口"><a href="#理解一下Component的一些接口" class="headerlink" title="理解一下Component的一些接口"></a>理解一下Component的一些接口</h1><p>一般服务器会写这个东西，然后客户端如果要接红点相关可以在EnterWorld和_OnPropChangeTheaterActivity来做</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Component:_OnPropChangeTheaterActivity</span><span class="hljs-params">(key)</span></span><br>    <span class="hljs-built_in">self</span>:RefreshTheaterEventRewardReddot()<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这个OnProp会在EntityBase里面的ClientPropSet里面调用</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Component:ClientPropSet</span><span class="hljs-params">(name, key, value)</span></span><br>	<span class="hljs-built_in">self</span>.logger.<span class="hljs-built_in">debug</span>(<span class="hljs-string">&quot;ClientPropSet&quot;</span>, name, key)<br><br>	<span class="hljs-keyword">local</span> _type = <span class="hljs-built_in">self</span>.__Class__<br>	<span class="hljs-keyword">local</span> prop = _type.Props[name]<br>	<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> prop <span class="hljs-keyword">then</span><br>		<span class="hljs-keyword">return</span><br>	<span class="hljs-keyword">end</span><br><br>	<span class="hljs-keyword">local</span> OldValue = <span class="hljs-built_in">self</span>[name][key]<br>	<span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(value) == <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">and</span> value.__type <span class="hljs-keyword">and</span> value.value <span class="hljs-keyword">then</span><br>		<span class="hljs-built_in">self</span>[name][key] = value.value<br>	<span class="hljs-keyword">else</span><br>		<span class="hljs-keyword">local</span> _type = prop:GetType()<br>		<span class="hljs-keyword">local</span> _key_type = _type.KeyType<br>		<span class="hljs-keyword">local</span> _value_type = _type.ValueType<br>		<span class="hljs-keyword">local</span> _value_type_name = _value_type.__Name__<br>		<span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.UseProtoAttr <span class="hljs-keyword">and</span> <span class="hljs-built_in">self</span>.AttrTypes[_value_type_name] <span class="hljs-keyword">and</span> value ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span><br>			value = pb.decode(<span class="hljs-string">&quot;.&quot;</span>.._value_type_name, value)<br>			<span class="hljs-comment">-- self.logger.debug(&quot;ClientPropSet&quot;, name, Serpent.block(value))</span><br>			<span class="hljs-built_in">self</span>[name]._inner[_key_type:convert(key)] = _value_type:proto_load(value)<br>		<span class="hljs-keyword">else</span><br>			<span class="hljs-built_in">self</span>[name][key] = value<br>		<span class="hljs-keyword">end</span><br>	<span class="hljs-keyword">end</span><br>	<span class="hljs-keyword">local</span> func = <span class="hljs-built_in">self</span>[<span class="hljs-string">&quot;_OnPropChange&quot;</span>..name]<br>	<span class="hljs-keyword">if</span> func ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span><br>		func(<span class="hljs-built_in">self</span>,&#123;key&#125;, OldValue)<br>	<span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>





<h1 id="学习一下导航"><a href="#学习一下导航" class="headerlink" title="学习一下导航"></a>学习一下导航</h1><p>导航代码入口？：NavigationFunctionLibrary.cpp</p>
<p>按V冒出一个黄光指引目标位置：BP_CreatPathEffectTrail</p>
<h1 id="战斗手柄按键如何做的（输入系统总览）"><a href="#战斗手柄按键如何做的（输入系统总览）" class="headerlink" title="战斗手柄按键如何做的（输入系统总览）"></a>战斗手柄按键如何做的（输入系统总览）</h1><p>总的过程</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">硬件输入 → Windows消息 → UE输入系统 → InputComponent → Action绑定 → 回调函数<br></code></pre></td></tr></table></figure>



<p>需要动态绑组合键，比如平时X是普攻，但是按爪LB和X就是技能1，这种怎么做？</p>
<p>比较好的思路如下：</p>
<p>动态修改InputSetting里的ActionMapping，按下技能组合键时，把原先”X键映射Attack”删掉，新增一条”X键映射Skill1”松开技能组合键时，把”X键映射Skill1”删掉，重新加入”X键映射Attack</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250904163401533.png" srcset="/img/loading.gif" lazyload alt="image-20250904163401533"></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 根据表格，把所有手柄键位初始化一次</span><br><span class="hljs-keyword">for</span> _, UserData <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(ActionMappings) <span class="hljs-keyword">do</span><br>    <span class="hljs-keyword">local</span> ActionName = UserData.ActionName<br>    <span class="hljs-keyword">if</span> GamepadSet[ActionName] <span class="hljs-keyword">and</span> GamepadSet[ActionName].GamepadKey <span class="hljs-keyword">and</span> GamepadSet[ActionName].GamepadKey[KeySet] <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">local</span> KeyName = <span class="hljs-string">&quot;Gamepad_&quot;</span> .. GamepadSet[ActionName].GamepadKey[KeySet]<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">string</span>.<span class="hljs-built_in">find</span>(UserData.Key.KeyName,<span class="hljs-string">&#x27;Gamepad&#x27;</span>) <span class="hljs-keyword">and</span> UserData.Key.KeyName ~= KeyName <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">self</span>.InputSetting:RemoveActionMapping(UserData) <span class="hljs-comment">-- 删掉不匹配的</span><br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">local</span> NewKey = UE4.EKeys[KeyName]<br>        UserData.Key = NewKey<br>        <span class="hljs-built_in">self</span>.InputSetting:AddActionMapping(UserData) <span class="hljs-comment">-- 加上匹配的</span><br>    <span class="hljs-keyword">elseif</span> GamepadSet[ActionName] <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> GamepadSet[ActionName].GamepadKey <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> GamepadSet[ActionName].GamepadKey[KeySet])<br>            <span class="hljs-keyword">and</span> <span class="hljs-built_in">string</span>.<span class="hljs-built_in">find</span>(UserData.Key.KeyName,<span class="hljs-string">&#x27;Gamepad&#x27;</span>) <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.InputSetting:RemoveActionMapping(UserData) <span class="hljs-comment">-- 如果是个组合按键，删掉残留的</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>首先会把按键和Action一一对应绑定，之后ue里面只会发出Action的信号来通知写逻辑，然后再把Action和逻辑绑定，这样分一层的好处是解耦，action就写自己的逻辑，不用把按键和逻辑绑定，之后改键只用改按键是怎么触发不同的Action就可以了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 在SetupPlayerInputComponent中绑定输入</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">APlayerCharacter::SetupPlayerInputComponent</span><span class="hljs-params">(UInputComponent* PlayerInputComponent)</span></span><br><span class="hljs-function"></span>&#123;<br>    Super::<span class="hljs-built_in">SetupPlayerInputComponent</span>(PlayerInputComponent);<br>    <br>    <span class="hljs-comment">// 绑定Attack动作</span><br>    <span class="hljs-built_in">BindAction</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Attack&quot;</span>), IE_Pressed, &amp;APlayerCharacter::PressAttack);<br>    <span class="hljs-built_in">BindAction</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Attack&quot;</span>), IE_Released, &amp;APlayerCharacter::ReleaseAttack);<br>    <br>    <span class="hljs-comment">// 绑定其他动作...</span><br>    <span class="hljs-built_in">BindAction</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Jump&quot;</span>), IE_Pressed, &amp;APlayerCharacter::StartJump);<br>    <span class="hljs-built_in">BindAction</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Skill1&quot;</span>), IE_Pressed, &amp;APlayerCharacter::PressSkill1);<br>    <span class="hljs-comment">// ... 更多绑定</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>绑定BindAction的代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// EM游戏的自定义绑定函数</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">APlayerCharacter::BindAction</span><span class="hljs-params">(<span class="hljs-type">const</span> FName&amp; ActionName, <span class="hljs-type">const</span> EInputEvent KeyEvent, <span class="hljs-type">void</span> (APlayerCharacter::* Delegate)())</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// 1. 添加到绑定映射表</span><br>    BindActions.<span class="hljs-built_in">Add</span>(<span class="hljs-built_in">TTuple</span>&lt;FName, EInputEvent&gt;(ActionName, KeyEvent), Delegate);<br>    <br>    <span class="hljs-comment">// 2. 绑定到UE4的输入系统</span><br>    InputComponent-&gt;<span class="hljs-built_in">BindAction</span>&lt;ActionDelegate, APlayerCharacter, FName&gt;(<br>        ActionName, KeyEvent, <span class="hljs-keyword">this</span>, &amp;APlayerCharacter::ActionCallback, ActionName, KeyEvent);<br>    <br>    <span class="hljs-comment">// 3. 记录按下状态</span><br>    <span class="hljs-keyword">if</span> (KeyEvent == IE_Released) <br>        PressedKeyActions.<span class="hljs-built_in">Add</span>(ActionName, <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个BindAction其实用的是UE的项目设置里面那个Action系统</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Binds a delegate function to an Action defined in the project settings.</span><br><span class="hljs-comment"> * Returned reference is only guaranteed to be valid until another action is bound.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">DelegateType</span>, <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserClass</span>, <span class="hljs-keyword">typename</span>... VarTypes&gt;<br><span class="hljs-function">FInputActionBinding&amp; <span class="hljs-title">BindAction</span><span class="hljs-params">(<span class="hljs-type">const</span> FName ActionName, <span class="hljs-type">const</span> EInputEvent KeyEvent, UserClass* Object, <span class="hljs-keyword">typename</span> DelegateType::<span class="hljs-keyword">template</span> TUObjectMethodDelegate&lt;UserClass&gt;::FMethodPtr Func, VarTypes... Vars)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-function">FInputActionBinding <span class="hljs-title">AB</span><span class="hljs-params">(ActionName, KeyEvent)</span></span>;<br>    AB.ActionDelegate.<span class="hljs-built_in">BindDelegate</span>&lt;DelegateType&gt;(Object, Func, Vars...);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">AddActionBinding</span>(<span class="hljs-built_in">MoveTemp</span>(AB));<br>&#125;<br></code></pre></td></tr></table></figure>



<p>Callback逻辑</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">APlayerCharacter::ActionCallback</span><span class="hljs-params">(FName ActionName, EInputEvent KeyEvent)</span> </span><br><span class="hljs-function"></span>&#123;	<br>    <span class="hljs-comment">// 1. 获取最终动作名称（可能经过转换）</span><br>    FName _ActionName = <span class="hljs-built_in">GetFinalActionName</span>(ActionName, KeyEvent);<br>    <br>    <span class="hljs-comment">// 2. 检查禁止标签</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">CheckForbidTags</span>(_ActionName))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (KeyEvent == IE_Released)<br>        &#123;<br>            <span class="hljs-built_in">ResetAttackProperty</span>(ActionName);<br>            <span class="hljs-comment">// 处理特殊状态重置</span><br>        &#125;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 3. 输入缓存处理</span><br>    <span class="hljs-keyword">if</span> (KeyEvent == IE_Pressed &amp;&amp; _ActionName != <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Attack&quot;</span>))<br>    &#123;<br>        <span class="hljs-built_in">SetInputCache</span>(_ActionName.<span class="hljs-built_in">ToString</span>());<br>    &#125;<br>    <br>    <span class="hljs-comment">// 4. 初始化检查</span><br>    <span class="hljs-keyword">if</span> (!InitSuccess || !<span class="hljs-built_in">IsAllWeaponInitSuccess</span>()) <br>        <span class="hljs-keyword">return</span>;<br>    <br>    <span class="hljs-comment">// 5. 更新按键状态</span><br>    <span class="hljs-built_in">UpdatePressedKeyActionMap</span>(_ActionName, KeyEvent);<br>    <br>    <span class="hljs-comment">// 6. 查找并执行对应的处理函数</span><br>    TTuple&lt;FName, EInputEvent&gt; Key = <span class="hljs-built_in">TTuple</span>&lt;FName, EInputEvent&gt;(_ActionName, KeyEvent);<br>    <span class="hljs-type">bool</span> KeyExist = BindActions.<span class="hljs-built_in">Contains</span>(Key);<br>    <br>    <span class="hljs-keyword">if</span> (KeyExist) &#123;<br>        (<span class="hljs-keyword">this</span>-&gt;*BindActions[Key])();  <span class="hljs-comment">// 调用对应的处理函数</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后拿攻击的逻辑做一个例子</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">APlayerCharacter::PressAttack</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    bPressedAttack = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">// 1. 道具效果检查</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">CheckSkillOccupiedByProp</span>(ESkillName::HeavyAttack))<br>    &#123;<br>        <span class="hljs-comment">// 设置道具长按计时器</span><br>        <span class="hljs-built_in">GetWorldTimerManager</span>().<span class="hljs-built_in">SetTimer</span>(Timer_PropHoldAttack, [<span class="hljs-keyword">this</span>]()<br>        &#123;<br>            PropEffectComponent-&gt;CurrentPropEffect-&gt;<span class="hljs-built_in">OnHoldAttack</span>();<br>        &#125;, HoldDelayTime, <span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 2. 道具攻击处理</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">CheckSkillOccupiedByProp</span>(ESkillName::Attack))<br>    &#123;<br>        PropEffectComponent-&gt;CurrentPropEffect-&gt;<span class="hljs-built_in">OnAttackPressed</span>();<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 3. 获取重击技能ID</span><br>    <span class="hljs-type">const</span> int32 HoldAttackSkillId = <span class="hljs-built_in">GetSkillByType</span>(ESkillType::HeavyAttack);<br>    <span class="hljs-keyword">if</span> (HoldAttackSkillId == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br><br>    <span class="hljs-comment">// 4. 技能禁用检查</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">CheckSkillIsBan</span>(ESkillName::Attack))<br>    &#123;<br>        <span class="hljs-comment">// 显示UI提示</span><br>        UIManager-&gt;<span class="hljs-built_in">ShowUITip_BattleCommonTop</span>(Const::Tip_CommonTop, <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;UI_MELEE_FORBIDDEN&quot;</span>));<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 5. 输入禁止检查</span><br>    <span class="hljs-keyword">if</span> ((!<span class="hljs-built_in">CheckCanSkillCancel</span>(HoldAttackSkillId) &amp;&amp; <span class="hljs-built_in">CheckForbidInput</span>()) || <br>        <span class="hljs-built_in">CheckSkillInActive</span>(ESkillName::Attack))<br>    &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 6. 设置长按计时器</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">GetWorldTimerManager</span>().<span class="hljs-built_in">IsTimerActive</span>(Timer_PropHoldAttack))<br>    &#123;<br>        HoldingSkillName = UEMNameRegisterLibrary::EMName_Attack;<br>        <span class="hljs-built_in">GetWorldTimerManager</span>().<span class="hljs-built_in">SetTimer</span>(Timer_HoldAttack, [<span class="hljs-keyword">this</span>, HoldAttackSkillId]()<br>        &#123;<br>            <span class="hljs-built_in">HoldSkill</span>(HoldAttackSkillId, UEMNameRegisterLibrary::EMName_Attack);<br>        &#125;, HoldDelayTime, <span class="hljs-literal">false</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="事件系统EventManager"><a href="#事件系统EventManager" class="headerlink" title="事件系统EventManager"></a>事件系统EventManager</h1><p>在lua里面的事件系统比较简单，AddEvent就是拿了一个表，来存这个回调的事件，值得注意的是，这个回调可以是多个，因为Event也拿了一个表来储存</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EventManager:AddEvent</span><span class="hljs-params">(eventName, obj, func)</span></span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> obj <span class="hljs-keyword">then</span> <br>        Traceback(ErrorTag, <span class="hljs-string">&quot;EventManager:AddEvent，事件的对象不能为空！！！&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> func <span class="hljs-keyword">then</span><br>        Traceback(ErrorTag, <span class="hljs-string">&quot;EventManager:AddEvent，传入的函数回调不能为空！！&quot;</span>)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.EventDic[eventName] == <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.EventDic[eventName] = Event:New()<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.EventDic[eventName]:Add(obj,func)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这个最后的EventDic[eventName]:Add(obj, func)调的就是Event的Add</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Event:Add</span><span class="hljs-params">(obj,funcion)</span></span><br>    <span class="hljs-comment">---@note 事件会按序执行，存储回调的是list</span><br>    <span class="hljs-comment">-- table.insert(self.List,&#123;obj=obj,funcion=funcion&#125;)</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">self</span>.List[obj] <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.List[obj] = &#123;&#125;<br>        <span class="hljs-built_in">self</span>.FuncMap[obj] = &#123;&#125;<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">self</span>.FuncMap[obj][funcion] <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">table</span>.<span class="hljs-built_in">insert</span>(<span class="hljs-built_in">self</span>.List[obj], funcion)<br>        <span class="hljs-built_in">self</span>.FuncMap[obj][funcion] = <span class="hljs-number">1</span><br>        <span class="hljs-built_in">self</span>.NowCount = <span class="hljs-built_in">self</span>.NowCount + <span class="hljs-number">1</span><br>    <span class="hljs-keyword">end</span><br>    <br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<p>FIreEvent也很简单，就是直接Invoke对应的Event就行了</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EventManager:FireEvent</span><span class="hljs-params">(eventName,...)</span></span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.EventDic[eventName] ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.EventDic[eventName]:Invoke(...)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>Invoke</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Event:Invoke</span><span class="hljs-params">(...)</span></span><br>    <span class="hljs-comment">-- for i, event in ipairs(self.List)  do</span><br>    <span class="hljs-comment">--     local obj = event.obj</span><br>    <span class="hljs-comment">--     if obj then</span><br>    <span class="hljs-comment">--         -- PrintTable(&#123;Obj = obj&#125;, 10)</span><br>    <span class="hljs-comment">--         local objType = type(obj)</span><br>    <span class="hljs-comment">--         if ((objType == &quot;userdata&quot; or (objType==&quot;table&quot; and obj.Object)) and IsValid(obj)) or (objType == &quot;table&quot; and not obj.Object) then</span><br>    <span class="hljs-comment">--             if(event.funcion) then</span><br>    <span class="hljs-comment">--                 event.funcion(obj,...)</span><br>    <span class="hljs-comment">--             end</span><br>    <span class="hljs-comment">--         end</span><br>    <span class="hljs-comment">--     end</span><br>    <span class="hljs-comment">-- end</span><br><br>    <span class="hljs-comment">-- for i = #self.List, 1, -1 do</span><br>    <span class="hljs-comment">--     local Event = self.List[i]</span><br>    <span class="hljs-comment">--     if Event.obj == nil then</span><br>    <span class="hljs-comment">--         table.remove(self.List, i)</span><br>    <span class="hljs-comment">--     end</span><br>    <span class="hljs-comment">-- end</span><br>    <span class="hljs-keyword">local</span> InvalidObjs = &#123;&#125;<br>    <span class="hljs-keyword">local</span> TmpCalls = &#123;&#125;<br>    <span class="hljs-keyword">for</span> obj, funcs <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.List) <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">if</span> obj <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">local</span> objType = <span class="hljs-built_in">type</span>(obj)<br>            <span class="hljs-keyword">if</span> ((objType == <span class="hljs-string">&quot;userdata&quot;</span> <span class="hljs-keyword">or</span> (objType==<span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">and</span> obj.Object)) <span class="hljs-keyword">and</span> IsValid(obj)) <span class="hljs-keyword">or</span> (objType == <span class="hljs-string">&quot;table&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> obj.Object) <span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">table</span>.<span class="hljs-built_in">insert</span>(TmpCalls, &#123;obj, funcs&#125;)<br>                <span class="hljs-comment">-- for _, func in ipairs(funcs) do</span><br>                <span class="hljs-comment">--     func(obj, ...)</span><br>                <span class="hljs-comment">-- end</span><br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-built_in">table</span>.<span class="hljs-built_in">insert</span>(InvalidObjs, obj)<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">local</span> args = &#123;...&#125;<br>    <span class="hljs-keyword">for</span> _, call <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(TmpCalls) <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">local</span> obj = call[<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">local</span> funcs = call[<span class="hljs-number">2</span>]<br>        <span class="hljs-keyword">for</span> _, func <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(funcs) <span class="hljs-keyword">do</span><br>        	try &#123;<br>		        exec = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span><br>            		func(obj, <span class="hljs-built_in">table</span>.<span class="hljs-built_in">unpack</span>(args))<br>		        <span class="hljs-keyword">end</span>,<br>		        catch = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span></span><br>		        	GWorld.logger.<span class="hljs-built_in">error</span>(Traceback(ErrorTag, err,<span class="hljs-literal">true</span>))<br>		        <span class="hljs-keyword">end</span><br>	    	&#125;<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">for</span> _, obj <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(InvalidObjs) <span class="hljs-keyword">do</span><br>        <span class="hljs-built_in">self</span>.List[obj] = <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>下面再看一下检测内存泄漏方法，用来确保代码只Add了没有remove的情况，防止一些奇怪的调用，也是在EventManager里面包了一个调用</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EventManager:CheckIsLeak</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">local</span> bLog = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> GWorld.IsDev <span class="hljs-keyword">then</span> <br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">end</span><br>    DebugPrint(WarningTag, <span class="hljs-string">&quot;检测EventMananger事件泄漏...&quot;</span>)<br>    <span class="hljs-keyword">for</span> eventName, Event <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.EventDic) <span class="hljs-keyword">do</span><br>        Event:CheckIsLeak(eventName, bLog)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>这个逻辑也比较简单，因为Add和Remove的时候会更新一下self.NowCount，如果发现self.LastCount~&#x3D;0（也就是非第一次检查）并且比nowcount小，就说明有地方没有正确remove了，如果是第一次检查会把self.LastCount &#x3D; self.NowCount</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Event:CheckIsLeak</span><span class="hljs-params">(eventName, bLog)</span></span><br>    <span class="hljs-comment">--bLog = true</span><br>    <span class="hljs-comment">--DebugPrint(string.format(&quot;EventManager事件，%s，LastCount:%s，NowCount:%s&quot;,eventName,self.LastCount, self.NowCount))</span><br>    <span class="hljs-keyword">local</span> RealCount = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.LastCount~=<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">self</span>.LastCount &lt; <span class="hljs-built_in">self</span>.NowCount <span class="hljs-keyword">and</span> bLog <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">local</span> Visited = &#123;&#125;<br>        ScreenPrint(ErrorTag..<span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>(<span class="hljs-string">&quot;EventManager事件 %s 发现内存泄漏，请检查该事件注册后是否正确清理，LastCount:%s，NowCount:%s&quot;</span>,eventName,<span class="hljs-built_in">self</span>.LastCount, <span class="hljs-built_in">self</span>.NowCount))<br>        <span class="hljs-keyword">for</span> obj, List <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.List) <span class="hljs-keyword">do</span><br>            <span class="hljs-keyword">if</span> obj.Overridden <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> Visited[obj.Overridden] <span class="hljs-keyword">then</span><br>                DebugPrint(ErrorTag,<span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>(<span class="hljs-string">&quot;该泄漏的事件绑定的函数数量:%s, 类名:&quot;</span>,#List),(obj.Overridden))<br>                Visited[obj.Overridden] = <span class="hljs-number">1</span><br>                <span class="hljs-comment">-- if not obj:IsValid() then</span><br>                <span class="hljs-comment">--     DebugPrint(WarningTag, &quot;该UObject对象已经无效，对泄漏的绑定做保底清理&quot;)</span><br>                <span class="hljs-comment">--     self:Remove(obj)</span><br>                <span class="hljs-comment">--     goto continue</span><br>                <span class="hljs-comment">-- end</span><br>            <span class="hljs-keyword">elseif</span> obj.__Name__ <span class="hljs-keyword">then</span>  <span class="hljs-comment">--这里是故意不加Visited，因为Entity可能有多个componment，但是他们类名都一样，如果贸然去重可能会漏掉一些检测</span><br>                DebugPrint(ErrorTag,<span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>(<span class="hljs-string">&quot;该泄漏的事件绑定的函数数量:%s, 类名:%s&quot;</span>,#List, obj.__Name__ ))<br>                <span class="hljs-comment">-- if not GWorld.EntityManager:GetEntity(obj.id) then</span><br>                <span class="hljs-comment">--     DebugPrint(WarningTag, &quot;该Entity类型对象已经无效，对泄漏的绑定做保底清理&quot;)</span><br>                <span class="hljs-comment">--     self:Remove(obj)</span><br>                <span class="hljs-comment">--     goto continue</span><br>                <span class="hljs-comment">-- end</span><br>            <span class="hljs-keyword">elseif</span> <span class="hljs-keyword">not</span> Visited[obj] <span class="hljs-keyword">then</span><br>                DebugPrintTable(obj,<span class="hljs-number">1</span>,ErrorTag,<span class="hljs-built_in">string</span>.<span class="hljs-built_in">format</span>(<span class="hljs-string">&quot;该泄漏的事件绑定的函数数量:%s, 对象:&quot;</span>,#List))<br>                Visited[obj] = <span class="hljs-number">1</span><br>            <span class="hljs-keyword">end</span><br>            RealCount = RealCount + #List<br>            <span class="hljs-comment">--::continue::</span><br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-built_in">self</span>.NowCount = RealCount<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.LastCount = <span class="hljs-built_in">self</span>.NowCount<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>现在调用这个的时机是世界清除（应该是下线？）还有创建一个Entity的时候</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BP_TcpConnection_C:CreateEntity</span><span class="hljs-params">(entity_type, entity_id, info, use_protoattr)</span></span><br>    DebugNetPrint(<span class="hljs-string">&quot;CreateEntity &quot;</span>, entity_type, use_protoattr)<br>    <span class="hljs-keyword">local</span> entity = GWorld.EntityManager:GetEntity(entity_id)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> entity <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">if</span> entity_type == <span class="hljs-string">&quot;Avatar&quot;</span> <span class="hljs-keyword">then</span><br>			EventManager:CheckIsLeak()<br>		<span class="hljs-keyword">end</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">_G</span>.LogTag, <span class="hljs-string">&quot;CreateNewEntity&quot;</span>, entity_type)<br>        entity = GWorld.EntityFactory:CreateEntity(entity_type, entity_id)<br><br>        <span class="hljs-keyword">if</span> entity <span class="hljs-keyword">then</span><br>            entity:SetServerProxy(<span class="hljs-built_in">self</span>)<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">if</span> entity <span class="hljs-keyword">then</span><br>        DebugPrint(<span class="hljs-string">&quot;InitFromDict before&quot;</span>, <span class="hljs-built_in">os</span>.<span class="hljs-built_in">time</span>())<br>        entity:InitFromDict(info, use_protoattr)<br>        DebugPrint(<span class="hljs-string">&quot;InitFromDict after&quot;</span>, <span class="hljs-built_in">os</span>.<span class="hljs-built_in">time</span>())<br>        entity:CreateSuccess()<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>



<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BP_EMGameInstance_C:OnPostWorldCleanup</span><span class="hljs-params">(World, bSessionEnded, bCleanupResources)</span></span><br>	<span class="hljs-keyword">if</span> World:GetName() == <span class="hljs-built_in">self</span>:GetWorld():GetName() <span class="hljs-keyword">then</span><br>		<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> GWorld:GetAvatar() <span class="hljs-keyword">then</span><br>			EventManager:CheckIsLeak()<br>		<span class="hljs-keyword">end</span><br>	<span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>





<p>接入Icon </p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> Icon = LoadObject(Content.Icon)<br><span class="hljs-built_in">self</span>.Icon_Head:SetBrushFromTexture(Icon)<br></code></pre></td></tr></table></figure>





<h1 id="手机端的虚拟手柄是怎么做的？"><a href="#手机端的虚拟手柄是怎么做的？" class="headerlink" title="手机端的虚拟手柄是怎么做的？"></a>手机端的虚拟手柄是怎么做的？</h1><p>尝试了两种方法，一种是TouchComponent，这个组件可以管理不同的touch逻辑，但是组合到自己的UI之后发现有报错，所以就换了一种；另一种其实就是直接用OnTouch内部，手柄其实只不过是一个Image，然后通过Touch的位置来控制显示的位置而已</p>
<p>首先UE处理触控有三个流程，OnTouchStarted，OnTouchMoved和OnTouchEnded，Component的处理方式也只是把暴露了可以绑定的方法，有一个AddMovedSubTouchItem</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:AddMovedSubTouchItem</span><span class="hljs-params">(SubTouchName, SubTouchItem, ParentWidget, AllCallBack, LimitParams)</span></span><br>    <span class="hljs-comment">-- LimitParams为限制区域相关设置，常见的如矩形，椭圆</span><br>    <span class="hljs-built_in">self</span>.UpdatePosFlag[SubTouchName] = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(AllCallBack) <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.AllTouchCallBack[k] == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">self</span>.AllTouchCallBack[k] = &#123;&#123;Name=SubTouchName,Value=v&#125;&#125;<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-built_in">table</span>.<span class="hljs-built_in">insert</span>(<span class="hljs-built_in">self</span>.AllTouchCallBack[k], &#123;Name=SubTouchName,Value=v&#125;)<br>        <span class="hljs-keyword">end</span> <br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.AllParentWidget[SubTouchName] = ParentWidget<br>    <span class="hljs-built_in">self</span>.LimitRangeParam[SubTouchItem] = LimitParams<br>    <span class="hljs-built_in">self</span>.AllTouchItems[SubTouchName] = SubTouchItem<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>具体用法如下，可以说明这个touch的形状，然后就是三个函数调用的逻辑，然后Component里面会重写ue内部的那几个Touch函数，再根据touch的位置来判断应该是哪个来响应，分发出去，这样外部就只用自己实现Down,Move,Up三个函数就好了，其他自己会处理</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">self</span>:AddMovedSubTouchItem(<span class="hljs-string">&quot;BattleFortJoystick&quot;</span>, <span class="hljs-built_in">self</span>.Joystick, <span class="hljs-literal">nil</span>, &#123;Down=<span class="hljs-built_in">self</span>.ButtonDown, Move=<span class="hljs-built_in">self</span>.ButtonMove, Up=<span class="hljs-built_in">self</span>.ButtonUp&#125;,<br>        &#123;Type=<span class="hljs-string">&quot;Circle&quot;</span>, Param=&#123;Radius=<span class="hljs-built_in">self</span>.Radius, NeedReset=<span class="hljs-literal">false</span>&#125;, TouchTimes=<span class="hljs-number">-1</span>, NeedResetPos=<span class="hljs-literal">true</span>&#125;)<br></code></pre></td></tr></table></figure>

<p>写的挺好的，我就直接把全部摘录下来了</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br></pre></td><td class="code"><pre><code class="hljs lua"><br><span class="hljs-built_in">require</span> <span class="hljs-string">&quot;UnLua&quot;</span><br><br><span class="hljs-comment">-- 封装touch事件判断</span><br><span class="hljs-keyword">local</span> TouchComponent = &#123;&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:Initialize</span><span class="hljs-params">(Initializer)</span></span><br>    <span class="hljs-built_in">self</span>.WidgetStartPos = <span class="hljs-literal">nil</span>           <span class="hljs-comment">-- 交互对象的开始位置（Local）</span><br>    <span class="hljs-built_in">self</span>.WidgetCurPos = <span class="hljs-literal">nil</span>             <span class="hljs-comment">-- 交互对象的当前位置（Local）</span><br>    <span class="hljs-built_in">self</span>.NowTouchPos = &#123;&#125;               <span class="hljs-comment">-- 当前触控点位置（Key是PointerIndex）</span><br>    <span class="hljs-built_in">self</span>.m_LastPosTable = &#123;&#125;            <span class="hljs-comment">-- 上一次停留的Pos位置（Key是PointerIndex）</span><br>    <span class="hljs-built_in">self</span>.LastTouch_Time = <span class="hljs-number">0</span>		        <span class="hljs-comment">-- 上一次点击时间</span><br>    <span class="hljs-built_in">self</span>.Click_MaxLen = <span class="hljs-number">5</span>               <span class="hljs-comment">-- 单击判断的最大距离</span><br>    <span class="hljs-built_in">self</span>.DClick_Prepared = <span class="hljs-literal">false</span>        <span class="hljs-comment">-- 是否可以触发连击</span><br>    <span class="hljs-built_in">self</span>.Lpress_Began = <span class="hljs-literal">false</span>           <span class="hljs-comment">-- 是否已经触发长按</span><br>    <span class="hljs-built_in">self</span>.Lpress_Interval = <span class="hljs-number">0.5</span>          <span class="hljs-comment">-- 长按最小时间间隔</span><br>    <span class="hljs-built_in">self</span>.Lpress_MaxLen = <span class="hljs-number">20</span>             <span class="hljs-comment">-- 长按最大移动距离</span><br>    <span class="hljs-built_in">self</span>.Touching_Flag = &#123;&#125;             <span class="hljs-comment">-- 标识符，当前手指是否正处于拖动（Key是PointerIndex）</span><br>    <span class="hljs-built_in">self</span>.AllTouchItems = &#123;&#125;             <span class="hljs-comment">-- 所有的可拖拽控件</span><br>    <span class="hljs-built_in">self</span>.AllParentWidget = &#123;&#125;           <span class="hljs-comment">-- 所有可拖动的SubWidget的父Widget</span><br>    <span class="hljs-built_in">self</span>.SubTouchItems = &#123;&#125;             <span class="hljs-comment">-- 正在拖动交互的所有SubWidget</span><br>    <span class="hljs-built_in">self</span>.SubTouchParentWidget = &#123;&#125;      <span class="hljs-comment">-- 正在拖动交互的所有SubWidget的父Widget</span><br>    <span class="hljs-built_in">self</span>.SubTouchItemsName = &#123;&#125;         <span class="hljs-comment">-- 正在拖动交互的所有SubWidget的Name</span><br>    <span class="hljs-built_in">self</span>.SubTouchItemsStartPos = &#123;&#125;     <span class="hljs-comment">-- Widget在当前控件之中的起始位置   </span><br>    <span class="hljs-built_in">self</span>.UpdatePosFlag = &#123;&#125;             <span class="hljs-comment">-- 是否需要实际拖动子SubWidget(Widget位置发生改变)</span><br>    <span class="hljs-built_in">self</span>.m_LastHandleMoveTimeStamp = &#123;&#125;     <span class="hljs-comment">-- 上一次处理触控移动的时间戳</span><br>    <span class="hljs-built_in">self</span>.CurrentTouchingGeometry = &#123;&#125;       <span class="hljs-comment">-- 几何体信息（Key是PointerIndex）</span><br>    <span class="hljs-built_in">self</span>.CurrentTouchingGestureEvent = &#123;&#125;   <span class="hljs-comment">-- Gesture信息（Key是PointerIndex）</span><br>    <span class="hljs-built_in">self</span>.AllTouchCallBack = &#123;&#125;              <span class="hljs-comment">-- 所有的Touch回调函数</span><br>    <span class="hljs-built_in">self</span>.Owner_Player = <span class="hljs-literal">nil</span>                 <span class="hljs-comment">-- 所属的Player对象</span><br><br>    <span class="hljs-built_in">self</span>.m_UpdateTimerFlag_X = <span class="hljs-literal">false</span>        <span class="hljs-comment">-- X方向的回弹</span><br>    <span class="hljs-built_in">self</span>.m_UpdateTimerFlag_Y = <span class="hljs-literal">false</span>        <span class="hljs-comment">-- Y方向的回弹</span><br>    <span class="hljs-built_in">self</span>.CanLimitRange = <span class="hljs-literal">false</span>              <span class="hljs-comment">-- 是否限制拖动的范围</span><br>    <span class="hljs-built_in">self</span>.LimitRangeParam = &#123;&#125;               <span class="hljs-comment">-- 拖动范围信息参数</span><br>    <span class="hljs-built_in">self</span>.IsAutoAdjustByMultiTouch = <span class="hljs-literal">false</span>   <span class="hljs-comment">-- 是否需要在多指触控下自动调整自身大小</span><br>    <span class="hljs-built_in">self</span>.DefaultPixelSeries = <span class="hljs-number">1.5</span>           <span class="hljs-comment">-- 自定义的放大比例因子</span><br>    <span class="hljs-built_in">self</span>.MultiTouchLastTimeStamp = <span class="hljs-number">-1</span>       <span class="hljs-comment">-- 多指触控上一次释放时间戳（多指变单指）</span><br>    <span class="hljs-built_in">self</span>.Offset = FVector2D(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)           <span class="hljs-comment">-- 暂时没有用</span><br>    <span class="hljs-built_in">self</span>.BackgroundPlateOffset = <span class="hljs-number">100</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:SetClickMaxLen</span><span class="hljs-params">(MaxLen)</span></span><br>    <span class="hljs-built_in">self</span>.ClickMaxLen = MaxLen<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:SetLongTouchInterval</span><span class="hljs-params">(Interval)</span></span><br>    <span class="hljs-built_in">self</span>.LpressInterval = Interval<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:InitTouchLayer</span><span class="hljs-params">(OwnerPlayer, UpdatetimeX, UpdatetimeY)</span></span><br>    <span class="hljs-built_in">self</span>.Owner_Player = OwnerPlayer<br>    <span class="hljs-built_in">self</span>.m_SavePrePos = FVector2D(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>    <span class="hljs-built_in">self</span>.m_SaveTarPos = FVector2D(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>    <span class="hljs-built_in">self</span>.Updatetime_X = UpdatetimeX<br>    <span class="hljs-built_in">self</span>.Updatetime_Y = UpdatetimeY<br>    <span class="hljs-built_in">self</span>.m_LastHandleMoveTimeStamp = &#123;&#125;<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:InitTouchListenEvent</span><span class="hljs-params">()</span></span><br>    EventManager:AddEvent(EventID.CharDie, <span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.HandleOnCharDie)<br>    EventManager:AddEvent(EventID.StartTalk, <span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.HandleEventByInterrupt)<br>    <span class="hljs-built_in">self</span>:ListenForInputAction(<span class="hljs-string">&quot;OpenMenu&quot;</span>, EInputEvent.IE_Pressed, <span class="hljs-literal">false</span>, &#123;<span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.HandleEventByInterrupt&#125;)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:RemoveTouchListenEvent</span><span class="hljs-params">()</span></span><br>    EventManager:RemoveEvent(EventID.CharDie, <span class="hljs-built_in">self</span>)<br>    EventManager:RemoveEvent(EventID.StartTalk, <span class="hljs-built_in">self</span>)<br>    <span class="hljs-built_in">self</span>:StopListeningForInputAction(<span class="hljs-string">&quot;OpenMenu&quot;</span>, EInputEvent.IE_Pressed)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:HandleOnCharDie</span><span class="hljs-params">(Eid)</span></span><br>    <span class="hljs-keyword">local</span> Entity = GWorld.Battle:GetEntity(Eid)<br>    <span class="hljs-keyword">if</span> (Entity <span class="hljs-keyword">and</span> Entity.IsMainPlayer <span class="hljs-keyword">and</span> Entity:IsMainPlayer()) <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>:HandleEventByInterrupt()<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:HandleEventByInterrupt</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">for</span> k, CurrentGeometry <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.CurrentTouchingGeometry) <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.Touching_Flag[k]) <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">self</span>:MouseOrTouchButtonUp(CurrentGeometry, <span class="hljs-built_in">self</span>.CurrentTouchingGestureEvent[k], k - <span class="hljs-number">1</span>)  <br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:AddStaticSubTouchItem</span><span class="hljs-params">(SubTouchName, SubTouchItem, AllCallBack)</span></span><br>    <span class="hljs-built_in">self</span>.UpdatePosFlag[SubTouchName] = <span class="hljs-literal">false</span><br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(AllCallBack) <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.AllTouchCallBack[k] == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">self</span>.AllTouchCallBack[k] = &#123;&#123;Name=SubTouchName,Value=v&#125;&#125;<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-built_in">table</span>.<span class="hljs-built_in">insert</span>(<span class="hljs-built_in">self</span>.AllTouchCallBack[k], &#123;Name=SubTouchName,Value=v&#125;)<br>        <span class="hljs-keyword">end</span> <br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.AllTouchItems[SubTouchName] = SubTouchItem<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:AddMovedSubTouchItem</span><span class="hljs-params">(SubTouchName, SubTouchItem, ParentWidget, AllCallBack, LimitParams)</span></span><br>    <span class="hljs-comment">-- LimitParams为限制区域相关设置，常见的如矩形，椭圆</span><br>    <span class="hljs-built_in">self</span>.UpdatePosFlag[SubTouchName] = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(AllCallBack) <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.AllTouchCallBack[k] == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">self</span>.AllTouchCallBack[k] = &#123;&#123;Name=SubTouchName,Value=v&#125;&#125;<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-built_in">table</span>.<span class="hljs-built_in">insert</span>(<span class="hljs-built_in">self</span>.AllTouchCallBack[k], &#123;Name=SubTouchName,Value=v&#125;)<br>        <span class="hljs-keyword">end</span> <br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.AllParentWidget[SubTouchName] = ParentWidget<br>    <span class="hljs-built_in">self</span>.LimitRangeParam[SubTouchItem] = LimitParams<br>    <span class="hljs-built_in">self</span>.AllTouchItems[SubTouchName] = SubTouchItem<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:OnTouchStarted</span><span class="hljs-params">(InGeometry, InGestureEvent)</span></span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:MouseOrTouchButtonDown(InGeometry, InGestureEvent)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:OnTouchMoved</span><span class="hljs-params">(InGeometry, InGestureEvent)</span></span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:MouseOrTouchButtonMove(InGeometry, InGestureEvent)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:OnTouchEnded</span><span class="hljs-params">(InGeometry, InGestureEvent)</span></span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>:MouseOrTouchButtonUp(InGeometry, InGestureEvent)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:GetOwningPlayer</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.Owner_Player<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:GetWorldPos</span><span class="hljs-params">(Widget)</span></span><br>    <span class="hljs-comment">-- 获取绝对坐标</span><br>    <span class="hljs-keyword">local</span> GameInstance = UE4.UGameplayStatics.GetGameInstance(<span class="hljs-built_in">self</span>)<br>    <span class="hljs-keyword">local</span> UIManager = GameInstance:GetGameUIManager()<br>    <span class="hljs-keyword">if</span> (UIManager == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span> FVector2D(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>), FVector2D(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> UIManager:GetWorldPosition(Widget), UIManager:GetWidgetRenderSize(Widget)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:GetLastPosTableLength</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">local</span> NowCount = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.m_LastPosTable) <span class="hljs-keyword">do</span><br>        NowCount = NowCount + <span class="hljs-number">1</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> NowCount<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:GetNowTouchPosTableLength</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">local</span> NowCount = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.NowTouchPos) <span class="hljs-keyword">do</span><br>        NowCount = NowCount + <span class="hljs-number">1</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> NowCount<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">--处理鼠标/触摸按下事件</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:MouseOrTouchButtonDown</span><span class="hljs-params">(InGeometry, InGestureEvent)</span></span><br>    <span class="hljs-keyword">local</span> Scale = UE4.UWidgetLayoutLibrary.GetViewportScale(<span class="hljs-built_in">self</span>)<br>    <span class="hljs-keyword">local</span> ScreenSpacePosition = UE4.UKismetInputLibrary.PointerEvent_GetScreenSpacePosition(InGestureEvent)<br>    <span class="hljs-keyword">local</span> thisPos = UE4.USlateBlueprintLibrary.AbsoluteToLocal(InGeometry, ScreenSpacePosition) * Scale<br>    <span class="hljs-keyword">local</span> SubTouchItem, SubTouchItemName, SubTouchItemStartPos, SubTouchParentWidget = <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.AllTouchItems) <span class="hljs-keyword">do</span><br>        <span class="hljs-keyword">local</span> WidgetWorldPos, WidgetWorldSize = <span class="hljs-built_in">self</span>:GetWorldPos(v)<br>        <span class="hljs-comment">-- local CanvasSize = UE4.UWidgetLayoutLibrary.SlotAsCanvasSlot(v):GetSize()</span><br>        <span class="hljs-keyword">local</span> WidgetWorldPos = UE4.USlateBlueprintLibrary.AbsoluteToLocal(InGeometry, WidgetWorldPos) * Scale<br>        <span class="hljs-keyword">if</span> ((thisPos.X &gt; WidgetWorldPos.X <span class="hljs-keyword">and</span> thisPos.X &lt; WidgetWorldPos.X + WidgetWorldSize.X * Scale) <span class="hljs-keyword">and</span> <br>            (thisPos.Y &gt; WidgetWorldPos.Y <span class="hljs-keyword">and</span> thisPos.Y &lt; WidgetWorldPos.Y + WidgetWorldSize.Y * Scale)) <span class="hljs-keyword">then</span><br>            <span class="hljs-comment">-- 认为触摸的是此控件</span><br>            <span class="hljs-keyword">if</span> (SubTouchItem == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>                <span class="hljs-comment">-- 没有的话直接设置</span><br>                SubTouchItem = v<br>                SubTouchItemName = k<br>                SubTouchItemStartPos = FVector2D(WidgetWorldPos.X + WidgetWorldSize.X * <span class="hljs-number">0.5</span> * Scale, WidgetWorldPos.Y + WidgetWorldSize.Y * <span class="hljs-number">0.5</span> * Scale)<br>                SubTouchParentWidget = <span class="hljs-built_in">self</span>.AllParentWidget[k]<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-comment">-- 根据层级来获取最上层的触控层</span><br>                <span class="hljs-keyword">local</span> ChooseCanvasSlot = UE4.UWidgetLayoutLibrary.SlotAsCanvasSlot(SubTouchItem)<br>                <span class="hljs-keyword">local</span> TouchCanvasSlot = UE4.UWidgetLayoutLibrary.SlotAsCanvasSlot(v)<br>                <span class="hljs-keyword">if</span> (TouchCanvasSlot.ZOrder &gt; ChooseCanvasSlot.ZOrder) <span class="hljs-keyword">then</span><br>                    SubTouchItem = v<br>                    SubTouchItemName = k<br>                    SubTouchItemStartPos = FVector2D(WidgetWorldPos.X + WidgetWorldSize.X * <span class="hljs-number">0.5</span> * Scale, WidgetWorldPos.Y + WidgetWorldSize.Y * <span class="hljs-number">0.5</span> * Scale)<br>                    SubTouchParentWidget = <span class="hljs-built_in">self</span>.AllParentWidget[k]<br>                <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (SubTouchItem == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>        DebugPrint(<span class="hljs-string">&quot;TouchComponent== MouseOrTouchButtonDown Error, Not Find Can Interactive Item&quot;</span>)<br>        <span class="hljs-keyword">return</span> UE4.UWidgetBlueprintLibrary.Unhandled()<br>    <span class="hljs-keyword">end</span><br>    <br>    <span class="hljs-keyword">local</span> CanvasSlot = UE4.UWidgetLayoutLibrary.SlotAsCanvasSlot(SubTouchItem)<br>    <span class="hljs-keyword">local</span> PointerIndex = UE4.UKismetInputLibrary.PointerEvent_GetPointerIndex(InGestureEvent)<br><br>    <span class="hljs-built_in">self</span>.CurrentTouchingGeometry[PointerIndex + <span class="hljs-number">1</span>] = InGeometry<br>    <span class="hljs-built_in">self</span>.CurrentTouchingGestureEvent[PointerIndex + <span class="hljs-number">1</span>] = InGestureEvent<br><br>    <span class="hljs-built_in">self</span>.SubTouchItems[PointerIndex + <span class="hljs-number">1</span>] = SubTouchItem<br>    <span class="hljs-built_in">self</span>.SubTouchParentWidget[PointerIndex + <span class="hljs-number">1</span>] = SubTouchParentWidget<br>    <span class="hljs-built_in">self</span>.SubTouchItemsName[PointerIndex + <span class="hljs-number">1</span>] = SubTouchItemName<br>    <span class="hljs-built_in">self</span>.SubTouchItemsStartPos[PointerIndex + <span class="hljs-number">1</span>] = SubTouchItemStartPos <br><br>    <span class="hljs-built_in">self</span>.WidgetCurPos = CanvasSlot:GetPosition()<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.WidgetStartPos == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.WidgetStartPos = CanvasSlot:GetPosition()<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-keyword">local</span> LimitRangeInfo = <span class="hljs-built_in">self</span>.LimitRangeParam[SubTouchItem]<br>        <span class="hljs-keyword">if</span> (LimitRangeInfo <span class="hljs-keyword">and</span> LimitRangeInfo.NeedResetPos) <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">local</span> CanvasSlot = UE4.UWidgetLayoutLibrary.SlotAsCanvasSlot(SubTouchItem)<br>            <span class="hljs-keyword">if</span> (CanvasSlot ~= <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>                CanvasSlot:SetPosition(<span class="hljs-built_in">self</span>.WidgetStartPos)<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span> <br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.Touching_Flag[PointerIndex + <span class="hljs-number">1</span>] = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">local</span> AllDownCallBack = <span class="hljs-built_in">self</span>.AllTouchCallBack[<span class="hljs-string">&quot;Down&quot;</span>]<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">type</span>(AllDownCallBack) == <span class="hljs-string">&quot;table&quot;</span>) <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(AllDownCallBack) <span class="hljs-keyword">do</span><br>            <span class="hljs-keyword">if</span> (v.Name == SubTouchItemName <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(v.Value) == <span class="hljs-string">&quot;function&quot;</span>) <span class="hljs-keyword">then</span><br>                v.Value(<span class="hljs-built_in">self</span>, PointerIndex, <span class="hljs-built_in">self</span>.WidgetCurPos)<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">-- 单指或两指的处理</span><br>    <span class="hljs-keyword">local</span> TotalTouchCount = <span class="hljs-built_in">self</span>:GetNowTouchPosTableLength()<br>    <span class="hljs-keyword">if</span> TotalTouchCount &lt;= <span class="hljs-number">2</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.NowTouchPos[PointerIndex + <span class="hljs-number">1</span>] = thisPos<br>        <span class="hljs-keyword">if</span> TotalTouchCount &lt;= <span class="hljs-number">1</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-comment">-- 单指或者虚拟拖动拖动</span><br>            <span class="hljs-built_in">self</span>.CanLimitRange = <span class="hljs-literal">true</span><br>            <span class="hljs-built_in">self</span>.m_IsTap = <span class="hljs-literal">true</span>                 <span class="hljs-comment">-- 单指按下</span><br>            <span class="hljs-built_in">self</span>.m_HasTriggered = <span class="hljs-literal">false</span><br>            <span class="hljs-built_in">self</span>.m_DragStartPos = thisPos<br>            <span class="hljs-built_in">self</span>.Offset = UE4.USlateBlueprintLibrary.AbsoluteToLocal(InGeometry, ScreenSpacePosition) * Scale <span class="hljs-comment">--+FVector2D(120,120)</span><br>        <span class="hljs-keyword">elseif</span> TotalTouchCount == <span class="hljs-number">2</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-comment">-- 多指拖动</span><br>            <span class="hljs-keyword">if</span> (SubTouchItem.PixelSeries == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>                SubTouchItem.PixelSeries = <span class="hljs-built_in">self</span>.DefaultPixelSeries<br>            <span class="hljs-keyword">end</span><br>            <span class="hljs-built_in">self</span>.CanLimitRange = <span class="hljs-literal">false</span><br>            <span class="hljs-built_in">self</span>.Offset = FVector2D(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">local</span> otherPos = FVector2D(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)<br><br>            <span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>, #<span class="hljs-built_in">self</span>.NowTouchPos <span class="hljs-keyword">do</span><br>                <span class="hljs-keyword">if</span> i ~= PointerIndex + <span class="hljs-number">1</span> <span class="hljs-keyword">then</span>   <span class="hljs-comment">-- 第二指按下的位置</span><br>                    otherPos = <span class="hljs-built_in">self</span>.NowTouchPos[i]<br>                <span class="hljs-keyword">end</span><br><br>                <span class="hljs-built_in">self</span>.m_ZoomStartLength = UE4.UKismetMathLibrary.Distance2D(thisPos, otherPos)<br>                <span class="hljs-built_in">self</span>.m_IsTap = <span class="hljs-literal">false</span><br>                <span class="hljs-built_in">self</span>.m_OriginPoint = (thisPos + otherPos) / <span class="hljs-number">2</span><br>                <span class="hljs-built_in">self</span>:CalcZoomRatio(PointerIndex)<br>                <span class="hljs-built_in">self</span>.startPixelSeries = SubTouchItem.PixelSeries<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">local</span> Handled = UE4.UWidgetBlueprintLibrary.Handled()<br>        <span class="hljs-keyword">return</span> UE4.UWidgetBlueprintLibrary.CaptureMouse(Handled, <span class="hljs-built_in">self</span>)<br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">return</span> UE4.UWidgetBlueprintLibrary.Unhandled()<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">--处理鼠标/触摸移动事件</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:MouseOrTouchButtonMove</span><span class="hljs-params">(InGeometry, InGestureEvent)</span></span><br>    <span class="hljs-keyword">local</span> PointerIndex = UE4.UKismetInputLibrary.PointerEvent_GetPointerIndex(InGestureEvent)<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.Touching_Flag[PointerIndex + <span class="hljs-number">1</span>] <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">local</span> SubTouchItem = <span class="hljs-built_in">self</span>.SubTouchItems[PointerIndex + <span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">local</span> NowTime = UE4.UGameplayStatics.GetRealTimeSeconds(<span class="hljs-built_in">self</span>:GetOwningPlayer())<br>        <span class="hljs-keyword">local</span> LastHandleMoveTimeStamp = <span class="hljs-built_in">self</span>.m_LastHandleMoveTimeStamp[PointerIndex + <span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">if</span> (LastHandleMoveTimeStamp <span class="hljs-keyword">and</span> NowTime - LastHandleMoveTimeStamp &lt;= <span class="hljs-number">0.033</span>) <span class="hljs-keyword">then</span><br>            <span class="hljs-comment">-- 避免短时间内多次执行</span><br>            <span class="hljs-keyword">return</span> UIUtils.Handled<br>        <span class="hljs-keyword">end</span><br><br>        <span class="hljs-built_in">self</span>.m_LastHandleMoveTimeStamp[PointerIndex + <span class="hljs-number">1</span>] = NowTime<br><br>        <span class="hljs-keyword">local</span> Scale = UE4.UWidgetLayoutLibrary.GetViewportScale(<span class="hljs-built_in">self</span>)<br>        <span class="hljs-keyword">local</span> CanvasSlot = UE4.UWidgetLayoutLibrary.SlotAsCanvasSlot(SubTouchItem)<br>        <span class="hljs-keyword">local</span> ScreenSpacePosition = UE4.UKismetInputLibrary.PointerEvent_GetScreenSpacePosition(InGestureEvent)<br>        <span class="hljs-keyword">local</span> thisPos = UE4.USlateBlueprintLibrary.AbsoluteToLocal(InGeometry, ScreenSpacePosition) * Scale<br>        <span class="hljs-comment">-- local changepos = (thisPos - self.Offset)</span><br>        <span class="hljs-keyword">local</span> AllSingleMoveCallBack = <span class="hljs-built_in">self</span>.AllTouchCallBack[<span class="hljs-string">&quot;Move&quot;</span>]<br>        <span class="hljs-keyword">local</span> AllMultiMoveCallBack = <span class="hljs-built_in">self</span>.AllTouchCallBack[<span class="hljs-string">&quot;MultiMove&quot;</span>]<br><br>        <span class="hljs-built_in">self</span>.CurrentTouchingGeometry[PointerIndex + <span class="hljs-number">1</span>] = InGeometry<br>        <span class="hljs-built_in">self</span>.CurrentTouchingGestureEvent[PointerIndex + <span class="hljs-number">1</span>] = InGestureEvent<br><br>        <span class="hljs-keyword">local</span> TotalTouchCount = <span class="hljs-built_in">self</span>:GetNowTouchPosTableLength()<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.NowTouchPos[PointerIndex + <span class="hljs-number">1</span>] ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">if</span> TotalTouchCount == <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-comment">--单指处理拖动</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">type</span>(AllSingleMoveCallBack) == <span class="hljs-string">&quot;table&quot;</span>) <span class="hljs-keyword">then</span><br>                    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(AllSingleMoveCallBack) <span class="hljs-keyword">do</span><br>                        <span class="hljs-keyword">if</span> (v.Name == <span class="hljs-built_in">self</span>.SubTouchItemsName[PointerIndex + <span class="hljs-number">1</span>] <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(v.Value) == <span class="hljs-string">&quot;function&quot;</span> <span class="hljs-keyword">and</span> NowTime - <span class="hljs-built_in">self</span>.MultiTouchLastTimeStamp &gt;= <span class="hljs-number">0.2</span>) <span class="hljs-keyword">then</span><br>                            <span class="hljs-comment">-- 传入目前的触摸坐标，以及相对于开始的移动距离向量(注意是否需要有Scale值的影响)</span><br>                            v.Value(<span class="hljs-built_in">self</span>, TotalTouchCount, PointerIndex, <span class="hljs-built_in">self</span>.WidgetCurPos, thisPos - <span class="hljs-built_in">self</span>.SubTouchItemsStartPos[PointerIndex + <span class="hljs-number">1</span>], thisPos - <span class="hljs-built_in">self</span>.NowTouchPos[PointerIndex + <span class="hljs-number">1</span>], thisPos)<br>                            <span class="hljs-keyword">break</span><br>                        <span class="hljs-keyword">end</span><br>                    <span class="hljs-keyword">end</span><br>                <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">elseif</span> TotalTouchCount == <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-comment">--两指处理缩放</span><br>                <span class="hljs-keyword">local</span> otherPos<br>                <span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>, TotalTouchCount <span class="hljs-keyword">do</span><br>                    <span class="hljs-keyword">if</span> i ~= PointerIndex + <span class="hljs-number">1</span> <span class="hljs-keyword">then</span><br>                        otherPos = <span class="hljs-built_in">self</span>.NowTouchPos[i]<br>                    <span class="hljs-keyword">end</span><br>                <span class="hljs-keyword">end</span><br>                <span class="hljs-keyword">local</span> MoveDist = UE4.UKismetMathLibrary.Distance2D(thisPos, otherPos)<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">type</span>(AllMultiMoveCallBack) == <span class="hljs-string">&quot;table&quot;</span>) <span class="hljs-keyword">then</span><br>                    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(AllMultiMoveCallBack) <span class="hljs-keyword">do</span><br>                        <span class="hljs-keyword">if</span> (v.Name == <span class="hljs-built_in">self</span>.SubTouchItemsName[PointerIndex + <span class="hljs-number">1</span>] <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(v.Value) == <span class="hljs-string">&quot;function&quot;</span>) <span class="hljs-keyword">then</span><br>                            <span class="hljs-comment">-- 传入触摸的点，以及两个点之间的距离</span><br>                            v.Value(<span class="hljs-built_in">self</span>, TotalTouchCount, PointerIndex, thisPos, otherPos, MoveDist)<br>                            <span class="hljs-keyword">break</span><br>                        <span class="hljs-keyword">end</span><br>                    <span class="hljs-keyword">end</span><br>                <span class="hljs-keyword">elseif</span> (<span class="hljs-built_in">type</span>(AllSingleMoveCallBack) == <span class="hljs-string">&quot;table&quot;</span>) <span class="hljs-keyword">then</span><br>                    <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(AllSingleMoveCallBack) <span class="hljs-keyword">do</span><br>                        <span class="hljs-keyword">if</span> (v.Name == <span class="hljs-built_in">self</span>.SubTouchItemsName[PointerIndex + <span class="hljs-number">1</span>] <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(v.Value) == <span class="hljs-string">&quot;function&quot;</span> <span class="hljs-keyword">and</span> NowTime - <span class="hljs-built_in">self</span>.MultiTouchLastTimeStamp &gt;= <span class="hljs-number">0.2</span>) <span class="hljs-keyword">then</span><br>                            <span class="hljs-comment">-- 传入目前的触摸坐标，以及相对于开始的移动距离向量(注意是否需要有Scale值的影响)</span><br>                            v.Value(<span class="hljs-built_in">self</span>, TotalTouchCount, PointerIndex, <span class="hljs-built_in">self</span>.WidgetCurPos, thisPos - <span class="hljs-built_in">self</span>.SubTouchItemsStartPos[PointerIndex + <span class="hljs-number">1</span>], thisPos - <span class="hljs-built_in">self</span>.NowTouchPos[PointerIndex + <span class="hljs-number">1</span>], thisPos)<br>                            <span class="hljs-keyword">break</span><br>                        <span class="hljs-keyword">end</span><br>                    <span class="hljs-keyword">end</span><br>                <span class="hljs-keyword">end</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.IsAutoAdjustByMultiTouch <span class="hljs-keyword">then</span><br>                    <span class="hljs-built_in">self</span>.CanLimitRange = <span class="hljs-literal">false</span><br>                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.m_ZoomStartLength &lt;= MoveDist <span class="hljs-keyword">then</span> <span class="hljs-comment">-- 扩大</span><br>                        <span class="hljs-keyword">local</span> newPixelSeries = (MoveDist - <span class="hljs-built_in">self</span>.m_ZoomStartLength) / <span class="hljs-number">20</span><br>                        SubTouchItem.PixelSeries = <span class="hljs-built_in">self</span>.startPixelSeries + newPixelSeries<br>                        <span class="hljs-keyword">if</span> SubTouchItem.PixelSeries &gt; <span class="hljs-number">80</span> <span class="hljs-keyword">then</span>  <span class="hljs-comment">-- 限制扩大的最大范围</span><br>                            SubTouchItem.PixelSeries = <span class="hljs-number">80</span><br>                        <span class="hljs-keyword">end</span><br>                    <span class="hljs-keyword">else</span><br>                        <span class="hljs-keyword">local</span> newPixelSeries = (<span class="hljs-built_in">self</span>.m_ZoomStartLength - MoveDist) / <span class="hljs-number">20</span><br>                        SubTouchItem.PixelSeries = <span class="hljs-built_in">self</span>.startPixelSeries - newPixelSeries<br>                        <span class="hljs-keyword">if</span> SubTouchItem.PixelSeries &lt; <span class="hljs-number">30</span> <span class="hljs-keyword">then</span><br>                            SubTouchItem.PixelSeries = <span class="hljs-number">30</span><br>                        <span class="hljs-keyword">end</span><br>                    <span class="hljs-keyword">end</span><br>                    <span class="hljs-comment">-- 子页面的PixelSeries更改 可以调用自己封装的AdjustSize()来更新该控件的大小</span><br>                    <span class="hljs-keyword">if</span> (SubTouchItem.AdjustSize) <span class="hljs-keyword">then</span><br>                        SubTouchItem:AdjustSize() <br>                    <span class="hljs-keyword">end</span><br>                    <span class="hljs-built_in">self</span>:SetZoomPos(PointerIndex)<br>                <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">end</span> <br>            <span class="hljs-comment">-- 更新触控点坐标</span><br>            <span class="hljs-built_in">self</span>.NowTouchPos[PointerIndex + <span class="hljs-number">1</span>] = thisPos               <br>            <span class="hljs-comment">-- local lastPos = self.m_LastPosTable[PointerIndex + 1]</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.UpdatePosFlag[<span class="hljs-built_in">self</span>.SubTouchItemsName[PointerIndex + <span class="hljs-number">1</span>]] == <span class="hljs-literal">true</span>) <span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">self</span>.WidgetCurPos = <span class="hljs-built_in">self</span>:GetNextMovePos(thisPos - <span class="hljs-built_in">self</span>.SubTouchItemsStartPos[PointerIndex + <span class="hljs-number">1</span>], PointerIndex)<br>                CanvasSlot:SetPosition(<span class="hljs-built_in">self</span>.WidgetCurPos)<br>                <span class="hljs-built_in">self</span>.m_LastPosTable[PointerIndex + <span class="hljs-number">1</span>] = thisPos<br>            <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">return</span> UIUtils.Handled<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> UIUtils.Unhandled<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">--处理鼠标、触摸抬起事件</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:MouseOrTouchButtonUp</span><span class="hljs-params">(InGeometry, InGestureEvent, TargetPointerIndex)</span></span><br>    <span class="hljs-keyword">local</span> PointerIndex = TargetPointerIndex <span class="hljs-keyword">or</span> UE4.UKismetInputLibrary.PointerEvent_GetPointerIndex(InGestureEvent)<br>    <span class="hljs-keyword">local</span> SubTouchItem = <span class="hljs-built_in">self</span>.SubTouchItems[PointerIndex + <span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">if</span> (SubTouchItem == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>        DebugPrint(<span class="hljs-string">&quot;TouchComponent== MouseOrTouchButtonUp, Not Find Can Interactive Item&quot;</span>, PointerIndex)<br>        <span class="hljs-keyword">return</span> UE4.UWidgetBlueprintLibrary.Unhandled()<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.m_IsTap = <span class="hljs-literal">false</span><br>    <span class="hljs-built_in">self</span>.Touching_Flag[PointerIndex + <span class="hljs-number">1</span>] = <span class="hljs-literal">nil</span><br>    <span class="hljs-built_in">self</span>.m_LastHandleMoveTimeStamp[PointerIndex + <span class="hljs-number">1</span>] = <span class="hljs-literal">nil</span><br>    <br>    <span class="hljs-built_in">self</span>.CurrentTouchingGeometry[PointerIndex + <span class="hljs-number">1</span>] = InGeometry<br>    <span class="hljs-built_in">self</span>.CurrentTouchingGestureEvent[PointerIndex + <span class="hljs-number">1</span>] = InGestureEvent<br>    <span class="hljs-keyword">local</span> AllUpCallBack = <span class="hljs-built_in">self</span>.AllTouchCallBack[<span class="hljs-string">&quot;Up&quot;</span>]<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">type</span>(AllUpCallBack) == <span class="hljs-string">&quot;table&quot;</span>) <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(AllUpCallBack) <span class="hljs-keyword">do</span><br>            <span class="hljs-keyword">if</span> (v.Name == <span class="hljs-built_in">self</span>.SubTouchItemsName[PointerIndex + <span class="hljs-number">1</span>] <span class="hljs-keyword">and</span> <span class="hljs-built_in">type</span>(v.Value) == <span class="hljs-string">&quot;function&quot;</span>) <span class="hljs-keyword">then</span><br>                <span class="hljs-comment">-- 传出当前节点坐标、目前的点击坐标、上一次图像坐标、上一次点击坐标、以及相对于开始的移动距离向量</span><br>                <span class="hljs-keyword">local</span> Scale = UE4.UWidgetLayoutLibrary.GetViewportScale(<span class="hljs-built_in">self</span>)<br>                <span class="hljs-keyword">local</span> ScreenSpacePosition = UE4.UKismetInputLibrary.PointerEvent_GetScreenSpacePosition(InGestureEvent)<br>                <span class="hljs-keyword">local</span> thisPos = UE4.USlateBlueprintLibrary.AbsoluteToLocal(InGeometry, ScreenSpacePosition) * Scale<br>                <span class="hljs-comment">-- local changepos = (thisPos - self.Offset)</span><br>                v.Value(<span class="hljs-built_in">self</span>, PointerIndex, <span class="hljs-built_in">self</span>.WidgetCurPos, <span class="hljs-built_in">self</span>.m_LastPosTable[PointerIndex + <span class="hljs-number">1</span>], <span class="hljs-built_in">self</span>.NowTouchPos[PointerIndex + <span class="hljs-number">1</span>], thisPos - <span class="hljs-built_in">self</span>.SubTouchItemsStartPos[PointerIndex + <span class="hljs-number">1</span>])<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.NowTouchPos[PointerIndex + <span class="hljs-number">1</span>] ~= <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.NowTouchPos[PointerIndex + <span class="hljs-number">1</span>] = <span class="hljs-literal">nil</span><br>        <span class="hljs-keyword">local</span> TotalTouchCount = <span class="hljs-built_in">self</span>:GetNowTouchPosTableLength()<br>        <span class="hljs-keyword">if</span> TotalTouchCount == <span class="hljs-number">0</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.CanLimitRange <span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">self</span>:LimitRange(PointerIndex)<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">elseif</span> TotalTouchCount == <span class="hljs-number">1</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(<span class="hljs-built_in">self</span>.NowTouchPos) <span class="hljs-keyword">do</span><br>                <span class="hljs-keyword">if</span> (v ~= <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>                    <span class="hljs-built_in">self</span>.m_DragStartPos = v<br>                    <span class="hljs-keyword">break</span> <br>                <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">end</span><br>            <span class="hljs-built_in">self</span>.MultiTouchLastTimeStamp = UE4.UGameplayStatics.GetRealTimeSeconds(<span class="hljs-built_in">self</span>:GetOwningPlayer())<br>            <span class="hljs-comment">-- self.m_DragStartPos = self.NowTouchPos[1]</span><br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">local</span> Handled = UE4.UWidgetBlueprintLibrary.Handled()<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.UpdatePosFlag[<span class="hljs-built_in">self</span>.SubTouchItemsName[PointerIndex + <span class="hljs-number">1</span>]] == <span class="hljs-literal">true</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">self</span>.UpdatePosFlag[<span class="hljs-built_in">self</span>.SubTouchItemsName[PointerIndex + <span class="hljs-number">1</span>]] = <span class="hljs-literal">false</span><br>            <span class="hljs-built_in">self</span>:OnUpdatePosFlag(PointerIndex)<br>            <span class="hljs-comment">--self.UpdatePosTimerHandle = UE4.UKismetSystemLibrary.K2_SetTimerDelegate(&#123;self, self.OnUpdatePosFlag&#125;, 0.01, true)</span><br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">return</span> UE4.UWidgetBlueprintLibrary.ReleaseMouseCapture(Handled)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.UpdatePosFlag[<span class="hljs-built_in">self</span>.SubTouchItemsName[PointerIndex + <span class="hljs-number">1</span>]] == <span class="hljs-literal">true</span> <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.UpdatePosFlag[<span class="hljs-built_in">self</span>.SubTouchItemsName[PointerIndex + <span class="hljs-number">1</span>]] = <span class="hljs-literal">false</span><br>        <span class="hljs-built_in">self</span>:OnUpdatePosFlag(PointerIndex)<br>        <span class="hljs-comment">--self.UpdatePosTimerHandle = UE4.UKismetSystemLibrary.K2_SetTimerDelegate(&#123;self, self.OnUpdatePosFlag&#125;, 0.01, true)</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">self</span>:AfterTouchItemMove(PointerIndex)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> UE4.UWidgetBlueprintLibrary.UnHandled()<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">--计算缩放比例</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:CalcZoomRatio</span><span class="hljs-params">(PointerIndex)</span></span><br>    <span class="hljs-built_in">self</span>.m_OriginPoint = <span class="hljs-built_in">self</span>.m_OriginPoint + FVector2D(<span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(<span class="hljs-built_in">self</span>.WidgetCurPos.X), <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(<span class="hljs-built_in">self</span>.WidgetCurPos.Y))<br>    <span class="hljs-built_in">self</span>.m_LeftPointPoint = FVector2D(<span class="hljs-built_in">self</span>.BackgroundPlateOffset, <span class="hljs-built_in">self</span>.BackgroundPlateOffset)<br>    <span class="hljs-built_in">self</span>.m_RelativePos = <span class="hljs-built_in">self</span>.m_OriginPoint - <span class="hljs-built_in">self</span>.m_LeftPointPoint<br>    <span class="hljs-keyword">local</span> CanvasSlot = UE4.UWidgetLayoutLibrary.SlotAsCanvasSlot(<span class="hljs-built_in">self</span>.SubTouchItems[PointerIndex + <span class="hljs-number">1</span>])<br>	<span class="hljs-comment">--计算按下位置相对于控件长宽的位置比例</span><br>    <span class="hljs-keyword">local</span> W = CanvasSlot:GetSize().X<br>    <span class="hljs-keyword">local</span> H = CanvasSlot:GetSize().Y<br>    <span class="hljs-built_in">self</span>.m_RelativePosRatio = FVector2D(<span class="hljs-built_in">self</span>.m_RelativePos.X / W, <span class="hljs-built_in">self</span>.m_RelativePos.Y / H)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">--计算设置缩放后的偏移位置</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:SetZoomPos</span><span class="hljs-params">(PointerIndex)</span></span><br>    <span class="hljs-keyword">local</span> CanvasSlot = UE4.UWidgetLayoutLibrary.SlotAsCanvasSlot(<span class="hljs-built_in">self</span>.SubTouchItems[PointerIndex + <span class="hljs-number">1</span>])<br>    <span class="hljs-keyword">local</span> newW = CanvasSlot:GetSize().X<br>    <span class="hljs-keyword">local</span> newH = CanvasSlot:GetSize().Y<br>    <span class="hljs-built_in">self</span>.m_newRelativePos = FVector2D(newW * <span class="hljs-built_in">self</span>.m_RelativePosRatio.X, newH * <span class="hljs-built_in">self</span>.m_RelativePosRatio.Y)<br>    <span class="hljs-keyword">local</span> newPos = <span class="hljs-built_in">self</span>.WidgetCurPos - <span class="hljs-built_in">self</span>.m_newRelativePos + <span class="hljs-built_in">self</span>.m_RelativePos<br>    CanvasSlot:SetPosition(newPos)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">--拖动时限制拖动范围</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:GetNextMovePos</span><span class="hljs-params">(ChangePos, PointerIndex)</span></span><br>    <span class="hljs-keyword">local</span> FinalPos = <span class="hljs-built_in">self</span>.WidgetStartPos + ChangePos<br>    <span class="hljs-keyword">local</span> LimitRangeInfo = <span class="hljs-built_in">self</span>.LimitRangeParam[<span class="hljs-built_in">self</span>.SubTouchItems[PointerIndex + <span class="hljs-number">1</span>]]<br>    <span class="hljs-keyword">if</span> (LimitRangeInfo <span class="hljs-keyword">and</span> LimitRangeInfo.Type == <span class="hljs-string">&quot;Circle&quot;</span>) <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">local</span> TwoPointDistance = UE4.UKismetMathLibrary.Distance2D(FinalPos, <span class="hljs-built_in">self</span>.WidgetStartPos)<br>        <span class="hljs-keyword">if</span> (TwoPointDistance &gt; LimitRangeInfo[<span class="hljs-string">&quot;Param&quot;</span>].Radius) <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">local</span> k = ChangePos.Y / ChangePos.X<br>            <span class="hljs-keyword">local</span> x, y = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>            <span class="hljs-keyword">if</span> (ChangePos.X &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span><br>                <span class="hljs-comment">-- 左方移动</span><br>                x = -LimitRangeInfo[<span class="hljs-string">&quot;Param&quot;</span>].Radius / <span class="hljs-built_in">math</span>.<span class="hljs-built_in">sqrt</span>(<span class="hljs-number">1</span> + k * k) + <span class="hljs-built_in">self</span>.WidgetStartPos.X<br>                y = -k * LimitRangeInfo[<span class="hljs-string">&quot;Param&quot;</span>].Radius / <span class="hljs-built_in">math</span>.<span class="hljs-built_in">sqrt</span>(<span class="hljs-number">1</span> + k * k) + <span class="hljs-built_in">self</span>.WidgetStartPos.Y<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-comment">-- 右方移动</span><br>                x = LimitRangeInfo[<span class="hljs-string">&quot;Param&quot;</span>].Radius / <span class="hljs-built_in">math</span>.<span class="hljs-built_in">sqrt</span>(<span class="hljs-number">1</span> + k * k) + <span class="hljs-built_in">self</span>.WidgetStartPos.X<br>                y = k * LimitRangeInfo[<span class="hljs-string">&quot;Param&quot;</span>].Radius / <span class="hljs-built_in">math</span>.<span class="hljs-built_in">sqrt</span>(<span class="hljs-number">1</span> + k * k) + <span class="hljs-built_in">self</span>.WidgetStartPos.Y<br>            <span class="hljs-keyword">end</span><br>            FinalPos.X = <span class="hljs-built_in">self</span>.WidgetStartPos.X + x<br>            FinalPos.Y = <span class="hljs-built_in">self</span>.WidgetStartPos.Y + y<br>        <span class="hljs-keyword">end</span> <br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> FinalPos<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">--抬起时限制拖动范围</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:LimitRange</span><span class="hljs-params">(PointerIndex)</span></span><br>    <span class="hljs-keyword">local</span> CanvasSlot = UE4.UWidgetLayoutLibrary.SlotAsCanvasSlot(<span class="hljs-built_in">self</span>.SubTouchItems[PointerIndex + <span class="hljs-number">1</span>])<br>    <span class="hljs-keyword">if</span> (CanvasSlot == <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>.WidgetCurPos = CanvasSlot:GetPosition()<br>    <span class="hljs-keyword">local</span> LimitRangeInfo = <span class="hljs-built_in">self</span>.LimitRangeParam[<span class="hljs-built_in">self</span>.SubTouchItems[PointerIndex + <span class="hljs-number">1</span>]]<br>    <span class="hljs-keyword">if</span> (LimitRangeInfo ~= <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>        <span class="hljs-comment">--限制范围</span><br>        <span class="hljs-keyword">local</span> UpLimitParam = LimitRangeInfo.UpLimitParam<br>        <span class="hljs-keyword">if</span> (UpLimitParam ~= <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">local</span> IsNeedRebackX = <span class="hljs-literal">false</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.WidgetCurPos.X + CanvasSlot:GetSize().X &lt; UpLimitParam.LeftMoveLen) <span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">self</span>.m_SavePrePos.X = <span class="hljs-built_in">self</span>.WidgetCurPos.X<br>                <span class="hljs-built_in">self</span>.m_SaveTarPos.X = -CanvasSlot:GetSize().X + UpLimitParam.LeftMoveLen<br>                IsNeedRebackX = <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">elseif</span> (<span class="hljs-built_in">self</span>.WidgetCurPos.X + CanvasSlot:GetSize().X &gt; UpLimitParam.RightMoveLen) <span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">self</span>.m_SavePrePos.X = <span class="hljs-built_in">self</span>.WidgetCurPos.X<br>                <span class="hljs-built_in">self</span>.m_SaveTarPos.X = -CanvasSlot:GetSize().X + UpLimitParam.RightMoveLen<br>                IsNeedRebackX = <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.m_UpdateTimerFlag_X == <span class="hljs-literal">true</span> <span class="hljs-keyword">and</span> IsNeedRebackX) <span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">self</span>.m_UpdateTimerFlag_X = <span class="hljs-literal">false</span><br>                <span class="hljs-built_in">self</span>.TimerHandle_X = UE4.UKismetSystemLibrary.K2_SetTimerDelegate(&#123;<span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.OnUpdateEdgeLerpTimer_X&#125;, <span class="hljs-number">0.02</span>, <span class="hljs-literal">true</span>)<br>            <span class="hljs-keyword">end</span><br><br>            <span class="hljs-keyword">local</span> IsNeedRebackY = <span class="hljs-literal">false</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.WidgetCurPos.Y + CanvasSlot:GetSize().Y &lt; UpLimitParam.DownMoveLen) <span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">self</span>.m_SavePrePos.Y = <span class="hljs-built_in">self</span>.WidgetCurPos.Y<br>                <span class="hljs-built_in">self</span>.m_SaveTarPos.Y = -CanvasSlot:GetSize().Y + UpLimitParam.DownMoveLen<br>                IsNeedRebackY = <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">elseif</span> (<span class="hljs-built_in">self</span>.WidgetCurPos.Y + CanvasSlot:GetSize().Y &gt; UpLimitParam.UpMoveLen) <span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">self</span>.m_SavePrePos.Y = <span class="hljs-built_in">self</span>.WidgetCurPos.Y<br>                <span class="hljs-built_in">self</span>.m_SaveTarPos.Y = -CanvasSlot:GetSize().Y + UpLimitParam.UpMoveLen<br>                IsNeedRebackY = <span class="hljs-literal">true</span><br>            <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.m_UpdateTimerFlag_Y <span class="hljs-keyword">and</span> IsNeedRebackY) == <span class="hljs-literal">true</span> <span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">self</span>.m_UpdateTimerFlag_Y = <span class="hljs-literal">false</span><br>                <span class="hljs-built_in">self</span>.TimerHandle_Y = UE4.UKismetSystemLibrary.K2_SetTimerDelegate(&#123;<span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.OnUpdateEdgeLerpTimer_Y&#125;, <span class="hljs-number">0.02</span>, <span class="hljs-literal">true</span>)<br>            <span class="hljs-keyword">end</span><br>            CanvasSlot:SetPosition(<span class="hljs-built_in">self</span>.WidgetCurPos)<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-keyword">local</span> viewport_geometry = UE4.UWidgetLayoutLibrary.GetViewportWidgetGeometry(<span class="hljs-built_in">self</span>:GetOwningPlayer())<br>            <span class="hljs-keyword">local</span> viewportlocalsize = UE4.USlateBlueprintLibrary.GetLocalSize(viewport_geometry)<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.WidgetCurPos.X + CanvasSlot:GetSize().X &lt; viewportlocalsize.X / <span class="hljs-number">2</span> ) <span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">self</span>.m_SavePrePos.X = <span class="hljs-built_in">self</span>.WidgetCurPos.X<br>                <span class="hljs-built_in">self</span>.m_SaveTarPos.X = -CanvasSlot:GetSize().X + viewportlocalsize.X / <span class="hljs-number">2</span> <br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.m_UpdateTimerFlag_X == <span class="hljs-literal">true</span> <span class="hljs-keyword">then</span><br>                    <span class="hljs-built_in">self</span>.m_UpdateTimerFlag_X = <span class="hljs-literal">false</span><br>                    <span class="hljs-built_in">self</span>.TimerHandle_X = UE4.UKismetSystemLibrary.K2_SetTimerDelegate(&#123;<span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.OnUpdateEdgeLerpTimer_X&#125;, <span class="hljs-number">0.02</span>, <span class="hljs-literal">true</span>)<br>                <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.WidgetCurPos.Y + CanvasSlot:GetSize().Y &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span><br>                <span class="hljs-built_in">self</span>.m_SavePrePos.Y = <span class="hljs-built_in">self</span>.WidgetCurPos.Y<br>                <span class="hljs-built_in">self</span>.m_SaveTarPos.Y = -CanvasSlot:GetSize().Y<br>                <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.m_UpdateTimerFlag_Y == <span class="hljs-literal">true</span> <span class="hljs-keyword">then</span><br>                    <span class="hljs-built_in">self</span>.m_UpdateTimerFlag_Y = <span class="hljs-literal">false</span><br>                    <span class="hljs-built_in">self</span>.TimerHandle_Y = UE4.UKismetSystemLibrary.K2_SetTimerDelegate(&#123;<span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.OnUpdateEdgeLerpTimer_Y&#125;, <span class="hljs-number">0.02</span>, <span class="hljs-literal">true</span>)<br>                <span class="hljs-keyword">end</span><br>            <span class="hljs-keyword">end</span><br>            CanvasSlot:SetPosition(<span class="hljs-built_in">self</span>.WidgetCurPos)<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">--X方向的拖拽回弹</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:OnUpdateEdgeLerpTimer_X</span><span class="hljs-params">()</span></span><br>    <span class="hljs-built_in">self</span>.Updatetime_X = <span class="hljs-built_in">self</span>.Updatetime_X + <span class="hljs-number">0.1</span><br>    <span class="hljs-built_in">self</span>.WidgetCurPos.X = UE4.UKismetMathLibrary.Lerp(<span class="hljs-built_in">self</span>.m_SavePrePos.X, <span class="hljs-built_in">self</span>.m_SaveTarPos.X, <span class="hljs-built_in">self</span>.Updatetime_X)<br>    <span class="hljs-comment">-- self:UpdateEdgeLerp()</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.Updatetime_X &gt; <span class="hljs-number">1</span>) <span class="hljs-keyword">then</span> <span class="hljs-comment">--超时,关闭定时器</span><br>        <span class="hljs-built_in">self</span>.Updatetime_X = <span class="hljs-number">0</span><br>        <span class="hljs-built_in">self</span>.m_UpdateTimerFlag_X = <span class="hljs-literal">true</span><br>        UE4.UKismetSystemLibrary.K2_ClearAndInvalidateTimerHandle(<span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.TimerHandle_X)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">--Y方向的拖拽回弹</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:OnUpdateEdgeLerpTimer_Y</span><span class="hljs-params">()</span></span><br>    <span class="hljs-built_in">self</span>.Updatetime_Y = <span class="hljs-built_in">self</span>.Updatetime_Y + <span class="hljs-number">0.1</span><br>    <span class="hljs-built_in">self</span>.WidgetCurPos.Y = UE4.UKismetMathLibrary.Lerp(<span class="hljs-built_in">self</span>.m_SavePrePos.Y, <span class="hljs-built_in">self</span>.m_SaveTarPos.Y, <span class="hljs-built_in">self</span>.Updatetime_Y)<br>    <span class="hljs-comment">-- self:UpdateEdgeLerp()</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">self</span>.Updatetime_Y &gt; <span class="hljs-number">1</span>) <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.Updatetime_Y = <span class="hljs-number">0</span><br>        <span class="hljs-built_in">self</span>.m_UpdateTimerFlag_X = <span class="hljs-literal">true</span><br>        UE4.UKismetSystemLibrary.K2_ClearAndInvalidateTimerHandle(<span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.TimerHandle_Y)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">--更新回弹的位置</span><br><span class="hljs-comment">-- function TouchComponent:UpdateEdgeLerp(PointerIndex)</span><br><span class="hljs-comment">--     local CanvasSlot = UE4.UWidgetLayoutLibrary.SlotAsCanvasSlot(self.SubTouchItems[PointerIndex + 1])</span><br><span class="hljs-comment">--     CanvasSlot:SetPosition(FVector2D(self.WidgetCurPos.X, self.WidgetCurPos.Y))</span><br><span class="hljs-comment">-- end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:OnUpdatePosFlag</span><span class="hljs-params">(PointerIndex)</span></span><br>    <span class="hljs-comment">-- 处理实际的控件移动结束之后</span><br>    <span class="hljs-keyword">local</span> SubTouchItem = <span class="hljs-built_in">self</span>.SubTouchItems[PointerIndex + <span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">local</span> LimitRangeInfo = <span class="hljs-built_in">self</span>.LimitRangeParam[SubTouchItem]<br>    <span class="hljs-keyword">if</span> (LimitRangeInfo <span class="hljs-keyword">and</span> LimitRangeInfo.TouchTimes == <span class="hljs-number">-1</span>) <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">self</span>.UpdatePosFlag[<span class="hljs-built_in">self</span>.SubTouchItemsName[PointerIndex + <span class="hljs-number">1</span>]] = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">if</span> (LimitRangeInfo <span class="hljs-keyword">and</span> LimitRangeInfo.NeedResetPos) <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">local</span> CanvasSlot = UE4.UWidgetLayoutLibrary.SlotAsCanvasSlot(SubTouchItem)<br>        <span class="hljs-keyword">if</span> (CanvasSlot ~= <span class="hljs-literal">nil</span>) <span class="hljs-keyword">then</span><br>            CanvasSlot:SetPosition(<span class="hljs-built_in">self</span>.WidgetStartPos)<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-built_in">self</span>:AfterTouchItemMove(PointerIndex)<br>    UE4.UKismetSystemLibrary.K2_ClearAndInvalidateTimerHandle(<span class="hljs-built_in">self</span>, <span class="hljs-built_in">self</span>.UpdatePosTimerHandle)<br><span class="hljs-keyword">end</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TouchComponent:AfterTouchItemMove</span><span class="hljs-params">(PointerIndex)</span></span><br>    <span class="hljs-built_in">self</span>.SubTouchItems[PointerIndex + <span class="hljs-number">1</span>] = <span class="hljs-literal">nil</span><br>    <span class="hljs-built_in">self</span>.SubTouchParentWidget[PointerIndex + <span class="hljs-number">1</span>] = <span class="hljs-literal">nil</span><br>    <span class="hljs-built_in">self</span>.SubTouchItemsName[PointerIndex + <span class="hljs-number">1</span>] = <span class="hljs-literal">nil</span><br>    <span class="hljs-built_in">self</span>.SubTouchItemsStartPos[PointerIndex + <span class="hljs-number">1</span>] = <span class="hljs-literal">nil</span> <br>    <span class="hljs-built_in">self</span>.m_LastPosTable[PointerIndex + <span class="hljs-number">1</span>] = <span class="hljs-literal">nil</span><br>    <span class="hljs-built_in">self</span>.CurrentTouchingGeometry[PointerIndex + <span class="hljs-number">1</span>] = <span class="hljs-literal">nil</span><br>    <span class="hljs-built_in">self</span>.CurrentTouchingGestureEvent[PointerIndex + <span class="hljs-number">1</span>] = <span class="hljs-literal">nil</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-keyword">return</span> TouchComponent<br><br></code></pre></td></tr></table></figure>





<p>然后就是我自己写的逻辑，其实这个要做的就是，再Start的时候记录起始的位置，然后再Move的时候记录move的终点，根据这个distance来算出该怎么移动，要注意Move是只要改变了就会触发，如果一直按住是不会触发，所以要自己写一个定时器来处理他一直按在一个方向不动的逻辑</p>
<h1 id="svn如何只更新某几个目录？"><a href="#svn如何只更新某几个目录？" class="headerlink" title="svn如何只更新某几个目录？"></a>svn如何只更新某几个目录？</h1><p>Repo-brower</p>
<p>然后在里面update item</p>
<h1 id="安卓苹果视频问题"><a href="#安卓苹果视频问题" class="headerlink" title="安卓苹果视频问题"></a>安卓苹果视频问题</h1><p>UE4底层差异的根本原因：</p>
<ol>
<li><p>Android平台：使用Java MediaPlayer + OpenGL ES，依赖应用级渲染上下文，切后台时上下文丢失</p>
</li>
<li><p>iOS平台：使用AVFoundation + Metal，系统级媒体管理，自动处理生命周期变化</p>
</li>
</ol>
<h1 id="从RewardId到ListView"><a href="#从RewardId到ListView" class="headerlink" title="从RewardId到ListView"></a>从RewardId到ListView</h1><p>每次都要翻然后重新写，这里直接记录一下算了，反正都是重复的步骤</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> RewardContentList = &#123;&#125;<br><span class="hljs-built_in">self</span>.List_Reward.OnCreateEmptyContent:Unbind()<br>        <span class="hljs-built_in">self</span>.List_Reward.OnCreateEmptyContent:Bind(<span class="hljs-built_in">self</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(self)</span></span><br>            <span class="hljs-keyword">local</span> Content = NewObject(UIUtils.GetCommonItemContentClass())<br>            Content.Id = <span class="hljs-number">0</span><br>            <span class="hljs-keyword">return</span> Content<br>        <span class="hljs-keyword">end</span>)<br>        <span class="hljs-keyword">local</span> RewardInfo = DataMgr.Reward[PreViewReward]<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">self</span>.RewardList == <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">self</span>.RewardList = &#123;&#125;<br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">if</span> RewardInfo <span class="hljs-keyword">then</span><br>            <span class="hljs-keyword">local</span> RewardIds = RewardInfo.Id <span class="hljs-keyword">or</span> &#123;&#125;<br>            <span class="hljs-keyword">local</span> RewardCounts = RewardInfo.Count <span class="hljs-keyword">or</span> &#123;&#125;<br>            <span class="hljs-keyword">local</span> RewardTypes = RewardInfo.Type <span class="hljs-keyword">or</span> &#123;&#125;<br>            <span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>, #RewardIds <span class="hljs-keyword">do</span><br>                <span class="hljs-keyword">local</span> ItemId = RewardIds[i]<br>                <span class="hljs-keyword">local</span> Count = RewardUtils:GetCount(RewardCounts[i])<br>                <span class="hljs-keyword">local</span> Rarity = ItemUtils.GetItemRarity(ItemId, RewardTypes[i])<br>                <span class="hljs-keyword">local</span> ItemType = RewardTypes[i]<br>                <span class="hljs-keyword">local</span> Content = NewObject(UIUtils.GetCommonItemContentClass())<br>                Content.Id = ItemId<br>                Content.ItemType = ItemType<br>                Content.Count = Count<br>                Content.Rarity = Rarity<br>                Content.Icon = DataMgr[ItemType][ItemId].Icon<br>                Content.IsShowDetails = <span class="hljs-literal">true</span><br>                Content.ParentWidget = <span class="hljs-built_in">self</span><br>                <span class="hljs-built_in">table</span>.<span class="hljs-built_in">insert</span>(RewardContentList, Content)<br>            <span class="hljs-keyword">end</span><br>        <span class="hljs-keyword">end</span><br><br>        <span class="hljs-keyword">for</span> _, ItemContent <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(RewardContentList) <span class="hljs-keyword">do</span><br>            <span class="hljs-built_in">self</span>.List_Reward:AddItem(ItemContent)<br>        <span class="hljs-keyword">end</span><br>        <span class="hljs-built_in">self</span>.List_Reward:RequestFillEmptyContent()<br>    <span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>





<h1 id="如何查StoryLine（STL-的bug"><a href="#如何查StoryLine（STL-的bug" class="headerlink" title="如何查StoryLine（STL)的bug"></a>如何查StoryLine（STL)的bug</h1><p>日志，正则：StartNode|FinishNode</p>
<p>E:\Workgame1.0\Tools\storycreator</p>
<p>的Run.bat</p>
<p>lua的字符串</p>
<h1 id="如何获得ios设备类型"><a href="#如何获得ios设备类型" class="headerlink" title="如何获得ios设备类型"></a>如何获得ios设备类型</h1><p>IOSPlatformMisc.cpp</p>
<p>GetDefaultDeviceProfileName</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">const</span> TCHAR* <span class="hljs-title">FIOSPlatformMisc::GetDefaultDeviceProfileName</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">static</span> FString IOSDeviceProfileName;<br>    <span class="hljs-keyword">if</span> (IOSDeviceProfileName.<span class="hljs-built_in">Len</span>() == <span class="hljs-number">0</span>)<br>    &#123;<br>        IOSDeviceProfileName   = <span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;IOS&quot;</span>);<br><br>        FString DeviceIDString = <span class="hljs-built_in">GetIOSDeviceIDString</span>();<br>        FPlatformMisc::<span class="hljs-built_in">LowLevelOutputDebugStringf</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Device Type: %s&quot;</span>) LINE_TERMINATOR, *DeviceIDString);<br><br>        TArray&lt;FString&gt; Mappings;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ensure</span>(GConfig-&gt;<span class="hljs-built_in">GetSection</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;IOSDeviceMappings&quot;</span>), Mappings, GDeviceProfilesIni)))<br>        &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> FString&amp; MappingString: Mappings)<br>            &#123;<br>                FString MappingRegex, ProfileName;<br>                <span class="hljs-keyword">if</span> (MappingString.<span class="hljs-built_in">Split</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;=&quot;</span>), &amp;MappingRegex, &amp;ProfileName))<br>                &#123;<br>                    <span class="hljs-function"><span class="hljs-type">const</span> FRegexPattern <span class="hljs-title">RegexPattern</span><span class="hljs-params">(MappingRegex)</span></span>;<br>                    <span class="hljs-function">FRegexMatcher <span class="hljs-title">RegexMatcher</span><span class="hljs-params">(RegexPattern, *DeviceIDString)</span></span>;<br>                    <span class="hljs-keyword">if</span> (RegexMatcher.<span class="hljs-built_in">FindNext</span>())<br>                    &#123;<br>                        FPlatformMisc::<span class="hljs-built_in">LowLevelOutputDebugStringf</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Matched %s as %s&quot;</span>) LINE_TERMINATOR, *MappingRegex, *ProfileName);<br>                        IOSDeviceProfileName = ProfileName;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    FPlatformMisc::<span class="hljs-built_in">LowLevelOutputDebugStringf</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;Invalid IOSDeviceMappings: %s&quot;</span>) LINE_TERMINATOR, *MappingString);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> *IOSDeviceProfileName;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用了正则表达式来匹配</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 第385-407行的匹配逻辑</span><br>TArray&lt;FString&gt; Mappings;<br>GConfig-&gt;<span class="hljs-built_in">GetSection</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;IOSDeviceMappings&quot;</span>), Mappings, GDeviceProfilesIni);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> FString&amp; MappingString: Mappings)<br>&#123;<br>    FString MappingRegex, ProfileName;<br>    <span class="hljs-comment">// 分割配置行: &quot;iPhone14,2=iPhone13Pro&quot;</span><br>    MappingString.<span class="hljs-built_in">Split</span>(<span class="hljs-built_in">TEXT</span>(<span class="hljs-string">&quot;=&quot;</span>), &amp;MappingRegex, &amp;ProfileName);<br>    <br>    <span class="hljs-comment">// 使用正则表达式匹配</span><br>    <span class="hljs-function"><span class="hljs-type">const</span> FRegexPattern <span class="hljs-title">RegexPattern</span><span class="hljs-params">(MappingRegex)</span></span>;<br>    <span class="hljs-function">FRegexMatcher <span class="hljs-title">RegexMatcher</span><span class="hljs-params">(RegexPattern, *DeviceIDString)</span></span>;<br>    <br>    <span class="hljs-keyword">if</span> (RegexMatcher.<span class="hljs-built_in">FindNext</span>())<br>    &#123;<br>        <span class="hljs-comment">// 匹配成功！</span><br>        IOSDeviceProfileName = ProfileName;  <span class="hljs-comment">// &quot;iPhone13Pro&quot;</span><br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="配置文件示例"><a href="#配置文件示例" class="headerlink" title="配置文件示例"></a>配置文件示例</h2><p>BaseDeviceProfiles.ini</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[IOSDeviceMappings]</span><br><span class="hljs-comment">; iPhone 映射规则</span><br>iPhone3,<span class="hljs-section">[1-3]</span>=iPhone4<br>iPhone4,<span class="hljs-attr">1</span>=iPhone4S<br>iPhone5,<span class="hljs-section">[1-2]</span>=iPhone5<br>iPhone5,<span class="hljs-section">[3,4]</span>=iPhone5S<br>iPhone6,<span class="hljs-section">[1,2]</span>=iPhone5S<br>iPhone7,<span class="hljs-attr">1</span>=iPhone6Plus<br>iPhone7,<span class="hljs-attr">2</span>=iPhone6<br>iPhone8,<span class="hljs-section">[1,2]</span>=iPhone6S<br>iPhone8,<span class="hljs-attr">4</span>=iPhoneSE<br>iPhone9,<span class="hljs-section">[1,3]</span>=iPhone7<br>iPhone9,<span class="hljs-section">[2,4]</span>=iPhone7Plus<br>iPhone10,<span class="hljs-section">[1,4]</span>=iPhone8<br>iPhone10,<span class="hljs-section">[2,5]</span>=iPhone8Plus<br>iPhone10,<span class="hljs-section">[3,6]</span>=iPhoneX<br>iPhone11,<span class="hljs-attr">2</span>=iPhoneXS<br>iPhone11,<span class="hljs-section">[4,6]</span>=iPhoneXSMax<br>iPhone11,<span class="hljs-attr">8</span>=iPhoneXR<br>iPhone12,<span class="hljs-section">[1,3]</span>=iPhone11<br>iPhone12,<span class="hljs-section">[3,5]</span>=iPhone11Pro<br>iPhone12,<span class="hljs-attr">5</span>=iPhone11ProMax<br>iPhone12,<span class="hljs-attr">8</span>=iPhoneSE2<br><span class="hljs-comment">; iPhone 13系列</span><br>iPhone14,<span class="hljs-attr">4</span>=iPhone13mini<br>iPhone14,<span class="hljs-attr">5</span>=iPhone13<br>iPhone14,<span class="hljs-attr">2</span>=iPhone13Pro<br>iPhone14,<span class="hljs-attr">3</span>=iPhone13ProMax<br><span class="hljs-comment">; iPhone 14系列</span><br>iPhone14,<span class="hljs-attr">6</span>=iPhoneSE3<br>iPhone14,<span class="hljs-attr">7</span>=iPhone14<br>iPhone14,<span class="hljs-attr">8</span>=iPhone14Plus<br>iPhone15,<span class="hljs-attr">2</span>=iPhone14Pro<br>iPhone15,<span class="hljs-attr">3</span>=iPhone14ProMax<br><span class="hljs-comment">; iPhone 15系列</span><br>iPhone15,<span class="hljs-attr">4</span>=iPhone15<br>iPhone15,<span class="hljs-attr">5</span>=iPhone15Plus<br>iPhone16,<span class="hljs-attr">1</span>=iPhone15Pro<br>iPhone16,<span class="hljs-attr">2</span>=iPhone15ProMax<br><span class="hljs-comment">; iPhone 16系列</span><br>iPhone17,<span class="hljs-attr">1</span>=iPhone16Pro<br>iPhone17,<span class="hljs-attr">2</span>=iPhone16ProMax<br>iPhone17,<span class="hljs-attr">3</span>=iPhone16<br>iPhone17,<span class="hljs-attr">4</span>=iPhone16Plus<br><br><span class="hljs-comment">; iPad 映射规则</span><br>iPad2,<span class="hljs-section">[1-3]</span>=iPad2<br>iPad2,<span class="hljs-section">[5-7]</span>=iPadMini<br>iPad3,<span class="hljs-section">[1-3]</span>=iPad3<br>iPad3,<span class="hljs-section">[4-6]</span>=iPad4<br>iPad4,<span class="hljs-section">[1-3]</span>=iPadAir<br>iPad4,<span class="hljs-section">[4-6]</span>=iPadMini2<br>iPad4,<span class="hljs-section">[7-9]</span>=iPadMini3<br>iPad5,<span class="hljs-section">[1,2]</span>=iPadMini4<br>iPad5,<span class="hljs-section">[3,4]</span>=iPadAir2<br>iPad6,<span class="hljs-section">[3,4]</span>=iPadPro_97<br>iPad6,<span class="hljs-section">[7,8]</span>=iPadPro_129<br>iPad6,<span class="hljs-attr">11</span>=iPad5<br>iPad7,<span class="hljs-section">[1,2]</span>=iPadPro2_129<br>iPad7,<span class="hljs-section">[3,4]</span>=iPadPro105<br>iPad7,<span class="hljs-section">[5,6]</span>=iPad6<br>iPad7,<span class="hljs-attr">11</span>=iPad7<br>iPad8,<span class="hljs-section">[1-4]</span>=iPadPro11<br>iPad8,<span class="hljs-section">[5-8]</span>=iPadPro3_129<br>iPad8,<span class="hljs-attr">9</span>=iPadPro<span class="hljs-number">2_11</span><br>iPad8,<span class="hljs-attr">10</span>=iPadPro<span class="hljs-number">2_11</span><br>iPad8,<span class="hljs-attr">11</span>=iPadPro<span class="hljs-number">4_129</span><br>iPad8,<span class="hljs-attr">12</span>=iPadPro<span class="hljs-number">4_129</span><br>iPad11,<span class="hljs-section">[1,2]</span>=iPadMini5<br>iPad11,<span class="hljs-section">[3,4]</span>=iPadAir3<br>iPad11,<span class="hljs-section">[6,7]</span>=iPad8<br><br><span class="hljs-comment">; 通用降级规则（当没有匹配到具体设备时）</span><br><span class="hljs-attr">iPhone</span>=iPhone16      <span class="hljs-comment">; 未识别的iPhone → 默认为iPhone16</span><br><span class="hljs-attr">iPod</span>=iPodTouch7      <span class="hljs-comment">; 未识别的iPod → 默认为iPodTouch7</span><br><span class="hljs-attr">iPad</span>=iPad10          <span class="hljs-comment">; 未识别的iPad → 默认为iPad10</span><br><span class="hljs-attr">AppleTV</span>=AppleTV4K    <span class="hljs-comment">; 未识别的AppleTV → 默认为AppleTV4K</span><br></code></pre></td></tr></table></figure>



<h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs txt">┌─────────────────────────────────────────────────────┐<br>│  1. 启动时调用                                        │<br>│     GetDefaultDeviceProfileName()                    │<br>└────────────────┬────────────────────────────────────┘<br>                 ↓<br>┌─────────────────────────────────────────────────────┐<br>│  2. sysctlbyname(&quot;hw.machine&quot;)                       │<br>│     → &quot;iPhone14,2&quot;                                   │<br>└────────────────┬────────────────────────────────────┘<br>                 ↓<br>┌─────────────────────────────────────────────────────┐<br>│  3. 读取配置文件                                      │<br>│     BaseDeviceProfiles.ini → [IOSDeviceMappings]    │<br>└────────────────┬────────────────────────────────────┘<br>                 ↓<br>┌─────────────────────────────────────────────────────┐<br>│  4. 正则匹配                                          │<br>│     &quot;iPhone14,2&quot; 匹配 &quot;iPhone14,2=iPhone13Pro&quot;      │<br>└────────────────┬────────────────────────────────────┘<br>                 ↓<br>┌─────────────────────────────────────────────────────┐<br>│  5. 返回 Profile 名称                                │<br>│     → &quot;iPhone13Pro&quot;                                  │<br>└────────────────┬────────────────────────────────────┘<br>                 ↓<br>┌─────────────────────────────────────────────────────┐<br>│  6. 应用性能设置                                      │<br>│     [iPhone13Pro DeviceProfile] 的所有 CVars        │<br>└─────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure>



<h2 id="为什么这个要判断一下长度？"><a href="#为什么这个要判断一下长度？" class="headerlink" title="为什么这个要判断一下长度？"></a>为什么这个要判断一下长度？</h2><p>因为statcic局部变量只创建一次，但不是每次调用时创建，这样就不用每次都走这个逻辑，可以直接返回</p>
<h2 id="sysctlbyname"><a href="#sysctlbyname" class="headerlink" title="sysctlbyname"></a>sysctlbyname</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>这是一个</p>
<ul>
<li><p>✅ BSD系统调用（不是C++标准库函数）</p>
</li>
<li><p>✅ 操作系统API（由iOS&#x2F;macOS内核提供）</p>
</li>
<li><p>✅ 声明位置：&lt;sys&#x2F;sysctl.h&gt; 系统头文件</p>
</li>
<li><p>✅ 实现位置：libsystem_kernel.dylib 系统库</p>
</li>
<li><p>✅ 编译时：通过 .mm 文件的隐式包含自动可用</p>
</li>
</ul>
<p>作用是查询或设置操作系统内核的运行时参数</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sysctl.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">sysctlbyname</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name,      <span class="hljs-comment">// 要查询的参数名称</span></span><br><span class="hljs-params">    <span class="hljs-type">void</span> *oldp,            <span class="hljs-comment">// 存放返回值的缓冲区</span></span><br><span class="hljs-params">    <span class="hljs-type">size_t</span> *oldlenp,       <span class="hljs-comment">// 输入/输出：缓冲区大小</span></span><br><span class="hljs-params">    <span class="hljs-type">const</span> <span class="hljs-type">void</span> *newp,      <span class="hljs-comment">// 要设置的新值（只读时传NULL）</span></span><br><span class="hljs-params">    <span class="hljs-type">size_t</span> newlen          <span class="hljs-comment">// 新值的长度（只读时传0）</span></span><br><span class="hljs-params">)</span>;<br></code></pre></td></tr></table></figure>

<p>所以UE这里要两次拿值，第一次拿字符串需要的大小，第二次再拿真正的字符串</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 第一次调用：获取长度</span><br><span class="hljs-type">size_t</span> length = <span class="hljs-number">0</span>;<br><span class="hljs-built_in">sysctlbyname</span>(<span class="hljs-string">&quot;hw.machine&quot;</span>, <span class="hljs-literal">NULL</span>, &amp;length, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// 动态分配内存</span><br><span class="hljs-type">char</span>* buffer = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(length);<br><br><span class="hljs-comment">// 第二次调用：获取数据</span><br><span class="hljs-built_in">sysctlbyname</span>(<span class="hljs-string">&quot;hw.machine&quot;</span>, buffer, &amp;length, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;设备: %s\n&quot;</span>, buffer);<br><br><span class="hljs-built_in">free</span>(buffer);<br></code></pre></td></tr></table></figure>



<h3 id="可查询的参数"><a href="#可查询的参数" class="headerlink" title="可查询的参数"></a>可查询的参数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ==================== 设备识别 ====================</span><br>hw.machine          <span class="hljs-comment">// &quot;iPhone14,2&quot; - 设备型号</span><br>hw.model            <span class="hljs-comment">// &quot;N71mAP&quot; - 硬件代号</span><br><br><span class="hljs-comment">// ==================== 性能相关 ====================</span><br>hw.ncpu             <span class="hljs-comment">// 6 - CPU核心数</span><br>hw.cpufrequency     <span class="hljs-comment">// 3200000000 - CPU频率</span><br>hw.memsize          <span class="hljs-comment">// 6442450944 - 总内存(字节)</span><br>hw.physmem          <span class="hljs-comment">// 实际物理内存</span><br>hw.pagesize         <span class="hljs-comment">// 16384 - 内存页大小</span><br><br><span class="hljs-comment">// ==================== 系统信息 ====================</span><br>kern.ostype         <span class="hljs-comment">// &quot;Darwin&quot; - 系统类型</span><br>kern.osrelease      <span class="hljs-comment">// &quot;21.0.0&quot; - 内核版本</span><br>kern.osversion      <span class="hljs-comment">// iOS版本</span><br>kern.boottime       <span class="hljs-comment">// 开机时间</span><br><br><span class="hljs-comment">// ==================== 电池/性能 ====================</span><br>hw.cpufrequency_max <span class="hljs-comment">// 最大CPU频率</span><br>hw.tbfrequency      <span class="hljs-comment">// Timebase频率</span><br><br><span class="hljs-comment">// ==================== 调试信息 ====================</span><br>kern.osproductversion  <span class="hljs-comment">// &quot;15.0&quot; - iOS版本号</span><br>kern.version           <span class="hljs-comment">// 完整版本字符串</span><br></code></pre></td></tr></table></figure>

<h3 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h3><p><a target="_blank" rel="noopener" href="https://www.manpagez.com/man/3/sysctlbyname/">https://www.manpagez.com/man/3/sysctlbyname/</a></p>
<p><a target="_blank" rel="noopener" href="https://man.freebsd.org/cgi/man.cgi?query=sysctl&sektion=3">https://man.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=3</a></p>
<h2 id="GetIOSDeviceIDString原理"><a href="#GetIOSDeviceIDString原理" class="headerlink" title="GetIOSDeviceIDString原理"></a>GetIOSDeviceIDString原理</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">FString <span class="hljs-title">GetIOSDeviceIDString</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">static</span> FString CachedResult;<br>    <span class="hljs-type">static</span> <span class="hljs-type">bool</span> bCached = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (!bCached)<br>    &#123;<br>        <span class="hljs-comment">// get the device hardware type string length</span><br>        <span class="hljs-type">size_t</span> DeviceIDLen;<br>        <span class="hljs-built_in">sysctlbyname</span>(<span class="hljs-string">&quot;hw.machine&quot;</span>, <span class="hljs-literal">NULL</span>, &amp;DeviceIDLen, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">// get the device hardware type</span><br>        <span class="hljs-type">char</span>* DeviceID = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(DeviceIDLen);<br>        <span class="hljs-built_in">sysctlbyname</span>(<span class="hljs-string">&quot;hw.machine&quot;</span>, DeviceID, &amp;DeviceIDLen, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>        CachedResult = <span class="hljs-built_in">ANSI_TO_TCHAR</span>(DeviceID);<br>        bCached      = <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-built_in">free</span>(DeviceID);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> CachedResult;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>防止太小缓冲区溢出，直接太大可能浪费内存，并且不优雅，而且未来ios可能返回更长</p>
<h1 id="鼠标滚动没有响应手柄的热切换"><a href="#鼠标滚动没有响应手柄的热切换" class="headerlink" title="鼠标滚动没有响应手柄的热切换"></a>鼠标滚动没有响应手柄的热切换</h1><p>改这个函数HandleMouseWheelOrGestureEvent</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">HandleMouseWheelOrGestureEvent</span><span class="hljs-params">(FSlateApplication&amp; SlateApp, <span class="hljs-type">const</span> FPointerEvent&amp; InWheelEvent, <span class="hljs-type">const</span> FPointerEvent* InGestureEvent)</span> <span class="hljs-keyword">override</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">const</span> ECommonInputType InputType = <span class="hljs-built_in">GetInputType</span>(InWheelEvent);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsRelevantInput</span>(SlateApp, InWheelEvent, InputType))<br>    &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsInputMethodBlocked</span>(InputType))<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-built_in">RefreshCurrentInputMethod</span>(InputType);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>





<h1 id="富文本的图片居中显示"><a href="#富文本的图片居中显示" class="headerlink" title="富文本的图片居中显示"></a>富文本的图片居中显示</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp">        <span class="hljs-type">const</span> <span class="hljs-type">float</span> UnscaleLineHeight = MaxAboveBaseline + MaxBelowBaseline;<br><br>        <span class="hljs-keyword">for</span> (int32 Index = <span class="hljs-number">0</span>; Index &lt; OutSoftLine.<span class="hljs-built_in">Num</span>(); Index++)<br>        &#123;<br>            <span class="hljs-type">const</span> TSharedRef&lt;ILayoutBlock&gt; Block = OutSoftLine[Index];<br>            <span class="hljs-type">const</span> TSharedRef&lt;IRun&gt; Run           = Block-&gt;<span class="hljs-built_in">GetRun</span>();<br><br>            <span class="hljs-type">const</span> int16 BlockBaseline            = Run-&gt;<span class="hljs-built_in">GetBaseLine</span>(Scale);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0  <span class="hljs-comment">// ​​Vertical Alignment​​ : Bottom</span></span><br>			<span class="hljs-type">const</span> int16 VerticalOffset = MaxAboveBaseline - Block-&gt;<span class="hljs-built_in">GetSize</span>().Y - BlockBaseline;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span>  <span class="hljs-comment">// ​​Vertical Alignment​​ : Center</span></span><br>            <span class="hljs-type">const</span> int16 VerticalOffset = UnscaleLineHeight / <span class="hljs-number">2.0f</span> - Block-&gt;<span class="hljs-built_in">GetSize</span>().Y / <span class="hljs-number">2.0f</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>这里这个# if 0是条件编译的意思，#if 0 &#x3D; 永远为假的条件编译</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">if</span> 1    <span class="hljs-comment">// 条件为真（1 = true）</span></span><br>    <span class="hljs-comment">// 这段代码会被编译</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0    <span class="hljs-comment">// 条件为假（0 = false）</span></span><br>    <span class="hljs-comment">// 这段代码不会被编译</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>这个修改的原理大概如下文章：</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27970081698">UE5富文本系列之文本图片居中显示优化 - Zzzz的文章 - 知乎</a><br>实现的效果如下</p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250930170113903.png" srcset="/img/loading.gif" lazyload alt="image-20250930170113903"></p>
<p><img src="https://raw.githubusercontent.com/rorschachandbat/cloudimage/main/image-20250930170121038.png" srcset="/img/loading.gif" lazyload alt="image-20250930170121038"></p>
<h2 id="完整调用链"><a href="#完整调用链" class="headerlink" title="完整调用链"></a>完整调用链</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs txt">蓝图/编辑器<br>    ↓<br>URichTextBlock (UMG层)<br>    ↓<br>SRichTextBlock (Slate Widget层)<br>    ↓<br>FSlateTextBlockLayout (布局缓存层)<br>    ↓<br>FTextLayout (文本布局引擎)<br>    ↓<br>CreateLineViewBlocks() ← 你看到的代码<br>    ↓<br>像素级计算（VerticalOffset）<br></code></pre></td></tr></table></figure>

<h2 id="第一步：创建Widget"><a href="#第一步：创建Widget" class="headerlink" title="第一步：创建Widget"></a>第一步：创建Widget</h2><h3 id="1-1蓝图创建RichTextBlock"><a href="#1-1蓝图创建RichTextBlock" class="headerlink" title="1.1蓝图创建RichTextBlock"></a>1.1蓝图创建RichTextBlock</h3><h3 id="1-2-UMG层构造"><a href="#1-2-UMG层构造" class="headerlink" title="1.2 UMG层构造"></a>1.2 UMG层构造</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// RichTextBlock.cpp 第67行</span><br><span class="hljs-function">TSharedRef&lt;SWidget&gt; <span class="hljs-title">URichTextBlock::RebuildWidget</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">UpdateStyleData</span>();<br>    <br>    <span class="hljs-comment">// 创建装饰器（处理&lt;img&gt;、&lt;b&gt;等标签）</span><br>    TArray&lt;TSharedRef&lt;<span class="hljs-keyword">class</span> <span class="hljs-title class_">ITextDecorator</span>&gt;&gt; CreatedDecorators;<br>    <span class="hljs-built_in">CreateDecorators</span>(CreatedDecorators);<br>    <br>    <span class="hljs-comment">// 创建Marshaller（解析富文本标记）</span><br>    TSharedRef&lt;FRichTextLayoutMarshaller&gt; Marshaller = <br>        FRichTextLayoutMarshaller::<span class="hljs-built_in">Create</span>(<br>            <span class="hljs-built_in">CreateMarkupParser</span>(),     <span class="hljs-comment">// 解析&lt;img&gt;、&lt;b&gt;等</span><br>            <span class="hljs-built_in">CreateMarkupWriter</span>(), <br>            CreatedDecorators,        <span class="hljs-comment">// 装饰器列表</span><br>            StyleInstance.<span class="hljs-built_in">Get</span>()<br>        );<br>    <br>    <span class="hljs-comment">// 创建Slate Widget</span><br>    MyRichTextBlock =<br>        <span class="hljs-built_in">SNew</span>(SRichTextBlock)<br>            .<span class="hljs-built_in">TextStyle</span>(&amp;DefaultTextStyle)<br>            .<span class="hljs-built_in">Marshaller</span>(Marshaller);  <span class="hljs-comment">// 传入Marshaller</span><br>    <br>    <span class="hljs-keyword">return</span> MyRichTextBlock.<span class="hljs-built_in">ToSharedRef</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>作用：</p>
<ul>
<li><p>✅ 创建 SRichTextBlock（Slate层的实际Widget）</p>
</li>
<li><p>✅ 设置 Marshaller（富文本解析器）</p>
</li>
<li><p>✅ 绑定样式和装饰器</p>
</li>
</ul>
<h3 id="1-3-Slate层初始化"><a href="#1-3-Slate层初始化" class="headerlink" title="1.3 Slate层初始化"></a>1.3 Slate层初始化</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// SRichTextBlock构造时</span><br>SRichTextBlock::<span class="hljs-built_in">SRichTextBlock</span>()<br>&#123;<br>    <span class="hljs-comment">// 创建文本布局缓存</span><br>    TextLayoutCache = <span class="hljs-built_in">MakeUnique</span>&lt;FSlateTextBlockLayout&gt;(...);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="第2步：同步属性（配置阶段）"><a href="#第2步：同步属性（配置阶段）" class="headerlink" title="第2步：同步属性（配置阶段）"></a>第2步：同步属性（配置阶段）</h2><h3 id="2-1-UMG同步到Slate"><a href="#2-1-UMG同步到Slate" class="headerlink" title="2.1 UMG同步到Slate"></a>2.1 UMG同步到Slate</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// RichTextBlock.cpp 第84行</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">URichTextBlock::SynchronizeProperties</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    Super::<span class="hljs-built_in">SynchronizeProperties</span>();<br>    <br>    <span class="hljs-comment">// 设置文本内容</span><br>    MyRichTextBlock-&gt;<span class="hljs-built_in">SetText</span>(Text);<br>    <br>    <span class="hljs-comment">// 设置转换策略</span><br>    MyRichTextBlock-&gt;<span class="hljs-built_in">SetTransformPolicy</span>(TextTransformPolicy);<br>    <br>    <span class="hljs-comment">// 设置最小宽度</span><br>    MyRichTextBlock-&gt;<span class="hljs-built_in">SetMinDesiredWidth</span>(MinDesiredWidth);<br>    <br>    <span class="hljs-comment">// 同步布局属性（对齐、换行等）</span><br>    Super::<span class="hljs-built_in">SynchronizeTextLayoutProperties</span>(*MyRichTextBlock);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-2-同步布局属性"><a href="#2-2-同步布局属性" class="headerlink" title="2.2 同步布局属性"></a>2.2 同步布局属性</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// TextWidgetTypes.h 第69-80行</span><br><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> TWidgetType&gt;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SynchronizeTextLayoutProperties</span><span class="hljs-params">(TWidgetType&amp; InWidget)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// 设置对齐方式（重点！）</span><br>    InWidget.<span class="hljs-built_in">SetJustification</span>(Justification);<br>    <br>    <span class="hljs-comment">// 设置自动换行</span><br>    InWidget.<span class="hljs-built_in">SetAutoWrapText</span>(!!AutoWrapText);<br>    <br>    <span class="hljs-comment">// 设置换行宽度</span><br>    InWidget.<span class="hljs-built_in">SetWrapTextAt</span>(WrapTextAt != <span class="hljs-number">0</span> ? WrapTextAt : <span class="hljs-built_in">TAttribute</span>&lt;<span class="hljs-type">float</span>&gt;());<br>    <br>    <span class="hljs-comment">// 设置换行策略</span><br>    InWidget.<span class="hljs-built_in">SetWrappingPolicy</span>(WrappingPolicy);<br>    <br>    <span class="hljs-comment">// 设置边距</span><br>    InWidget.<span class="hljs-built_in">SetMargin</span>(Margin);<br>    <br>    <span class="hljs-comment">// 设置行高百分比</span><br>    InWidget.<span class="hljs-built_in">SetLineHeightPercentage</span>(LineHeightPercentage);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>关键：Justification 属性在这里传递到Slate层！</p>
<h2 id="第3步：渲染触发（绘制阶段）"><a href="#第3步：渲染触发（绘制阶段）" class="headerlink" title="第3步：渲染触发（绘制阶段）"></a>第3步：渲染触发（绘制阶段）</h2><h3 id="3-1-Slate渲染循环"><a href="#3-1-Slate渲染循环" class="headerlink" title="3.1 Slate渲染循环"></a>3.1 Slate渲染循环</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 每帧渲染时，Slate系统调用</span><br>SWidget::<span class="hljs-built_in">Paint</span>()<br>    ↓<br>SRichTextBlock::<span class="hljs-built_in">OnPaint</span>()<br></code></pre></td></tr></table></figure>

<h3 id="3-2-SRichTextBlock-OnPaint"><a href="#3-2-SRichTextBlock-OnPaint" class="headerlink" title="3.2 SRichTextBlock::OnPaint()"></a>3.2 SRichTextBlock::OnPaint()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// SRichTextBlock.cpp 第64行</span><br><span class="hljs-function">int32 <span class="hljs-title">SRichTextBlock::OnPaint</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> FPaintArgs&amp; Args, </span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> FGeometry&amp; AllottedGeometry,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> FSlateRect&amp; MyCullingRect, </span></span><br><span class="hljs-params"><span class="hljs-function">    FSlateWindowElementList&amp; OutDrawElements,</span></span><br><span class="hljs-params"><span class="hljs-function">    int32 LayerId,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">const</span> FWidgetStyle&amp; InWidgetStyle,</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-type">bool</span> bParentEnabled)</span> <span class="hljs-type">const</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// 关键：OnPaint会触发布局更新</span><br>    LayerId = TextLayoutCache-&gt;<span class="hljs-built_in">OnPaint</span>(<br>        Args,<br>        TextBlockScaledGeometry,<br>        MyCullingRect,<br>        OutDrawElements,<br>        LayerId,<br>        InWidgetStyle,<br>        <span class="hljs-built_in">ShouldBeEnabled</span>(bParentEnabled)<br>    );<br>    <br>    <span class="hljs-keyword">return</span> LayerId;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-3-计算期望尺寸（可能触发布局）"><a href="#3-3-计算期望尺寸（可能触发布局）" class="headerlink" title="3.3 计算期望尺寸（可能触发布局）"></a>3.3 计算期望尺寸（可能触发布局）</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// SRichTextBlock.cpp 第88行</span><br><span class="hljs-function">FVector2D <span class="hljs-title">SRichTextBlock::ComputeDesiredSize</span><span class="hljs-params">(<span class="hljs-type">float</span> LayoutScaleMultiplier)</span> <span class="hljs-type">const</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// ComputeDesiredSize也会触发布局更新</span><br>    <span class="hljs-type">const</span> FVector2D TextSize = TextLayoutCache-&gt;<span class="hljs-built_in">ComputeDesiredSize</span>(<br>        FSlateTextBlockLayout::<span class="hljs-built_in">FWidgetArgs</span>(<br>            BoundText,<br>            HighlightText,<br>            WrapTextAt,<br>            AutoWrapText,<br>            WrappingPolicy,<br>            TransformPolicy,<br>            Margin,<br>            LineHeightPercentage,<br>            Justification  <span class="hljs-comment">// ← Justification在这里传入</span><br>        ),<br>        LayoutScaleMultiplier * TextBlockScale,<br>        TextStyle<br>    ) * TextBlockScale;<br>    <br>    <span class="hljs-keyword">return</span> TextSize;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="第4步：布局计算（核心阶段）"><a href="#第4步：布局计算（核心阶段）" class="headerlink" title="第4步：布局计算（核心阶段）"></a>第4步：布局计算（核心阶段）</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// TextLayout.cpp 第1176行</span><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">FTextLayout::UpdateLayout</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">SCOPE_CYCLE_COUNTER</span>(STAT_SlateTextLayout);<br>    <br>    <span class="hljs-comment">// 清除旧的视图</span><br>    <span class="hljs-built_in">ClearView</span>();<br>    <br>    <span class="hljs-comment">// 开始布局（通知所有Run）</span><br>    <span class="hljs-built_in">BeginLayout</span>();<br>    <br>    <span class="hljs-comment">// 【核心】流式布局（计算文本换行和Block位置）</span><br>    <span class="hljs-built_in">FlowLayout</span>();<br>    <br>    <span class="hljs-comment">// 应用对齐（左/中/右对齐）</span><br>    <span class="hljs-built_in">JustifyLayout</span>();<br>    <br>    <span class="hljs-comment">// 应用边距</span><br>    <span class="hljs-built_in">MarginLayout</span>();<br>    <br>    <span class="hljs-comment">// 结束布局</span><br>    <span class="hljs-built_in">EndLayout</span>();<br>    <br>    <span class="hljs-comment">// 清除脏标记</span><br>    DirtyFlags &amp;= ~ETextLayoutDirtyState::Layout;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="第5步：CreateLineViewBlocks"><a href="#第5步：CreateLineViewBlocks" class="headerlink" title="第5步：CreateLineViewBlocks()"></a>第5步：CreateLineViewBlocks()</h2><h3 id="第一次遍历计算行高"><a href="#第一次遍历计算行高" class="headerlink" title="第一次遍历计算行高"></a>第一次遍历计算行高</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// TextLayout.cpp 第334-338行</span><br><span class="hljs-comment">// 遍历行中的所有Run（文本、图片等）</span><br><span class="hljs-keyword">for</span> (每个Run)<br>&#123;<br>    <span class="hljs-comment">// 获取基线（负数，翻转符号）</span><br>    <span class="hljs-type">const</span> int16 Baseline = -(Run.<span class="hljs-built_in">GetBaseLine</span>(Scale));<br>    <br>    <span class="hljs-comment">// 计算基线以上的最大高度</span><br>    MaxAboveBaseline = FMath::<span class="hljs-built_in">Max</span>(<br>        MaxAboveBaseline,<br>        (int16)(Run.<span class="hljs-built_in">GetMaxHeight</span>(Scale) - Baseline)<br>    );<br>    <br>    <span class="hljs-comment">// 计算基线以下的最大高度</span><br>    MaxBelowBaseline = FMath::<span class="hljs-built_in">Max</span>(MaxBelowBaseline, Baseline);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="第二次遍历计算垂直位移"><a href="#第二次遍历计算垂直位移" class="headerlink" title="第二次遍历计算垂直位移"></a>第二次遍历计算垂直位移</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// TextLayout.cpp 第407-426行</span><br><span class="hljs-type">float</span> CurrentHorizontalPos = <span class="hljs-number">0.0f</span>;<br><br><span class="hljs-comment">// 【关键】计算行高</span><br><span class="hljs-type">const</span> <span class="hljs-type">float</span> UnscaleLineHeight = MaxAboveBaseline + MaxBelowBaseline;  <span class="hljs-comment">// 32 + 6 = 38px</span><br><br><span class="hljs-comment">// 遍历所有Block，设置位置</span><br><span class="hljs-keyword">for</span> (int32 Index = <span class="hljs-number">0</span>; Index &lt; OutSoftLine.<span class="hljs-built_in">Num</span>(); Index++)<br>&#123;<br>    <span class="hljs-type">const</span> TSharedRef&lt;ILayoutBlock&gt; Block = OutSoftLine[Index];<br>    <span class="hljs-type">const</span> TSharedRef&lt;IRun&gt; Run = Block-&gt;<span class="hljs-built_in">GetRun</span>();<br>    <br>    <span class="hljs-type">const</span> int16 BlockBaseline = Run-&gt;<span class="hljs-built_in">GetBaseLine</span>(Scale);<br>    <br>    <span class="hljs-comment">// ========================================</span><br>    <span class="hljs-comment">// 【核心计算】垂直偏移量</span><br>    <span class="hljs-comment">// ========================================</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0  <span class="hljs-comment">// 底部对齐（已禁用）</span></span><br>    <span class="hljs-type">const</span> int16 VerticalOffset = MaxAboveBaseline - Block-&gt;<span class="hljs-built_in">GetSize</span>().Y - BlockBaseline;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span>  <span class="hljs-comment">// 居中对齐（当前使用）</span></span><br>    <span class="hljs-type">const</span> int16 VerticalOffset = UnscaleLineHeight / <span class="hljs-number">2.0f</span> - Block-&gt;<span class="hljs-built_in">GetSize</span>().Y / <span class="hljs-number">2.0f</span>;<br>    <span class="hljs-comment">//                            ↑                         ↑</span><br>    <span class="hljs-comment">//                        行中心点                  Block中心点</span><br>    <span class="hljs-comment">//                        </span><br>    <span class="hljs-comment">//                        效果：Block中心 = 行中心</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <br>    <span class="hljs-comment">// 获取字距调整</span><br>    <span class="hljs-type">const</span> int8 BlockKerning = Run-&gt;<span class="hljs-built_in">GetKerning</span>(...);<br>    <br>    <span class="hljs-comment">// 【最终设置】Block的位置</span><br>    Block-&gt;<span class="hljs-built_in">SetLocationOffset</span>(<br>        <span class="hljs-built_in">FVector2D</span>(<br>            CurrentOffset.X + CurrentHorizontalPos + BlockKerning,  <span class="hljs-comment">// X坐标</span><br>            CurrentOffset.Y + VerticalOffset                        <span class="hljs-comment">// Y坐标（垂直居中）</span><br>        )<br>    );<br>    <br>    <span class="hljs-comment">// 累加水平位置</span><br>    CurrentHorizontalPos += Block-&gt;<span class="hljs-built_in">GetSize</span>().X;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="完整调用栈"><a href="#完整调用栈" class="headerlink" title="完整调用栈"></a>完整调用栈</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs txt">蓝图编辑器<br>    │<br>    │ 创建Widget<br>    ▼<br>URichTextBlock::RebuildWidget()<br>    │<br>    │ 创建Slate Widget<br>    ▼<br>SRichTextBlock 构造<br>    │<br>    │ 创建布局缓存<br>    ▼<br>FSlateTextBlockLayout 创建<br>    │<br>    │ 创建文本布局引擎<br>    ▼<br>FTextLayout 创建<br>    │<br>    │ 同步属性<br>    ▼<br>URichTextBlock::SynchronizeProperties()<br>    │<br>    │ 设置Justification等属性<br>    ▼<br>SRichTextBlock::SetJustification()<br>    │<br>    │<br>    │ ═══════════ 渲染帧开始 ═══════════<br>    │<br>    │ 每帧渲染<br>    ▼<br>SRichTextBlock::OnPaint()<br>    │<br>    │ 触发布局计算<br>    ▼<br>FSlateTextBlockLayout::OnPaint()<br>    │<br>    │ 检查是否需要更新布局<br>    ▼<br>FTextLayout::UpdateLayout()<br>    │<br>    ├─→ ClearView()<br>    ├─→ BeginLayout()<br>    │<br>    ├─→ FlowLayout()<br>    │       │<br>    │       ├─→ FlowLineLayout()  ← 处理每一行<br>    │       │       │<br>    │       │       └─→ CreateLineViewBlocks()  ← 【你看到的代码】<br>    │       │               │<br>    │       │               ├─ 第1次遍历：计算 MaxAboveBaseline, MaxBelowBaseline<br>    │       │               │<br>    │       │               ├─ 计算行高：UnscaleLineHeight = MaxAboveBaseline + MaxBelowBaseline<br>    │       │               │<br>    │       │               └─ 第2次遍历：计算每个Block的 VerticalOffset<br>    │       │                   │<br>    │       │                   └─ VerticalOffset = UnscaleLineHeight/2 - BlockHeight/2<br>    │       │<br>    │       └─→ 创建 LineView（包含所有Block的位置信息）<br>    │<br>    ├─→ JustifyLayout()  ← 水平对齐（左/中/右）<br>    ├─→ MarginLayout()   ← 应用边距<br>    │<br>    └─→ EndLayout()<br>    │<br>    │ 布局完成，绘制到屏幕<br>    ▼<br>实际渲染<br></code></pre></td></tr></table></figure>





<h1 id="如何在蓝图绑定事件"><a href="#如何在蓝图绑定事件" class="headerlink" title="如何在蓝图绑定事件"></a>如何在蓝图绑定事件</h1><p>点一下添加关键帧，然后右键属性搞一下</p>
<h1 id="使用手柄A键切换输入设备会使列表捕获鼠标导致手柄卡死操作不了"><a href="#使用手柄A键切换输入设备会使列表捕获鼠标导致手柄卡死操作不了" class="headerlink" title="使用手柄A键切换输入设备会使列表捕获鼠标导致手柄卡死操作不了"></a>使用手柄A键切换输入设备会使列表捕获鼠标导致手柄卡死操作不了</h1><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">FAnalogCursor::HandleKeyUpEvent</span><span class="hljs-params">(FSlateApplication&amp; SlateApp, <span class="hljs-type">const</span> FKeyEvent&amp; InKeyEvent)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IsRelevantInput</span>(InKeyEvent))<br>    &#123;<br>        FKey Key = InKeyEvent.<span class="hljs-built_in">GetKey</span>();<br><br>        <span class="hljs-comment">// Consume the sticks input so it doesn&#x27;t effect other things</span><br>        <span class="hljs-keyword">if</span> (Key == EKeys::Gamepad_LeftStick_Right ||<br>            Key == EKeys::Gamepad_LeftStick_Left ||<br>            Key == EKeys::Gamepad_LeftStick_Up ||<br>            Key == EKeys::Gamepad_LeftStick_Down)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// Bottom face button is a click</span><br>        <span class="hljs-keyword">if</span> (Key == EKeys::Virtual_Accept &amp;&amp; !InKeyEvent.<span class="hljs-built_in">IsRepeat</span>())<br>        &#123;<br>            <span class="hljs-keyword">if</span> (TSharedPtr&lt;FSlateUser&gt; SlateUser = SlateApp.<span class="hljs-built_in">GetUser</span>(InKeyEvent))<br>            &#123;<br>                FVector2D CurrentPosition = SlateUser-&gt;<span class="hljs-built_in">GetCursorPosition</span>();<br>                <span class="hljs-keyword">if</span> (CurrentPosition.X &lt; <span class="hljs-number">0.01f</span> &amp;&amp; CurrentPosition.Y &lt; <span class="hljs-number">0.01f</span>)<br>                &#123;<br>                    <span class="hljs-type">const</span> TSharedPtr&lt;SWindow&gt; ParentWindow = FSlateApplication::<span class="hljs-built_in">Get</span>().<span class="hljs-built_in">GetActiveTopLevelWindow</span>();<br>                    <span class="hljs-keyword">if</span> (ParentWindow.<span class="hljs-built_in">IsValid</span>())<br>                    &#123;<br>                        FVector2D WindowPosition = ParentWindow-&gt;<span class="hljs-built_in">GetPositionInScreen</span>();<br>                        FVector2D WindowSize     = ParentWindow-&gt;<span class="hljs-built_in">GetSizeInScreen</span>();<br>                        CurrentPosition.X        = WindowPosition.X + WindowSize.X * <span class="hljs-number">0.5</span>;<br>                        CurrentPosition.Y        = WindowPosition.Y + WindowSize.Y * <span class="hljs-number">0.5</span>;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-type">const</span> <span class="hljs-type">bool</span> bIsPrimaryUser = FSlateApplication::CursorUserIndex == SlateUser-&gt;<span class="hljs-built_in">GetUserIndex</span>();<br><br>                TSet&lt;FKey&gt; EmptySet;<br>                <span class="hljs-function">FPointerEvent <span class="hljs-title">MouseEvent</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">                    SlateUser-&gt;GetUserIndex(),</span></span><br><span class="hljs-params"><span class="hljs-function">                    FSlateApplication::CursorPointerIndex,</span></span><br><span class="hljs-params"><span class="hljs-function">                    CurrentPosition,</span></span><br><span class="hljs-params"><span class="hljs-function">                    SlateUser-&gt;GetPreviousCursorPosition(),</span></span><br><span class="hljs-params"><span class="hljs-function">                    bIsPrimaryUser ? SlateApp.GetPressedMouseButtons() : EmptySet,</span></span><br><span class="hljs-params"><span class="hljs-function">                    EKeys::LeftMouseButton,</span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-number">0</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                    bIsPrimaryUser ? SlateApp.GetModifierKeys() : FModifierKeysState())</span></span>;<br><br>                <span class="hljs-keyword">return</span> SlateApp.<span class="hljs-built_in">ProcessMouseButtonUpEvent</span>(MouseEvent);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个</p>
<p>联机GM</p>
<p>gm succquestchain 100208</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%B8%B8%E6%88%8F%E6%9D%82%E8%B4%A7%E9%93%BA/" class="category-chain-item">游戏杂货铺</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>二重螺旋工作记录</div>
      <div>https://rorschachandbat.github.io/游戏杂货铺/二重螺旋工作记录/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>R</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年11月3日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/%E6%B8%B8%E6%88%8F%E6%9D%82%E8%B4%A7%E9%93%BA/%E8%99%9A%E5%B9%BB%E5%BC%95%E6%93%8EUI%E7%9A%84%E5%88%B6%E4%BD%9C%E4%B8%8E%E4%BC%98%E5%8C%96/" title="虚幻引擎UI的制作与优化">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">虚幻引擎UI的制作与优化</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/%E9%9A%8F%E7%AC%94/2024%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" title="2024年度总结">
                        <span class="hidden-mobile">2024年度总结</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="waline"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#waline', function() {
      Fluid.utils.createCssLink('https://lib.baomitu.com/waline/2.14.1/waline.min.css')
      Fluid.utils.createScript('https://lib.baomitu.com/waline/2.14.1/waline.min.js', function() {
        var options = Object.assign(
          {"serverURL":"https://comment.rorschachblog.cn/","path":"window.location.pathname","meta":["nick","mail","link"],"requiredMeta":["nick"],"lang":"zh-CN","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],"dark":"html[data-user-color-scheme=\"dark\"]","wordLimit":0,"pageSize":10},
          {
            el: '#waline',
            path: window.location.pathname
          }
        )
        Waline.init(options);
        Fluid.utils.waitElementVisible('#waline .vcontent', () => {
          var imgSelector = '#waline .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>

 
    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
